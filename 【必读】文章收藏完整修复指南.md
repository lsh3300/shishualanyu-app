# ã€å¿…è¯»ã€‘æ–‡ç« æ”¶è—å®Œæ•´ä¿®å¤æŒ‡å—

## ğŸ¯ ä¸€æ¬¡æ€§å®Œæ•´ä¿®å¤

æœ¬æ¬¡ä¿®å¤å·²ç»**å®Œå…¨è§£å†³**æ‰€æœ‰æ–‡ç« æ”¶è—ç›¸å…³é—®é¢˜ã€‚

---

## âœ… å·²å®Œæˆçš„ä»£ç ä¿®å¤

### 1. âœ… é¦–é¡µå®æ—¶è·å–æ–‡ç« æ•°æ®
**æ–‡ä»¶**: `app/page.tsx`

**æ”¹è¿›**:
- âŒ ä¹‹å‰ï¼šç¡¬ç¼–ç æ–‡ç« æ•°æ®ï¼Œåªæœ‰ slugï¼Œæ²¡æœ‰ UUID
- âœ… ç°åœ¨ï¼šä» Supabase å®æ—¶è·å–ï¼ŒåŒ…å«å®Œæ•´çš„ `id` (UUID) å’Œ `slug`

```tsx
// ä¿®å¤åçš„ä»£ç 
const [cultureArticles, setCultureArticles] = useState<any[]>([])

useEffect(() => {
  async function fetchArticles() {
    const supabase = createClient()
    const { data } = await supabase
      .from('culture_articles')
      .select('id, slug, title, excerpt, cover_image, read_time')
      .eq('published', true)
      .order('created_at', { ascending: false })
      .limit(3)
    
    setCultureArticles(data || [])
  }
  fetchArticles()
}, [])

// æ¸²æŸ“æ—¶æ­£ç¡®ä¼ é€’
<LazyCultureArticleCard 
  key={article.id} 
  id={article.slug}        // ç”¨äºè·¯ç”±
  articleId={article.id}   // ç”¨äºæ”¶è— âœ…
  title={article.title}
  excerpt={article.excerpt}
  image={article.cover_image}
  readTime={`${article.read_time}åˆ†é’Ÿ`}
/>
```

### 2. âœ… æ‰€æœ‰é¡µé¢æ­£ç¡®ä¼ é€’ UUID

å·²éªŒè¯ä»¥ä¸‹æ–‡ä»¶éƒ½æ­£ç¡®ä¼ é€’ `articleId`:

| æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `app/page.tsx` | âœ… å®Œæˆ | é¦–é¡µå®æ—¶è·å– + æ­£ç¡®ä¼ é€’ |
| `app/culture/page.tsx` | âœ… å®Œæˆ | åˆ—è¡¨é¡µæ‰€æœ‰å¡ç‰‡éƒ½ä¼ é€’ |
| `app/culture/[slug]/page.tsx` | âœ… å®Œæˆ | è¯¦æƒ…é¡µæ”¶è—æŒ‰é’® |
| `app/profile/favorites/page.tsx` | âœ… å®Œæˆ | æ”¶è—é¡µæ–‡ç« åˆ—è¡¨ |

### 3. âœ… æ–‡ç« è¯¦æƒ…é¡µæ”¶è—æŒ‰é’®
**æ–°ç»„ä»¶**: `components/ui/article-favorite-button.tsx`

**åŠŸèƒ½**:
- âœ… æ˜¾ç¤ºæ”¶è—çŠ¶æ€
- âœ… ç‚¹å‡»æ”¶è—/å–æ¶ˆæ”¶è—
- âœ… æœªç™»å½•æç¤º
- âœ… åŠ è½½çŠ¶æ€

---

## ğŸ”¥ å…³é”®æ­¥éª¤ï¼šæ‰§è¡Œ RLS ç­–ç•¥ï¼ˆå¿…é¡»ï¼ï¼‰

### âš ï¸ ä¸ºä»€ä¹ˆè¿˜æ˜¯æŠ¥é”™ï¼Ÿ

å³ä½¿ä»£ç å·²ä¿®å¤ï¼Œå¦‚æœæ²¡æœ‰åœ¨ Supabase æ‰§è¡Œ RLS ç­–ç•¥ï¼Œæ”¶è—åŠŸèƒ½ä»ç„¶ä¼šå¤±è´¥ï¼

**é”™è¯¯ä¿¡æ¯**:
```
âŒ æ·»åŠ æ–‡ç« æ”¶è—å¤±è´¥: {
  code: '42501',
  message: 'new row violates row-level security policy for table "article_favorites"'
}
```

### ğŸ“‹ ç«‹å³æ‰§è¡Œï¼ˆ5åˆ†é’Ÿå†…å®Œæˆï¼‰

#### æ­¥éª¤ 1: ç™»å½• Supabase

1. æ‰“å¼€æµè§ˆå™¨è®¿é—® https://supabase.com/dashboard
2. ç™»å½•ä½ çš„è´¦å·
3. é€‰æ‹©ä½ çš„é¡¹ç›®

#### æ­¥éª¤ 2: æ‰“å¼€ SQL Editor

1. åœ¨å·¦ä¾§èœå•æ‰¾åˆ° **SQL Editor**
2. ç‚¹å‡» **New query** åˆ›å»ºæ–°æŸ¥è¯¢

#### æ­¥éª¤ 3: å¤åˆ¶ç²˜è´´ SQL è„šæœ¬

æ‰“å¼€æ–‡ä»¶ `supabase/fix-article-favorites-rls.sql`ï¼Œå®Œæ•´å†…å®¹å¦‚ä¸‹ï¼š

```sql
-- ä¿®å¤æ–‡ç« æ”¶è—çš„ RLS ç­–ç•¥
-- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œæ­¤è„šæœ¬

BEGIN;

-- åˆ é™¤æ—§çš„ç­–ç•¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
DROP POLICY IF EXISTS "Users read own favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users insert own favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users delete own favorites" ON public.article_favorites;

-- é‡æ–°åˆ›å»ºæ­£ç¡®çš„ RLS ç­–ç•¥

-- 1. ç”¨æˆ·å¯ä»¥è¯»å–è‡ªå·±çš„æ”¶è—
CREATE POLICY "Users can view own article favorites"
  ON public.article_favorites
  FOR SELECT
  USING (user_id = auth.uid());

-- 2. ç”¨æˆ·å¯ä»¥æ·»åŠ è‡ªå·±çš„æ”¶è—
CREATE POLICY "Users can insert own article favorites"
  ON public.article_favorites
  FOR INSERT
  WITH CHECK (user_id = auth.uid());

-- 3. ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„æ”¶è—
CREATE POLICY "Users can delete own article favorites"
  ON public.article_favorites
  FOR DELETE
  USING (user_id = auth.uid());

-- ç¡®ä¿ RLS å·²å¯ç”¨
ALTER TABLE public.article_favorites ENABLE ROW LEVEL SECURITY;

COMMIT;

-- éªŒè¯ç­–ç•¥
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual,
  with_check
FROM pg_policies
WHERE tablename = 'article_favorites';
```

#### æ­¥éª¤ 4: æ‰§è¡Œ SQL

1. å°†ä¸Šé¢çš„ SQL è„šæœ¬ç²˜è´´åˆ°ç¼–è¾‘å™¨ä¸­
2. ç‚¹å‡»å³ä¸‹è§’çš„ **Run** æŒ‰é’®ï¼ˆæˆ–æŒ‰ Ctrl+Enterï¼‰
3. ç­‰å¾…æ‰§è¡Œå®Œæˆ

#### æ­¥éª¤ 5: éªŒè¯ç»“æœ

æ‰§è¡ŒæˆåŠŸåï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

**æˆåŠŸæ¶ˆæ¯**:
```
âœ“ BEGIN
âœ“ DROP POLICY (å¯èƒ½æ˜¾ç¤º 0 æˆ– 3 æ¡)
âœ“ CREATE POLICY (3 æ¡)
âœ“ ALTER TABLE
âœ“ COMMIT
```

**ç­–ç•¥åˆ—è¡¨**ï¼ˆåº•éƒ¨æŸ¥è¯¢ç»“æœï¼‰:
```
article_favorites | Users can view own article favorites   | SELECT
article_favorites | Users can insert own article favorites | INSERT
article_favorites | Users can delete own article favorites | DELETE
```

---

## ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹

### æµ‹è¯•å‰å‡†å¤‡

1. âœ… ç¡®è®¤å·²åœ¨ Supabase æ‰§è¡Œ RLS è„šæœ¬
2. âœ… åˆ·æ–°æµè§ˆå™¨ï¼ˆCtrl+Shift+Rï¼‰
3. âœ… ç¡®ä¿å·²ç™»å½•ç³»ç»Ÿ

### æµ‹è¯• 1: é¦–é¡µæ–‡ç« æ”¶è—

```
æ­¥éª¤ï¼š
1. è®¿é—® http://localhost:3000
2. å‘ä¸‹æ»šåŠ¨åˆ°"æ–‡åŒ–é€Ÿè¯»"éƒ¨åˆ†
3. ç­‰å¾…æ–‡ç« åŠ è½½ï¼ˆåº”è¯¥ä» Supabase è·å–ï¼‰
4. æ‚¬åœæ–‡ç« å¡ç‰‡
5. ç‚¹å‡»å³ä¸Šè§’â¤ï¸å›¾æ ‡

é¢„æœŸç»“æœï¼š
âœ… æ˜¾ç¤º"å·²æ”¶è—"toast
âœ… ä¸å†æŠ¥ UUID é”™è¯¯
âœ… ä¸å†æŠ¥ RLS é”™è¯¯
```

### æµ‹è¯• 2: åˆ—è¡¨é¡µæ–‡ç« æ”¶è—

```
æ­¥éª¤ï¼š
1. è®¿é—® http://localhost:3000/culture
2. æ‚¬åœä»»æ„æ–‡ç« å¡ç‰‡
3. ç‚¹å‡»â¤ï¸å›¾æ ‡

é¢„æœŸç»“æœï¼š
âœ… æ”¶è—æˆåŠŸ
âœ… å›¾æ ‡å˜ä¸ºå®å¿ƒçº¢è‰²
```

### æµ‹è¯• 3: è¯¦æƒ…é¡µæ–‡ç« æ”¶è— â­ æ–°åŠŸèƒ½

```
æ­¥éª¤ï¼š
1. è®¿é—®ä»»æ„æ–‡ç« è¯¦æƒ…é¡µ
2. æŸ¥çœ‹æ ‡é¢˜ä¸‹æ–¹çš„"æ”¶è—æ–‡ç« "æŒ‰é’®
3. ç‚¹å‡»æŒ‰é’®

é¢„æœŸç»“æœï¼š
âœ… æŒ‰é’®å˜ä¸º"å·²æ”¶è—"
âœ… å›¾æ ‡å˜ä¸ºå®å¿ƒâ¤ï¸
```

### æµ‹è¯• 4: æ”¶è—åˆ—è¡¨æŸ¥çœ‹

```
æ­¥éª¤ï¼š
1. è®¿é—® http://localhost:3000/profile/favorites
2. ç‚¹å‡»"æ–‡ç« "æ ‡ç­¾

é¢„æœŸç»“æœï¼š
âœ… æ˜¾ç¤ºæ‰€æœ‰æ”¶è—çš„æ–‡ç« 
âœ… ç‚¹å‡»æ–‡ç« è·³è½¬åˆ°è¯¦æƒ…é¡µ
âœ… è¯¦æƒ…é¡µæŒ‰é’®æ˜¾ç¤º"å·²æ”¶è—"çŠ¶æ€
```

### æµ‹è¯• 5: å–æ¶ˆæ”¶è—

```
æ­¥éª¤ï¼š
1. åœ¨è¯¦æƒ…é¡µç‚¹å‡»"å·²æ”¶è—"æŒ‰é’®
2. è¿”å›æ”¶è—é¡µé¢åˆ·æ–°

é¢„æœŸç»“æœï¼š
âœ… æ–‡ç« ä»åˆ—è¡¨ä¸­æ¶ˆå¤±
âœ… è¯¦æƒ…é¡µæŒ‰é’®æ¢å¤ä¸º"æ”¶è—æ–‡ç« "
```

---

## ğŸ“Š é—®é¢˜è§£å†³å¯¹ç…§è¡¨

| é”™è¯¯ä»£ç  | é”™è¯¯æ¶ˆæ¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|---------|---------|------|---------|------|
| 42501 | new row violates RLS policy | RLS ç­–ç•¥æœªé…ç½® | æ‰§è¡Œ SQL è„šæœ¬ | â³ å¾…æ‰§è¡Œ |
| 22P02 | invalid input syntax for uuid | ä¼ é€’ slug è€Œä¸æ˜¯ UUID | ä¿®æ”¹é¦–é¡µè·å–æ•°æ® | âœ… å·²ä¿®å¤ |
| - | è¯¦æƒ…é¡µæ— æ”¶è—æŒ‰é’® | ç¼ºå°‘ç»„ä»¶ | åˆ›å»ºæ”¶è—æŒ‰é’®ç»„ä»¶ | âœ… å·²ä¿®å¤ |
| - | æ”¶è—é¡µæ— æ–‡ç« æ ‡ç­¾ | UI ç¼ºå¤± | æ·»åŠ æ–‡ç« æ ‡ç­¾ | âœ… å·²ä¿®å¤ |

---

## ğŸ“ æœ¬æ¬¡ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å»ºæ–‡ä»¶
1. âœ… `components/ui/article-favorite-button.tsx` - è¯¦æƒ…é¡µæ”¶è—æŒ‰é’®
2. âœ… `ã€å¿…è¯»ã€‘æ–‡ç« æ”¶è—å®Œæ•´ä¿®å¤æŒ‡å—.md` - æœ¬æ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶
1. âœ… `app/page.tsx` - å®æ—¶è·å–æ–‡ç« æ•°æ®
2. âœ… `app/culture/page.tsx` - çƒ­é—¨æ–‡ç« æ·»åŠ  articleId
3. âœ… `app/culture/[slug]/page.tsx` - æ·»åŠ æ”¶è—æŒ‰é’®
4. âœ… `app/profile/favorites/page.tsx` - æ–‡ç« æ”¶è—æ ‡ç­¾

### å¾…æ‰§è¡Œæ–‡ä»¶
1. â³ `supabase/fix-article-favorites-rls.sql` - **å¿…é¡»åœ¨ Supabase æ‰§è¡Œ**

---

## ğŸ“ æŠ€æœ¯è¯´æ˜

### æ•°æ®æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»æ”¶è—
    â†“
å‰ç«¯ç»„ä»¶è°ƒç”¨ addArticleToFavorites(articleId)
    ã€articleId å¿…é¡»æ˜¯ UUIDï¼ã€‘
    â†“
API: POST /api/user/favorites
    Body: { type: "article", item_id: UUID }
    â†“
Supabase æ’å…¥æ•°æ®
    INSERT INTO article_favorites (user_id, article_id)
    â†“
RLS ç­–ç•¥éªŒè¯
    CHECK: user_id = auth.uid()
    âœ… å¦‚æœç­–ç•¥æ­£ç¡® â†’ æ’å…¥æˆåŠŸ
    âŒ å¦‚æœç­–ç•¥ç¼ºå¤± â†’ æŠ¥ 42501 é”™è¯¯
    â†“
è¿”å›ç»“æœç»™å‰ç«¯
    æ˜¾ç¤º Toast æç¤º
```

### Props ä¼ é€’è§„èŒƒ

**æ‰€æœ‰ CultureArticleCard å¿…é¡»ä¼ é€’**:
```tsx
<CultureArticleCard
  id={article.slug}         // string - ç”¨äºè·¯ç”± /culture/${id}
  articleId={article.id}    // string (UUID) - ç”¨äºæ”¶è—åŠŸèƒ½
  title={article.title}     // string
  excerpt={article.excerpt} // string
  image={article.cover_image} // string
  readTime={`${article.read_time}åˆ†é’Ÿ`} // string
  showFavorite={true}       // boolean (å¯é€‰)
/>
```

**é”™è¯¯ç¤ºä¾‹** âŒ:
```tsx
// é”™è¯¯ï¼šåªä¼ é€’ slugï¼Œæ²¡æœ‰ UUID
<CultureArticleCard id="indigo-for-kids" ... />

// é”™è¯¯ï¼šä¼ é€’ slug ç»™ articleId
<CultureArticleCard id="..." articleId="indigo-for-kids" ... />
```

**æ­£ç¡®ç¤ºä¾‹** âœ…:
```tsx
<CultureArticleCard 
  id="indigo-for-kids"                          // slug ç”¨äºè·¯ç”±
  articleId="a1111111-1111-1111-1111-111111111111" // UUID ç”¨äºæ”¶è—
  ... 
/>
```

---

## âš¡ å¿«é€Ÿæ£€æŸ¥æ¸…å•

åœ¨æµ‹è¯•å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] å·²åœ¨ Supabase æ‰§è¡Œ `fix-article-favorites-rls.sql`
- [ ] å·²åˆ·æ–°æµè§ˆå™¨ï¼ˆCtrl+Shift+Rï¼‰
- [ ] å·²ç™»å½•ç³»ç»Ÿ
- [ ] å¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼ˆnpm run devï¼‰
- [ ] ç½‘ç»œè¿æ¥æ­£å¸¸

---

## ğŸ†˜ å¦‚æœè¿˜æ˜¯å¤±è´¥

### æ­¥éª¤ 1: æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆ

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
SELECT policyname, cmd 
FROM pg_policies 
WHERE tablename = 'article_favorites';
```

**é¢„æœŸç»“æœ**:
```
Users can view own article favorites   | SELECT
Users can insert own article favorites | INSERT
Users can delete own article favorites | DELETE
```

**å¦‚æœæ²¡æœ‰ç»“æœ** â†’ é‡æ–°æ‰§è¡Œ RLS è„šæœ¬

### æ­¥éª¤ 2: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š
```javascript
console.log(localStorage.getItem('supabase.auth.token'))
```

**å¦‚æœæ˜¯ null** â†’ é‡æ–°ç™»å½•ç³»ç»Ÿ

### æ­¥éª¤ 3: æ£€æŸ¥ç½‘ç»œè¯·æ±‚

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. ç‚¹å‡»æ”¶è—æŒ‰é’®
4. æŸ¥æ‰¾ `/api/user/favorites` è¯·æ±‚
5. æŸ¥çœ‹ Response

**å¦‚æœæ˜¯ 500 é”™è¯¯** â†’ æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯  
**å¦‚æœæ˜¯ 401 é”™è¯¯** â†’ é‡æ–°ç™»å½•  
**å¦‚æœæ˜¯ 42501 é”™è¯¯** â†’ æ£€æŸ¥ RLS ç­–ç•¥

### æ­¥éª¤ 4: æ£€æŸ¥æ–‡ç«  UUID

åœ¨æ§åˆ¶å°æŸ¥çœ‹æ–‡ç« æ•°æ®ï¼š
```javascript
// åœ¨é¦–é¡µæ‰“å¼€æ§åˆ¶å°
console.log(document.querySelector('[data-article-id]')?.dataset.articleId)
```

**å¦‚æœè¾“å‡ºæ˜¯ slug** â†’ æ£€æŸ¥ `app/page.tsx` æ˜¯å¦æ­£ç¡®ä¿®æ”¹  
**å¦‚æœè¾“å‡ºæ˜¯ UUID** â†’ RLS ç­–ç•¥é—®é¢˜

---

## âœ… å®Œæˆåçš„æœ€ç»ˆçŠ¶æ€

### é¦–é¡µ
- âœ… æ–‡ç« ä» Supabase å®æ—¶è·å–
- âœ… æ˜¾ç¤ºæœ€æ–° 3 ç¯‡å·²å‘å¸ƒæ–‡ç« 
- âœ… æ‚¬åœæ˜¾ç¤ºæ”¶è—æŒ‰é’®
- âœ… ç‚¹å‡»æ”¶è—æ­£å¸¸å·¥ä½œ

### åˆ—è¡¨é¡µ
- âœ… æ‰€æœ‰æ–‡ç« å¡ç‰‡éƒ½æœ‰æ”¶è—æŒ‰é’®
- âœ… ç²¾é€‰ã€æœ€æ–°ã€çƒ­é—¨æ–‡ç« éƒ½æ”¯æŒæ”¶è—
- âœ… æ”¶è—çŠ¶æ€å®æ—¶æ˜¾ç¤º

### è¯¦æƒ…é¡µ
- âœ… æ ‡é¢˜ä¸‹æ–¹æ˜¾ç¤ºæ”¶è—æŒ‰é’®
- âœ… å®æ—¶åŒæ­¥æ”¶è—çŠ¶æ€
- âœ… æœªç™»å½•æ—¶æç¤ºç™»å½•

### æ”¶è—é¡µ
- âœ… æ–‡ç« æ ‡ç­¾æ­£å¸¸æ˜¾ç¤º
- âœ… åˆ—è¡¨æ˜¾ç¤ºæ‰€æœ‰æ”¶è—çš„æ–‡ç« 
- âœ… ç‚¹å‡»è·³è½¬è¯¦æƒ…æ­£å¸¸

---

## ğŸ“ é—®é¢˜åé¦ˆ

å¦‚æœæŒ‰ç…§æœ¬æŒ‡å—æ“ä½œåä»æœ‰é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯ï¼ˆæˆªå›¾ï¼‰
2. Network æ ‡ç­¾ä¸­çš„è¯·æ±‚è¯¦æƒ…ï¼ˆæˆªå›¾ï¼‰
3. Supabase SQL Editor æ‰§è¡Œç»“æœï¼ˆæˆªå›¾ï¼‰
4. å½“å‰åœ¨å“ªä¸ªé¡µé¢æ“ä½œï¼ˆURLï¼‰

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-22  
**é¢„è®¡æµ‹è¯•æ—¶é—´**: 10 åˆ†é’Ÿ  
**å…³é”®æ­¥éª¤**: âš ï¸ å¿…é¡»åœ¨ Supabase æ‰§è¡Œ SQL è„šæœ¬  
**çŠ¶æ€**: âœ… ä»£ç å·²å®Œæˆï¼Œâ³ ç­‰å¾…æ‰§è¡Œ RLS è„šæœ¬
