# è¯¾ç¨‹æ”¶è—å¤±è´¥ä¿®å¤æŒ‡å—

## é—®é¢˜æè¿°

ç”¨æˆ·åœ¨æ”¶è—è¯¾ç¨‹æ—¶é‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

```
âŒ æ·»åŠ æ”¶è—å¤±è´¥: {
  code: '23503',
  details: 'Key is not present in table "courses".',
  hint: null,
  message: 'insert or update on table "favorites" violates foreign key constraint "favorites_course_id_fkey"'
}
```

**é”™è¯¯åŸå› **ï¼š
- ç”¨æˆ·è¯•å›¾æ”¶è—çš„è¯¾ç¨‹ ID `00000000-0000-0000-0000-000000000001` ä¸å­˜åœ¨äº `courses` è¡¨ä¸­
- å¤–é”®çº¦æŸ `favorites_course_id_fkey` è¦æ±‚ `course_id` å¿…é¡»åœ¨ `courses` è¡¨ä¸­å­˜åœ¨
- æ•°æ®åº“ç¼ºå°‘å¿…è¦çš„è¯¾ç¨‹æ•°æ®

---

## è§£å†³æ–¹æ¡ˆ

### æ­¥éª¤ 1: æ‰§è¡Œè¯¾ç¨‹æ•°æ®ä¿®å¤è„šæœ¬ â­

1. ç™»å½• [Supabase Dashboard](https://supabase.com/dashboard)
2. é€‰æ‹©ä½ çš„é¡¹ç›®
3. è¿›å…¥ **SQL Editor**
4. ç‚¹å‡» **New query**
5. å¤åˆ¶å¹¶ç²˜è´´ `supabase/fix-courses-seed.sql` çš„å†…å®¹
6. ç‚¹å‡» **Run** æ‰§è¡Œè„šæœ¬

**è„šæœ¬åŠŸèƒ½**ï¼š
- âœ… æ·»åŠ ç¼ºå¤±çš„å­—æ®µï¼ˆ`instructor_name`, `thumbnail`, `difficulty` ç­‰ï¼‰
- âœ… æ’å…¥ 8 é—¨æ ‡å‡†è¯¾ç¨‹æ•°æ®
- âœ… ä½¿ç”¨ `ON CONFLICT` ç¡®ä¿å¹‚ç­‰æ€§ï¼ˆå¯é‡å¤æ‰§è¡Œï¼‰
- âœ… è‡ªåŠ¨éªŒè¯æ’å…¥çš„æ•°æ®

**é¢„æœŸç»“æœ**ï¼š
```
âœ“ 8 rows affected
```

---

### æ­¥éª¤ 2: éªŒè¯è¯¾ç¨‹æ•°æ®

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
-- æ£€æŸ¥è¯¾ç¨‹æ€»æ•°
SELECT COUNT(*) as total_courses FROM courses;
-- åº”è¯¥è¿”å›è‡³å°‘ 8

-- æ£€æŸ¥å…·ä½“è¯¾ç¨‹
SELECT id, title, instructor_name, category, status
FROM courses
WHERE id IN (
  '00000000-0000-0000-0000-000000000001',
  '00000000-0000-0000-0000-000000000002',
  '00000000-0000-0000-0000-000000000003',
  '00000000-0000-0000-0000-000000000004',
  '00000000-0000-0000-0000-000000000005',
  '00000000-0000-0000-0000-000000000006',
  '00000000-0000-0000-0000-000000000007',
  '00000000-0000-0000-0000-000000000008'
)
ORDER BY id;
-- åº”è¯¥è¿”å› 8 é—¨è¯¾ç¨‹
```

---

### æ­¥éª¤ 3: æµ‹è¯•æ”¶è—åŠŸèƒ½

1. è®¿é—® `http://localhost:3000/teaching`
2. æ‰¾åˆ°ä»»æ„è¯¾ç¨‹å¡ç‰‡
3. ç‚¹å‡»å³ä¸Šè§’çš„"æ”¶è—"æŒ‰é’®ï¼ˆå¿ƒå½¢å›¾æ ‡ï¼‰
4. âœ… åº”è¯¥æˆåŠŸæ”¶è—ï¼Œä¸å†æŠ¥é”™

---

## è¯¾ç¨‹åˆ—è¡¨

ä¿®å¤åï¼Œæ•°æ®åº“å°†åŒ…å«ä»¥ä¸‹ 8 é—¨è¯¾ç¨‹ï¼š

| ID | è¯¾ç¨‹åç§° | åˆ†ç±» | éš¾åº¦ | ä»·æ ¼ | å…è´¹ |
|----|---------|------|------|------|------|
| `...001` | ä¼ ç»Ÿæ‰æŸ“åŸºç¡€å…¥é—¨è¯¾ç¨‹ | æ‰æŸ“ | å…¥é—¨ | Â¥0 | âœ… |
| `...002` | æ‰æŸ“è¿›é˜¶æŠ€æ³•ä¸åˆ›ä½œ | æ‰æŸ“ | è¿›é˜¶ | Â¥168 | âŒ |
| `...003` | ç°ä»£æ‰æŸ“è‰ºæœ¯åˆ›ä½œ | æ‰æŸ“ | è¿›é˜¶ | Â¥198 | âŒ |
| `...004` | æ‰æŸ“å·¥è‰ºä¸å•†ä¸šåº”ç”¨ | æ‰æŸ“ | é«˜çº§ | Â¥128 | âŒ |
| `...005` | èœ¡æŸ“å·¥è‰ºåŸºç¡€å…¥é—¨ | èœ¡æŸ“ | å…¥é—¨ | Â¥199 | âŒ |
| `...006` | ä¼ ç»Ÿè‹—æ—èœ¡æŸ“æŠ€æ³• | èœ¡æŸ“ | è¿›é˜¶ | Â¥258 | âŒ |
| `...007` | èœ¡æŸ“çº¹æ ·è®¾è®¡ä¸åº”ç”¨ | èœ¡æŸ“ | è¿›é˜¶ | Â¥178 | âŒ |
| `...008` | èœ¡æŸ“ä¸æ‰æŸ“ç»“åˆåˆ›ä½œ | ç»¼åˆ | é«˜çº§ | Â¥238 | âŒ |

---

## æŠ€æœ¯è¯´æ˜

### å¤–é”®çº¦æŸ

`favorites` è¡¨æœ‰ä»¥ä¸‹å¤–é”®çº¦æŸï¼š

```sql
FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE
```

**å«ä¹‰**ï¼š
- `course_id` å¿…é¡»åœ¨ `courses` è¡¨ä¸­å­˜åœ¨
- å¦‚æœè¯¾ç¨‹è¢«åˆ é™¤ï¼Œç›¸å…³çš„æ”¶è—è®°å½•ä¹Ÿä¼šè¢«åˆ é™¤

### ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

1. **æ•°æ®åº“åˆå§‹åŒ–ä¸å®Œæ•´**ï¼š
   - åˆ›å»ºäº† `courses` è¡¨ç»“æ„
   - ä½†æ²¡æœ‰æ’å…¥è¯¾ç¨‹æ•°æ®

2. **å‰ç«¯ä½¿ç”¨äº†å›ºå®šçš„è¯¾ç¨‹ ID**ï¼š
   - ä»£ç ä¸­æœŸæœ›å­˜åœ¨ `00000000-0000-0000-0000-000000000001` ç­‰ ID
   - ä½†æ•°æ®åº“ä¸­æ²¡æœ‰è¿™äº›è®°å½•

3. **å¤–é”®çº¦æŸä¿æŠ¤æ•°æ®å®Œæ•´æ€§**ï¼š
   - æ•°æ®åº“æ­£ç¡®åœ°æ‹’ç»äº†æ— æ•ˆçš„æ”¶è—æ“ä½œ
   - è¿™æ˜¯å¥½äº‹ï¼Œé˜²æ­¢äº†è„æ•°æ®

---

## é¢„é˜²æªæ–½

### 1. ç¡®ä¿æ•°æ®åº“åˆå§‹åŒ–å®Œæ•´

åœ¨é¡¹ç›® README æˆ–éƒ¨ç½²æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜ï¼š

```markdown
## æ•°æ®åº“åˆå§‹åŒ–æ­¥éª¤

1. æ‰§è¡Œ `supabase/schemas.sql` - åˆ›å»ºè¡¨ç»“æ„
2. æ‰§è¡Œ `supabase/fix-courses-seed.sql` - æ’å…¥è¯¾ç¨‹æ•°æ®
3. æ‰§è¡Œ `supabase/add-culture-articles-part1.sql` - æ’å…¥æ–‡ç« æ•°æ®ï¼ˆPart 1ï¼‰
4. æ‰§è¡Œ `supabase/add-culture-articles-part2.sql` - æ’å…¥æ–‡ç« æ•°æ®ï¼ˆPart 2ï¼‰
```

### 2. ä½¿ç”¨æ›´å¥½çš„é”™è¯¯æç¤º

æ›´æ–°å‰ç«¯ä»£ç ï¼Œå½“æ”¶è—å¤±è´¥æ—¶æ˜¾ç¤ºæ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼š

```tsx
// components/ui/course-list-card.tsx
try {
  if (isFavorite) {
    await removeCourseFromFavorites(id)
  } else {
    await addCourseToFavorites(id)
  }
} catch (error) {
  console.error('æ”¶è—æ“ä½œå¤±è´¥:', error)
  
  // æ›´å‹å¥½çš„é”™è¯¯æç¤º
  const errorMessage = error instanceof Error 
    ? error.message 
    : "è¯¥è¯¾ç¨‹æš‚æ—¶æ— æ³•æ”¶è—ï¼Œè¯·ç¨åé‡è¯•"
  
  toast({
    title: "æ“ä½œå¤±è´¥",
    description: errorMessage,
    variant: "destructive"
  })
}
```

### 3. API å±‚é¢çš„éªŒè¯

åœ¨ `/api/user/favorites` ä¸­æ·»åŠ è¯¾ç¨‹å­˜åœ¨æ€§æ£€æŸ¥ï¼š

```typescript
// æ·»åŠ æ”¶è—å‰ï¼Œå…ˆæ£€æŸ¥è¯¾ç¨‹æ˜¯å¦å­˜åœ¨
const { data: course, error: courseError } = await supabase
  .from('courses')
  .select('id, title')
  .eq('id', course_id)
  .single()

if (courseError || !course) {
  return NextResponse.json(
    { error: 'è¯¾ç¨‹ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶' },
    { status: 404 }
  )
}

// ç„¶åå†æ·»åŠ åˆ°æ”¶è—
// ...
```

---

## å¸¸è§é—®é¢˜

### Q1: æ‰§è¡Œè„šæœ¬åè¿˜æ˜¯æŠ¥é”™æ€ä¹ˆåŠï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. è„šæœ¬æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Ÿ
   ```sql
   SELECT COUNT(*) FROM courses;
   ```

2. è¯¾ç¨‹ ID æ˜¯å¦æ­£ç¡®ï¼Ÿ
   ```sql
   SELECT * FROM courses WHERE id = '00000000-0000-0000-0000-000000000001';
   ```

3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶åˆ·æ–°é¡µé¢

---

### Q2: ä¸ºä»€ä¹ˆä½¿ç”¨ `00000000-...` è¿™æ ·çš„ IDï¼Ÿ

**A**: è¿™äº›æ˜¯**æµ‹è¯•/ç¤ºä¾‹æ•°æ®çš„å›ºå®š ID**ï¼š
- ä¾¿äºå¼€å‘å’Œæµ‹è¯•
- å‰ç«¯å¯ä»¥ä½¿ç”¨å›ºå®š ID è¿›è¡Œå¼€å‘
- ç”Ÿäº§ç¯å¢ƒå¯ä»¥æ›¿æ¢ä¸ºçœŸå®æ•°æ®

---

### Q3: å¦‚ä½•æ·»åŠ æ–°è¯¾ç¨‹ï¼Ÿ

**A**: åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
INSERT INTO courses (
  id,
  title,
  description,
  instructor,
  instructor_name,
  duration,
  price,
  image_url,
  thumbnail,
  category,
  difficulty,
  is_free,
  status
) VALUES (
  '00000000-0000-0000-0000-000000000009',  -- æ–°çš„ UUID
  'ä½ çš„è¯¾ç¨‹æ ‡é¢˜',
  'è¯¾ç¨‹æè¿°',
  'è®²å¸ˆå',
  'è®²å¸ˆå',
  120,  -- æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  99,   -- ä»·æ ¼
  '/your-image.jpg',
  '/your-image.jpg',
  'æ‰æŸ“',  -- åˆ†ç±»
  'å…¥é—¨',  -- éš¾åº¦
  false,   -- æ˜¯å¦å…è´¹
  'published'  -- çŠ¶æ€
);
```

---

## ç›¸å…³æ–‡ä»¶

- âœ… **ä¿®å¤è„šæœ¬**: `supabase/fix-courses-seed.sql`
- ğŸ“‹ **è¡¨ç»“æ„**: `supabase/schemas.sql` (ç¬¬ 51-64 è¡Œ)
- ğŸ”— **æ”¶è— API**: `app/api/user/favorites/route.ts`
- ğŸ¨ **è¯¾ç¨‹å¡ç‰‡**: `components/ui/course-list-card.tsx`
- ğŸ“± **æ•™å­¦é¡µé¢**: `app/teaching/page.tsx`

---

## æ€»ç»“

**é—®é¢˜æ ¹æº**ï¼šæ•°æ®åº“ç¼ºå°‘è¯¾ç¨‹æ•°æ®ï¼Œå¯¼è‡´å¤–é”®çº¦æŸå¤±è´¥

**è§£å†³æ–¹æ³•**ï¼šæ‰§è¡Œ `fix-courses-seed.sql` è„šæœ¬æ’å…¥å®Œæ•´çš„è¯¾ç¨‹æ•°æ®

**é¢„é˜²æªæ–½**ï¼š
1. âœ… å®Œå–„æ•°æ®åº“åˆå§‹åŒ–æ–‡æ¡£
2. âœ… æ·»åŠ å‰ç«¯é”™è¯¯æç¤º
3. âœ… API å±‚é¢éªŒè¯æ•°æ®å­˜åœ¨æ€§
4. âœ… ä½¿ç”¨å›ºå®š UUID è¿›è¡Œæµ‹è¯•

---

**å®Œæˆæ—¶é—´**: 2025-11-22  
**å½±å“åŠŸèƒ½**: è¯¾ç¨‹æ”¶è—  
**ä¿®å¤çŠ¶æ€**: âœ… å·²æä¾›å®Œæ•´è§£å†³æ–¹æ¡ˆ
