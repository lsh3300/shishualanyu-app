# 项目开发经验总结 - 错误排查与最佳实践指南

## 常见错误与解决方案

### 1. React Hooks 初始化顺序错误

**错误表现：**
- `ReferenceError: Cannot access 'functionName' before initialization`
- 在 `useEffect` 依赖数组中引用了定义在其下方的函数

**解决方案：**
- 将函数定义移至使用它的 `useEffect` 钩子之前
- 确保依赖数组中的所有变量和函数都在其使用之前定义
- 检查函数的依赖项，避免不必要的参数导致的循环依赖

**示例修复：**
```tsx
// 错误代码
useEffect(() => {
  loadData(); // 引用了下方定义的函数
}, []);

const loadData = () => {
  // 函数实现
};

// 修复后代码
const loadData = () => {
  // 函数实现
};

useEffect(() => {
  loadData(); // 现在在函数定义之后使用
}, []);
```

### 2. 服务器组件中使用浏览器 API

**错误表现：**
- `ReferenceError: window is not defined` 或 `ReferenceError: document is not defined`
- 在服务端渲染时出现运行时错误

**解决方案：**
- 对于需要访问浏览器 API 的组件，使用 `'use client'` 指令标记为客户端组件
- 使用条件检查确保只在浏览器环境中访问浏览器 API
- 优先使用 Next.js 提供的钩子如 `use-mobile.ts` 来检测设备类型

**示例修复：**
```tsx
'use client'; // 确保在客户端组件中

import { useEffect, useState } from 'react';

export function MyComponent() {
  const [windowWidth, setWindowWidth] = useState(0);
  
  useEffect(() => {
    const handleResize = () => {
      if (typeof window !== 'undefined') {
        setWindowWidth(window.innerWidth);
      }
    };
    
    handleResize();
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);
  
  return <div>Window width: {windowWidth}</div>;
}
```

### 3. 组件 props 类型定义不完整

**错误表现：**
- TypeScript 编译错误
- 运行时出现属性访问错误

**解决方案：**
- 为所有组件 props 创建明确的 `interface` 类型定义
- 避免使用 `any` 或 `unknown` 类型
- 为可选属性提供默认值

**示例修复：**
```tsx
interface ProductCardProps {
  id: string;
  name: string;
  price: number;
  description?: string;
  imageUrl?: string;
}

export function ProductCard({ id, name, price, description = '', imageUrl }: ProductCardProps) {
  // 组件实现
}
```

### 4. 全局状态管理不当

**错误表现：**
- 状态不同步问题
- 组件重新渲染过多
- 难以追踪状态变更

**解决方案：**
- 使用 React Context + useReducer 管理复杂的全局状态
- 避免在多个组件中重复定义相似的状态
- 将相关功能封装在自定义钩子中，如 `useGlobalState`

**示例修复：**
```tsx
// 使用自定义钩子管理全局状态
const [unreadMessages, setUnreadMessages] = useGlobalState('unreadMessages', 0);

// 在组件中使用
useEffect(() => {
  setUnreadMessages(count);
}, [count, setUnreadMessages]);
```

## 项目开发注意事项

### 1. Next.js 14 开发规范
- 所有路由必须置于 `app/` 目录，禁止使用 `pages/` 目录
- 动态路由严格遵循 `[id]/page.tsx` 模式
- 服务端组件 (SSR) 中禁用 `useState`/`useEffect` 等客户端 hooks
- 客户端组件需用 `'use client'` 显式声明

### 2. 代码组织与组件复用
- 所有 UI 组件必须存于 `components/ui/` 目录
- 使用 `CVA` 定义组件变体
- 动态类名必须用 `clsx` 合并
- 优先使用 Radix UI 组件库提供的现成组件

### 3. 数据获取规范
- 课程/产品数据必须通过 `async` 组件函数获取
- 涉及用户操作的 API 调用需在 `app/api/` 路由中实现
- API 响应类型必须通过 `fetch` 的 `as` 断言严格校验

### 4. 性能优化要点
- 使用 Next.js 图片优化组件（如 `optimized-image.tsx`）
- 实现懒加载（`lazy-load.tsx`）减少初始加载时间
- 避免不必要的重渲染，合理使用 React.memo 和 useCallback

### 5. 调试技巧
- 利用开发服务器（`npm run dev`）实时预览更改
- 使用浏览器开发工具监控组件渲染和状态变化
- 对于服务器错误，检查终端输出获取详细信息

## 推荐开发工作流

1. **任务规划**：明确需求，将复杂任务分解为小步骤
2. **代码编写**：遵循项目规范，确保代码质量
3. **本地测试**：使用开发服务器测试功能
4. **错误排查**：参考本指南常见错误部分进行排查
5. **代码审查**：检查是否遵循所有开发规范
6. **文档更新**：及时更新相关文档，记录新增的错误模式和解决方案

希望这份总结能帮助团队成员更快地解决开发中遇到的问题，提高项目开发效率！