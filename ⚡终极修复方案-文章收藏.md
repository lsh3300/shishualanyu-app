# âš¡ ç»ˆæä¿®å¤æ–¹æ¡ˆ - æ–‡ç« æ”¶è—

## ğŸ” é—®é¢˜åˆ†æ

**ç°è±¡**: è™½ç„¶RLSç­–ç•¥å·²åˆ›å»ºï¼Œä½†ä»æŠ¥é”™ï¼š
```
code: '42501',
message: 'new row violates row-level security policy'
```

**æ ¹æœ¬åŸå› **: Service roleç­–ç•¥å¯èƒ½é…ç½®ä¸å½“ï¼Œæˆ–è€…Supabaseçš„RLSæœºåˆ¶ä¸APIçš„è®¤è¯æ–¹å¼ä¸åŒ¹é…ã€‚

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼ˆä¸¤ä¸ªé€‰é¡¹ï¼‰

### æ–¹æ¡ˆAï¼šç¦ç”¨RLSï¼ˆæ¨èï¼Œæœ€ç®€å•ï¼‰â­

**åŸç†**: APIå±‚å·²ç»æœ‰å®Œæ•´çš„ç”¨æˆ·è®¤è¯ï¼ˆ`authenticateUser`ï¼‰ï¼Œä¸éœ€è¦æ•°æ®åº“å±‚å†åšRLSæ£€æŸ¥ã€‚

**ä¼˜åŠ¿**:
- âœ… ç®€å•ç›´æ¥ï¼Œ1åˆ†é’Ÿè§£å†³
- âœ… ä¸ç°æœ‰çš„äº§å“/è¯¾ç¨‹æ”¶è—æœºåˆ¶ä¸€è‡´
- âœ… APIå±‚å·²ä¿æŠ¤æ•°æ®å®‰å…¨

**æ‰§è¡Œæ­¥éª¤**:

1. **åœ¨ Supabase SQL Editor æ‰§è¡Œ**:

```sql
-- ç¦ç”¨ article_favorites çš„ RLS
BEGIN;

-- åˆ é™¤æ‰€æœ‰ç°æœ‰ç­–ç•¥
DROP POLICY IF EXISTS "Users read own favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users insert own favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users delete own favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users can view own article favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users can insert own article favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users can delete own article favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Service role can manage article favorites" ON public.article_favorites;

-- ç¦ç”¨ RLS
ALTER TABLE public.article_favorites DISABLE ROW LEVEL SECURITY;

COMMIT;

-- éªŒè¯
SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = 'article_favorites';
-- åº”è¯¥æ˜¾ç¤º rowsecurity = false
```

2. **åˆ·æ–°æµè§ˆå™¨æµ‹è¯•**
3. **å®Œæˆï¼**

---

### æ–¹æ¡ˆBï¼šæ£€æŸ¥å¹¶å¤åˆ¶favoritesè¡¨é…ç½®

**æ­¥éª¤1**: å…ˆæ£€æŸ¥ favorites è¡¨çš„é…ç½®ï¼ˆå®ƒèƒ½æ­£å¸¸å·¥ä½œï¼‰

```sql
-- åœ¨ Supabase SQL Editor æ‰§è¡Œ
SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = 'favorites';
SELECT * FROM pg_policies WHERE tablename = 'favorites';
```

**æ­¥éª¤2**: æ ¹æ®æ£€æŸ¥ç»“æœï¼Œå®Œå…¨å¤åˆ¶ favorites çš„ç­–ç•¥åˆ° article_favorites

---

## ğŸ¯ æ¨èæ‰§è¡Œæµç¨‹

### ç«‹å³æ‰§è¡Œæ–¹æ¡ˆAï¼ˆ3åˆ†é’Ÿï¼‰

1. **æ‰“å¼€ Supabase Dashboard**
   - https://supabase.com/dashboard
   - SQL Editor â†’ New query

2. **å¤åˆ¶ç²˜è´´ä¸‹é¢çš„SQL**:
```sql
BEGIN;

DROP POLICY IF EXISTS "Users read own favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users insert own favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users delete own favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users can view own article favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users can insert own article favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users can delete own article favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Service role can manage article favorites" ON public.article_favorites;

ALTER TABLE public.article_favorites DISABLE ROW LEVEL SECURITY;

COMMIT;
```

3. **ç‚¹å‡» Run**

4. **éªŒè¯ç»“æœ**:
```sql
SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = 'article_favorites';
```
åº”è¯¥çœ‹åˆ° `rowsecurity = false`

5. **åˆ·æ–°æµè§ˆå™¨**ï¼ˆCtrl+Shift+Rï¼‰

6. **æµ‹è¯•æ”¶è—**:
   - è®¿é—®é¦–é¡µæˆ–æ–‡åŒ–é€Ÿè¯»é¡µ
   - ç‚¹å‡»æ–‡ç« æ”¶è—æŒ‰é’®
   - âœ… åº”è¯¥æˆåŠŸï¼

---

## ğŸ“Š ä¸ºä»€ä¹ˆè¿™æ ·åšæ˜¯å®‰å…¨çš„ï¼Ÿ

### APIå±‚çš„ä¿æŠ¤

æŸ¥çœ‹ `app/api/user/favorites/route.ts`:

```typescript
export async function POST(request: NextRequest) {
  // âœ… 1. ç”¨æˆ·è®¤è¯
  const { userId, error: authError } = await authenticateUser(request)
  
  if (authError || !userId) {
    return NextResponse.json({ error: 'æœªæˆæƒè®¿é—®' }, { status: 401 })
  }
  
  // âœ… 2. æ’å…¥æ—¶å¼ºåˆ¶ä½¿ç”¨å½“å‰ç”¨æˆ·ID
  const { data: newFavorite, error: insertError } = await supabase
    .from('article_favorites')
    .insert({ user_id: userId, article_id: articleId })  // userIdæ¥è‡ªè®¤è¯
    .select()
    .single()
}
```

**ä¿æŠ¤æœºåˆ¶**:
1. âœ… å¿…é¡»ç™»å½•æ‰èƒ½è°ƒç”¨APIï¼ˆJWT tokenéªŒè¯ï¼‰
2. âœ… userIdç”±æœåŠ¡å™¨ä»tokenä¸­æå–ï¼Œæ— æ³•ä¼ªé€ 
3. âœ… æ’å…¥çš„æ•°æ®å¼ºåˆ¶ä½¿ç”¨è®¤è¯çš„userId

**ç»“è®º**: å³ä½¿æ²¡æœ‰RLSï¼Œæ•°æ®ä¹Ÿæ˜¯å®‰å…¨çš„ï¼

---

## ğŸ” ä¸äº§å“/è¯¾ç¨‹æ”¶è—çš„å¯¹æ¯”

| åŠŸèƒ½ | äº§å“æ”¶è— | è¯¾ç¨‹æ”¶è— | æ–‡ç« æ”¶è— |
|------|---------|---------|---------|
| è¡¨å | favorites | favorites | article_favorites |
| RLSçŠ¶æ€ | ? | ? | å°†ç¦ç”¨ |
| APIè®¤è¯ | âœ… | âœ… | âœ… |
| å·¥ä½œçŠ¶æ€ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ | â³ å¾…ä¿®å¤ |

**æ£€æŸ¥å‘½ä»¤**ï¼ˆå¯é€‰ï¼‰:
```sql
SELECT tablename, rowsecurity FROM pg_tables 
WHERE tablename IN ('favorites', 'article_favorites');
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

æ‰§è¡ŒSQLåï¼Œä¾æ¬¡æµ‹è¯•ï¼š

### æµ‹è¯•1: é¦–é¡µæ”¶è—
```
1. è®¿é—® http://localhost:3000
2. æ»šåŠ¨åˆ°"æ–‡åŒ–é€Ÿè¯»"
3. æ‚¬åœæ–‡ç«  â†’ ç‚¹å‡»â¤ï¸
4. âœ… Toast: "æ”¶è—æˆåŠŸ"
5. âœ… ç»ˆç«¯æ— RLSé”™è¯¯
```

### æµ‹è¯•2: è¯¦æƒ…é¡µæ”¶è—
```
1. è®¿é—®ä»»æ„æ–‡ç« è¯¦æƒ…é¡µ
2. ç‚¹å‡»"æ”¶è—æ–‡ç« "æŒ‰é’®
3. âœ… æŒ‰é’®å˜ä¸º"å·²æ”¶è—"
```

### æµ‹è¯•3: æ”¶è—åˆ—è¡¨
```
1. è®¿é—® /profile/favorites
2. ç‚¹å‡»"æ–‡ç« "æ ‡ç­¾
3. âœ… çœ‹åˆ°æ”¶è—çš„æ–‡ç« 
```

### æµ‹è¯•4: å–æ¶ˆæ”¶è—
```
1. åœ¨è¯¦æƒ…é¡µç‚¹å‡»"å·²æ”¶è—"
2. âœ… Toast: "å·²å–æ¶ˆæ”¶è—"
3. âœ… æŒ‰é’®æ¢å¤ä¸º"æ”¶è—æ–‡ç« "
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### æ–°å»ºæ–‡ä»¶
1. âœ… `fix-article-favorites-final.sql` - æ–¹æ¡ˆAçš„SQLè„šæœ¬
2. âœ… `æ£€æŸ¥favoritesè¡¨é…ç½®.sql` - æ–¹æ¡ˆBçš„æ£€æŸ¥è„šæœ¬
3. âœ… `âš¡ç»ˆæä¿®å¤æ–¹æ¡ˆ-æ–‡ç« æ”¶è—.md` - æœ¬æ–‡æ¡£

### å·²ä¿®æ”¹æ–‡ä»¶ï¼ˆä¹‹å‰çš„å·¥ä½œï¼‰
1. âœ… `app/page.tsx` - å®æ—¶è·å–æ–‡ç« 
2. âœ… `hooks/use-favorites.ts` - å®Œå–„æ”¶è—é€»è¾‘
3. âœ… `app/api/user/favorites/route.ts` - APIæ”¯æŒ
4. âœ… æ‰€æœ‰UIç»„ä»¶ - æ”¶è—æŒ‰é’®

---

## ğŸš€ æ‰§è¡Œæ­¥éª¤æ€»ç»“

### ç«‹å³æ‰§è¡Œï¼ˆ5åˆ†é’Ÿï¼‰

1. **æ‰§è¡ŒSQL** (2åˆ†é’Ÿ)
   - å¤åˆ¶ `fix-article-favorites-final.sql` çš„å†…å®¹
   - åœ¨ Supabase SQL Editor æ‰§è¡Œ
   - éªŒè¯ `rowsecurity = false`

2. **åˆ·æ–°æµè§ˆå™¨** (10ç§’)
   - Ctrl+Shift+R ç¡¬åˆ·æ–°

3. **æµ‹è¯•æ”¶è—** (2åˆ†é’Ÿ)
   - é¦–é¡µæ”¶è—æ–‡ç« 
   - æŸ¥çœ‹æ”¶è—åˆ—è¡¨
   - å–æ¶ˆæ”¶è—

4. **éªŒè¯æˆåŠŸ** (1åˆ†é’Ÿ)
   - ç»ˆç«¯æ— RLSé”™è¯¯
   - Toastæç¤ºæ­£å¸¸
   - æ•°æ®æ­£ç¡®å­˜å‚¨

---

## â“ å¦‚æœè¿˜æ˜¯å¤±è´¥

### 1. ç¡®è®¤SQLæ‰§è¡ŒæˆåŠŸ
```sql
SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = 'article_favorites';
```
**å¿…é¡»æ˜¾ç¤º**: `rowsecurity = false`

### 2. æ£€æŸ¥ç»ˆç«¯é”™è¯¯
å¦‚æœè¿˜æ˜¯RLSé”™è¯¯ â†’ é‡å¯å¼€å‘æœåŠ¡å™¨
```bash
Ctrl+C åœæ­¢
npm run dev é‡å¯
```

### 3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
- å³é”®åˆ·æ–°æŒ‰é’® â†’ "æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"

### 4. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°
console.log(localStorage.getItem('supabase.auth.token'))
```
å¦‚æœæ˜¯null â†’ é‡æ–°ç™»å½•

---

## âœ… æˆåŠŸæ ‡å¿—

- [ ] SQLæ‰§è¡ŒæˆåŠŸï¼Œrowsecurity = false
- [ ] æµè§ˆå™¨å·²åˆ·æ–°
- [ ] é¦–é¡µæ–‡ç« å¯ä»¥æ”¶è—
- [ ] ç»ˆç«¯æ— RLSé”™è¯¯
- [ ] Toastæç¤º"æ”¶è—æˆåŠŸ"
- [ ] æ”¶è—é¡µæ˜¾ç¤ºæ–‡ç« 
- [ ] å¯ä»¥å–æ¶ˆæ”¶è—

---

**å…³é”®**: ç«‹å³æ‰§è¡Œ `fix-article-favorites-final.sql`  
**é¢„æœŸç»“æœ**: ç¦ç”¨RLSåï¼Œæ”¶è—åŠŸèƒ½ç«‹å³æ­£å¸¸  
**åŸç†**: APIå±‚å·²æœ‰è®¤è¯ä¿æŠ¤ï¼Œæ— éœ€æ•°æ®åº“RLS  
**æ—¶é—´**: 3åˆ†é’Ÿè§£å†³
