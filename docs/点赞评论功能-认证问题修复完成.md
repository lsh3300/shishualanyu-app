# ğŸ‰ ç‚¹èµè¯„è®ºåŠŸèƒ½ - è®¤è¯é—®é¢˜ä¿®å¤å®Œæˆ

## âœ… é—®é¢˜å·²è§£å†³

### ğŸ”´ åŸé—®é¢˜
```
POST /api/likes 401 (Unauthorized)
POST /api/comments 401 (Unauthorized)
ç‚¹èµæ“ä½œé”™è¯¯: Error: æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ
å‘å¸ƒè¯„è®ºé”™è¯¯: Error: æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ
```

### âœ… æ ¹æœ¬åŸå› 
API ä½¿ç”¨äº† `createServiceClient()` ä½†ç›´æ¥è°ƒç”¨ `supabase.auth.getUser()`ï¼Œè¿™æ˜¯é”™è¯¯çš„ã€‚Service Client æ²¡æœ‰ç”¨æˆ·ä¼šè¯ä¿¡æ¯ï¼Œæ— æ³•è·å–å½“å‰ç™»å½•ç”¨æˆ·ã€‚

### âœ… æ­£ç¡®åšæ³•
ä½¿ç”¨ `authenticateUser(request)` å‡½æ•°ä»è¯·æ±‚å¤´çš„ `Authorization` header ä¸­è·å– tokenï¼Œç„¶åéªŒè¯ç”¨æˆ·èº«ä»½ã€‚

---

## ğŸ”§ å·²ä¿®å¤çš„æ–‡ä»¶

### 1. `app/api/likes/route.ts` âœ…
- âœ… æ·»åŠ  `authenticateUser` å‡½æ•°
- âœ… POST æ–¹æ³•ï¼šä½¿ç”¨ `authenticateUser(request)` è·å–ç”¨æˆ·
- âœ… DELETE æ–¹æ³•ï¼šä½¿ç”¨ `authenticateUser(request)` è·å–ç”¨æˆ·

### 2. `app/api/comments/route.ts` âœ…
- âœ… æ·»åŠ  `authenticateUser` å‡½æ•°
- âœ… POST æ–¹æ³•ï¼šä½¿ç”¨ `authenticateUser(request)` è·å–ç”¨æˆ·
- âœ… PUT æ–¹æ³•ï¼šä½¿ç”¨ `authenticateUser(request)` è·å–ç”¨æˆ·
- âœ… DELETE æ–¹æ³•ï¼šä½¿ç”¨ `authenticateUser(request)` è·å–ç”¨æˆ·

### 3. `app/api/comment-likes/route.ts` âœ…
- âœ… æ·»åŠ  `authenticateUser` å‡½æ•°
- âœ… POST æ–¹æ³•ï¼šä½¿ç”¨ `authenticateUser(request)` è·å–ç”¨æˆ·
- âœ… DELETE æ–¹æ³•ï¼šä½¿ç”¨ `authenticateUser(request)` è·å–ç”¨æˆ·

---

## ğŸ¯ ç°åœ¨éœ€è¦åšä»€ä¹ˆ

### 1ï¸âƒ£ ç¡®ä¿å·²æ‰§è¡Œ SQL ä¿®å¤è„šæœ¬

å¦‚æœè¿˜æ²¡æœ‰æ‰§è¡Œï¼Œè¯·åœ¨ **Supabase SQL Editor** ä¸­æ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªè„šæœ¬ï¼š

**è„šæœ¬ 1ï¼šå¤–é”®ä¿®å¤**
```sql
BEGIN;

ALTER TABLE public.likes DROP CONSTRAINT IF EXISTS likes_user_id_fkey;
ALTER TABLE public.likes ADD CONSTRAINT likes_user_id_fkey 
FOREIGN KEY (user_id) REFERENCES public.profiles(id) ON DELETE CASCADE;

ALTER TABLE public.comments DROP CONSTRAINT IF EXISTS comments_user_id_fkey;
ALTER TABLE public.comments ADD CONSTRAINT comments_user_id_fkey 
FOREIGN KEY (user_id) REFERENCES public.profiles(id) ON DELETE CASCADE;

ALTER TABLE public.comment_likes DROP CONSTRAINT IF EXISTS comment_likes_user_id_fkey;
ALTER TABLE public.comment_likes ADD CONSTRAINT comment_likes_user_id_fkey 
FOREIGN KEY (user_id) REFERENCES public.profiles(id) ON DELETE CASCADE;

COMMIT;
```

**è„šæœ¬ 2ï¼šitem_id ç±»å‹ä¿®å¤**
```sql
BEGIN;

ALTER TABLE public.likes ALTER COLUMN item_id TYPE TEXT;
ALTER TABLE public.comments ALTER COLUMN item_id TYPE TEXT;

COMMIT;
```

### 2ï¸âƒ£ é‡å¯å¼€å‘æœåŠ¡å™¨

```bash
# æŒ‰ Ctrl+C åœæ­¢å½“å‰æœåŠ¡å™¨
# ç„¶åé‡æ–°å¯åŠ¨
npm run dev
```

### 3ï¸âƒ£ æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶é‡æ–°ç™»å½•

1. **æ¸…é™¤ç¼“å­˜**ï¼šæŒ‰ `Ctrl + Shift + R` (Windows) æˆ– `Cmd + Shift + R` (Mac)
2. **é‡æ–°ç™»å½•**ï¼š
   - è®¿é—® http://localhost:3000/auth
   - ç™»å½•ä½ çš„è´¦å·
3. **æµ‹è¯•åŠŸèƒ½**ï¼š
   - è®¿é—®ä»»æ„è¯¾ç¨‹è¯¦æƒ…é¡µ
   - å°è¯•ç‚¹èµ
   - å°è¯•å‘å¸ƒè¯„è®º

---

## ğŸ§ª æµ‹è¯•æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹æµ‹è¯•ç¡®è®¤åŠŸèƒ½æ­£å¸¸ï¼š

### ç‚¹èµåŠŸèƒ½
- [ ] ç™»å½•åå¯ä»¥ç‚¹èµè¯¾ç¨‹
- [ ] ç‚¹èµæŒ‰é’®å˜çº¢ï¼Œç‚¹èµæ•° +1
- [ ] å¯ä»¥å–æ¶ˆç‚¹èµ
- [ ] æœªç™»å½•æ—¶æç¤º"è¯·å…ˆç™»å½•"

### è¯„è®ºåŠŸèƒ½
- [ ] ç™»å½•åå¯ä»¥å‘å¸ƒè¯„è®º
- [ ] è¯„è®ºç«‹å³æ˜¾ç¤ºåœ¨åˆ—è¡¨
- [ ] å¯ä»¥å›å¤è¯„è®º
- [ ] å¯ä»¥ç¼–è¾‘è‡ªå·±çš„è¯„è®º
- [ ] å¯ä»¥åˆ é™¤è‡ªå·±çš„è¯„è®º
- [ ] å¯ä»¥ç»™è¯„è®ºç‚¹èµ
- [ ] æœªç™»å½•æ—¶æç¤º"è¯·å…ˆç™»å½•"

### æµè§ˆå™¨æ§åˆ¶å°
- [ ] æ—  401 é”™è¯¯
- [ ] æ—  500 é”™è¯¯
- [ ] æ— è®¤è¯ç›¸å…³é”™è¯¯

### æœåŠ¡å™¨ç»ˆç«¯
- [ ] æ—  "Could not find a relationship" é”™è¯¯
- [ ] æ—  "invalid input syntax for type uuid" é”™è¯¯
- [ ] æ— è®¤è¯ç›¸å…³é”™è¯¯

---

## ğŸ“Š æŠ€æœ¯è¯´æ˜

### è®¤è¯æµç¨‹

**é”™è¯¯çš„æ–¹å¼** âŒ
```typescript
const supabase = createServiceClient()
const { data: { user } } = await supabase.auth.getUser() // æ²¡æœ‰ tokenï¼Œè·å–ä¸åˆ°ç”¨æˆ·
```

**æ­£ç¡®çš„æ–¹å¼** âœ…
```typescript
// ä»è¯·æ±‚å¤´è·å– token
const authHeader = request.headers.get('authorization')
const token = authHeader?.replace('Bearer ', '').trim()

// ä½¿ç”¨ token éªŒè¯ç”¨æˆ·
const supabase = createServiceClient()
const { data, error } = await supabase.auth.getUser(token)
```

### ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·åšï¼Ÿ

åœ¨ Next.js API Routes ä¸­ï¼š
- Service Client æ˜¯æœåŠ¡å™¨ç«¯å®¢æˆ·ç«¯ï¼Œæ²¡æœ‰æµè§ˆå™¨çš„ cookie/session
- ç”¨æˆ·çš„è®¤è¯ token å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­
- API è¯·æ±‚é€šè¿‡ `Authorization` header ä¼ é€’ token
- å¿…é¡»ä» request header ä¸­æå– token è¿›è¡ŒéªŒè¯

### Frontend Hook å¦‚ä½•ä¼ é€’ Tokenï¼Ÿ

æˆ‘ä»¬çš„ hooks (`useLikes`, `useComments`) å·²ç»æ­£ç¡®å®ç°äº†ï¼š

```typescript
const { data: { session } } = await supabase.auth.getSession()
const token = session?.access_token

fetch('/api/likes', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`, // âœ… ä¼ é€’ token
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ item_type, item_id })
})
```

---

## ğŸŠ ä¿®å¤å®Œæˆ

æ‰€æœ‰è®¤è¯é—®é¢˜å·²ä¿®å¤ï¼

**ä¿®å¤å†…å®¹**ï¼š
- âœ… ä¿®å¤äº† 3 ä¸ª API æ–‡ä»¶çš„è®¤è¯é€»è¾‘
- âœ… æ·»åŠ äº†ç»Ÿä¸€çš„ `authenticateUser` å‡½æ•°
- âœ… æ‰€æœ‰éœ€è¦è®¤è¯çš„æ“ä½œç°åœ¨éƒ½èƒ½æ­£å¸¸å·¥ä½œ

**ä¸‹ä¸€æ­¥**ï¼š
1. æ‰§è¡Œ SQL è„šæœ¬ï¼ˆå¦‚æœè¿˜æ²¡æ‰§è¡Œï¼‰
2. é‡å¯å¼€å‘æœåŠ¡å™¨
3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
4. é‡æ–°ç™»å½•
5. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½

**é¢„æœŸç»“æœ**ï¼š
- âœ… ç‚¹èµæˆåŠŸ
- âœ… è¯„è®ºå‘å¸ƒæˆåŠŸ
- âœ… æ—  401 é”™è¯¯
- âœ… æ—  500 é”™è¯¯

---

**ç°åœ¨ç«‹å³é‡å¯å¼€å‘æœåŠ¡å™¨å¹¶æµ‹è¯•ï¼** ğŸš€

æ‰€æœ‰åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘å…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚
