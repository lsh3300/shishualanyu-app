# 点赞与评论功能 - 测试指南

## ✅ 开发完成清单

所有功能已开发完成：

### 后端层 (100%)
- ✅ 数据库表结构 (`likes`, `comments`, `comment_likes`)
- ✅ RLS 安全策略
- ✅ 数据库触发器（自动维护评论点赞数）
- ✅ 点赞 API (`/api/likes`)
- ✅ 评论 API (`/api/comments`)
- ✅ 评论点赞 API (`/api/comment-likes`)

### 前端层 (100%)
- ✅ `useLikes` Hook（点赞逻辑）
- ✅ `useComments` Hook（评论逻辑）
- ✅ `LikeButton` 组件（蓝染风格点赞按钮）
- ✅ `CommentForm` 组件（评论发布表单）
- ✅ `CommentItem` 组件（单条评论展示）
- ✅ `CommentSection` 组件（完整评论区）

### 页面集成 (100%)
- ✅ 文章详情页 (`app/culture/[slug]/page.tsx`)
- ✅ 产品详情页 (`components/templates/product-detail-template.tsx`)
- ✅ 课程详情页 (`components/templates/course-detail-template.tsx`)

---

## 🚀 测试前准备

### 1. 确认数据库已初始化

**必须先完成这一步！**

- ✅ 已在 Supabase SQL Editor 中执行 `supabase/likes-comments-schema.sql`
- ✅ 验证表已创建（3个表：likes, comments, comment_likes）
- ✅ 验证 RLS 策略已生效（9个策略）

### 2. 启动开发服务器

```bash
npm run dev
```

访问 http://localhost:3000

### 3. 准备测试账号

确保你有一个登录账号，或者注册一个新账号。

---

## 🧪 功能测试步骤

### 测试 1：文章点赞功能

1. **访问文章详情页**
   - 打开 http://localhost:3000/culture
   - 点击任意文章进入详情页

2. **测试点赞**
   - 找到页面底部的点赞按钮
   - 点击点赞，观察：
     - ✅ 按钮状态变化（红心填充）
     - ✅ 点赞数 +1
     - ✅ 动画效果（心跳动画）
     - ✅ Toast 提示"点赞成功"

3. **测试取消点赞**
   - 再次点击点赞按钮
   - 观察：
     - ✅ 按钮恢复未点赞状态
     - ✅ 点赞数 -1
     - ✅ Toast 提示"已取消点赞"

4. **测试未登录状态**
   - 退出登录
   - 点击点赞按钮
   - 观察：
     - ✅ Toast 提示"请先登录"
     - ✅ 点赞数不变

---

### 测试 2：文章评论功能

1. **发布评论**
   - 在评论输入框中输入内容（如："这篇文章写得很好！"）
   - 点击"发布评论"按钮
   - 观察：
     - ✅ 评论立即出现在列表中
     - ✅ 显示用户头像和昵称
     - ✅ 显示"刚刚"时间
     - ✅ 评论总数 +1

2. **测试字数限制**
   - 输入超过 2000 字的内容
   - 观察：
     - ✅ 显示"超出字数限制"提示
     - ✅ 发布按钮禁用
     - ✅ 字数统计变红

3. **回复评论**
   - 找到刚发布的评论
   - 点击"回复"按钮
   - 输入回复内容（如："谢谢！"）
   - 点击"发布回复"
   - 观察：
     - ✅ 回复出现在父评论下方
     - ✅ 有缩进线显示层级关系
     - ✅ 显示"回复 @用户名"

4. **给评论点赞**
   - 点击评论的点赞按钮（小心形图标）
   - 观察：
     - ✅ 心形图标填充
     - ✅ 评论点赞数 +1
     - ✅ 点击动画效果

5. **编辑自己的评论**
   - 找到自己发布的评论
   - 点击右上角的"..."菜单
   - 选择"编辑"
   - 修改内容，点击"保存"
   - 观察：
     - ✅ 评论内容更新
     - ✅ Toast 提示"评论已更新"

6. **删除自己的评论**
   - 点击评论的"..."菜单
   - 选择"删除"
   - 确认删除
   - 观察：
     - ✅ 评论从列表移除
     - ✅ 评论总数 -1
     - ✅ 子评论也被删除（如果有）

7. **评论排序**
   - 点击"最新"/"最热"标签切换排序
   - 观察：
     - ✅ 评论列表重新排序
     - ✅ 最新：按时间倒序
     - ✅ 最热：按点赞数排序

8. **加载更多评论**
   - 如果评论超过 20 条
   - 滚动到底部，点击"加载更多评论"
   - 观察：
     - ✅ 加载下一页评论
     - ✅ 新评论追加到列表末尾

---

### 测试 3：产品点赞和评论

1. **访问产品详情页**
   - 打开 http://localhost:3000/store
   - 点击任意产品进入详情页

2. **测试产品点赞**
   - 滚动到"实拍图片"部分下方
   - 找到点赞按钮（较大的按钮）
   - 点击测试点赞/取消点赞
   - 观察动画和数据变化

3. **测试产品评价**
   - 继续向下滚动到"用户评价"区域
   - 发布一条评价（如："质量很好，非常喜欢！"）
   - 测试回复、点赞、编辑、删除功能
   - 验证所有功能正常

---

### 测试 4：课程点赞和评论

1. **访问课程详情页**
   - 打开 http://localhost:3000/teaching
   - 点击任意课程进入详情页

2. **测试课程点赞**
   - 滚动到材料部分下方
   - 找到点赞按钮
   - 测试点赞功能

3. **测试课程评价**
   - 继续向下到"课程评价"区域
   - 发布课程评价（如："老师讲得很清楚，学到很多！"）
   - 测试完整的评论功能

---

## 🎨 UI/UX 测试

### 视觉效果检查

- ✅ **蓝染风格**：组件使用靛蓝色主题
- ✅ **动画效果**：点赞有心跳动画，评论有淡入效果
- ✅ **响应式设计**：在不同屏幕尺寸下正常显示
- ✅ **深色模式**：在深色主题下显示正常

### 交互体验检查

- ✅ **加载状态**：显示 Loading 动画
- ✅ **错误提示**：操作失败时有明确提示
- ✅ **成功反馈**：操作成功时有 Toast 提示
- ✅ **防抖处理**：快速点击不会重复提交

### 性能检查

- ✅ **懒加载**：评论列表分页加载
- ✅ **乐观更新**：点赞/评论操作立即反馈
- ✅ **缓存优化**：点赞状态缓存在本地

---

## ❌ 常见问题排查

### 问题 1：点击点赞没反应

**可能原因**：
1. 未登录
2. 数据库 RLS 策略未生效
3. API 请求失败

**解决方法**：
1. 确认已登录
2. 检查浏览器控制台是否有错误
3. 检查 Network 标签查看 API 请求状态
4. 验证 Supabase 表和策略是否正确创建

### 问题 2：评论发布失败

**可能原因**：
1. 未登录
2. 评论内容为空或超长
3. RLS 策略未生效
4. 数据库连接失败

**解决方法**：
1. 检查登录状态
2. 验证评论内容长度（1-2000字）
3. 查看控制台错误信息
4. 检查 Supabase 连接配置

### 问题 3：评论点赞数不更新

**可能原因**：
- 数据库触发器未创建

**解决方法**：
- 重新执行 SQL 脚本，特别是触发器部分
- 在 Supabase 中验证触发器是否存在

### 问题 4：评论回复层级错误

**可能原因**：
- `parent_id` 字段传递错误

**解决方法**：
- 检查 API 请求的 `parent_id` 参数
- 验证数据库中的 `parent_id` 值

---

## 📊 测试数据准备

### 创建测试评论

在浏览器控制台执行（可选）：

```javascript
// 批量创建测试评论
async function createTestComments(itemType, itemId, count = 5) {
  for (let i = 1; i <= count; i++) {
    await fetch('/api/comments', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        item_type: itemType,
        item_id: itemId,
        content: `这是第 ${i} 条测试评论，用于测试评论功能。`
      })
    });
  }
  console.log(`已创建 ${count} 条测试评论`);
}

// 使用示例
// createTestComments('article', 'your-article-uuid', 10);
```

---

## ✅ 测试完成清单

完成以下测试后，功能即可上线：

### 基础功能
- [ ] 文章点赞/取消点赞
- [ ] 产品点赞/取消点赞
- [ ] 课程点赞/取消点赞
- [ ] 发布评论（文章/产品/课程）
- [ ] 回复评论（最多 3 层）
- [ ] 编辑评论
- [ ] 删除评论
- [ ] 给评论点赞

### 权限验证
- [ ] 未登录无法点赞
- [ ] 未登录无法评论
- [ ] 只能编辑/删除自己的评论
- [ ] RLS 策略保护数据安全

### 用户体验
- [ ] 所有动画效果流畅
- [ ] Toast 提示清晰准确
- [ ] 加载状态显示正常
- [ ] 错误提示友好

### 数据完整性
- [ ] 点赞数准确
- [ ] 评论数准确
- [ ] 评论点赞数自动更新
- [ ] 删除评论级联删除回复

### 性能表现
- [ ] 评论列表分页加载
- [ ] 点赞/评论响应迅速
- [ ] 无内存泄漏
- [ ] 无重复请求

---

## 🎉 测试通过后

如果所有测试都通过，恭喜！点赞和评论功能已经可以上线了。

### 下一步建议：

1. **性能优化**
   - 添加评论缓存
   - 实现实时更新（Supabase Realtime）
   - 优化数据库查询索引

2. **功能增强**
   - 添加敏感词过滤
   - 实现评论举报功能
   - 支持评论中上传图片
   - 添加 @提及用户功能

3. **数据分析**
   - 统计最受欢迎的内容
   - 分析用户互动行为
   - 生成数据报表

4. **移动端优化**
   - 优化触摸交互
   - 适配各种屏幕尺寸
   - 优化加载速度

---

**测试愉快！** 🚀

有问题随时反馈，我会帮你解决。
