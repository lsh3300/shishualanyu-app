# ğŸ”¥ æœ€ç»ˆä¿®å¤ - æ–‡ç« æ”¶è—å®Œå…¨æŒ‡å—

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. **ä¿®å¤é¦–é¡µ"æš‚æ— æ–‡ç« "é—®é¢˜**
**æ–‡ä»¶**: `app/page.tsx`

**é—®é¢˜**: æŸ¥è¯¢æ¡ä»¶ä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µ
- âŒ é”™è¯¯ï¼š`.eq('published', true)` 
- âœ… æ­£ç¡®ï¼š`.eq('status', 'published')`

**åŸå› **: æ•°æ®åº“schemaä½¿ç”¨`status`å­—æ®µï¼ˆå€¼ä¸º'published'ï¼‰ï¼Œä¸æ˜¯`published`å¸ƒå°”å­—æ®µ

---

### 2. **ä¿®å¤æ–‡ç« æ”¶è—åŠŸèƒ½**
**æ–‡ä»¶**: `hooks/use-favorites.ts`

**æ”¹è¿›**:
- âœ… å‚è€ƒè¯¾ç¨‹æ”¶è—çš„å®Œæ•´å®ç°
- âœ… æ·»åŠ è¯¦ç»†çš„é”™è¯¯å¤„ç†
- âœ… æ·»åŠ æ§åˆ¶å°æ—¥å¿—ç”¨äºè°ƒè¯•
- âœ… å¤„ç†"å·²åœ¨æ”¶è—å¤¹ä¸­"çš„æƒ…å†µ
- âœ… ç»Ÿä¸€Toastæç¤ºæ¶ˆæ¯
- âœ… è‡ªåŠ¨åˆ·æ–°æ”¶è—åˆ—è¡¨

**æ ¸å¿ƒæ”¹è¿›**:
```typescript
// æ·»åŠ å‰éªŒè¯
if (!articleId) {
  toast({ title: "æ·»åŠ å¤±è´¥", description: "æ–‡ç« IDæ— æ•ˆ" })
  return false
}

console.log('ğŸ“ å‡†å¤‡æ·»åŠ æ–‡ç« æ”¶è—:', articleId)

// å“åº”è§£æå®¹é”™
let data;
try {
  data = await response.json()
} catch (e) {
  console.error('è§£æå“åº”å¤±è´¥:', e)
  return false
}

// å·²æ”¶è—æƒ…å†µå¤„ç†
if (data.message === 'å·²åœ¨æ”¶è—å¤¹ä¸­') {
  toast({ title: "å·²åœ¨æ”¶è—å¤¹ä¸­", variant: "default" })
  return true  // è¿”å›trueè€Œä¸æ˜¯false
}
```

---

### 3. **æ›´æ–°SQLè„šæœ¬ï¼ˆå¯é‡å¤æ‰§è¡Œï¼‰**
**æ–‡ä»¶**: `supabase/fix-article-favorites-rls.sql`

**æ”¹è¿›**: è„šæœ¬ç°åœ¨å¯ä»¥é‡å¤æ‰§è¡Œï¼Œä¸ä¼šæŠ¥é”™
- åˆ é™¤æ‰€æœ‰å†å²ç­–ç•¥
- åˆ é™¤å½“å‰ç­–ç•¥ï¼ˆä¾¿äºé‡å¤æ‰§è¡Œï¼‰
- é‡æ–°åˆ›å»ºç­–ç•¥

---

## ğŸ”¥ å¿…é¡»æ‰§è¡Œçš„SQLè„šæœ¬

### åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ

```sql
-- ä¿®å¤æ–‡ç« æ”¶è—çš„ RLS ç­–ç•¥
-- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œæ­¤è„šæœ¬

BEGIN;

-- åˆ é™¤å†å²ç­–ç•¥
DROP POLICY IF EXISTS "Users read own favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users insert own favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users delete own favorites" ON public.article_favorites;

-- åˆ é™¤å½“å‰ç­–ç•¥ï¼Œä¾¿äºè„šæœ¬é‡å¤æ‰§è¡Œ
DROP POLICY IF EXISTS "Users can view own article favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users can insert own article favorites" ON public.article_favorites;
DROP POLICY IF EXISTS "Users can delete own article favorites" ON public.article_favorites;

-- é‡æ–°åˆ›å»ºæ­£ç¡®çš„ RLS ç­–ç•¥

-- 1. ç”¨æˆ·å¯ä»¥è¯»å–è‡ªå·±çš„æ”¶è—
CREATE POLICY "Users can view own article favorites"
  ON public.article_favorites
  FOR SELECT
  USING (user_id = auth.uid());

-- 2. ç”¨æˆ·å¯ä»¥æ·»åŠ è‡ªå·±çš„æ”¶è—
CREATE POLICY "Users can insert own article favorites"
  ON public.article_favorites
  FOR INSERT
  WITH CHECK (user_id = auth.uid());

-- 3. ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„æ”¶è—
CREATE POLICY "Users can delete own article favorites"
  ON public.article_favorites
  FOR DELETE
  USING (user_id = auth.uid());

-- ç¡®ä¿ RLS å·²å¯ç”¨
ALTER TABLE public.article_favorites ENABLE ROW LEVEL SECURITY;

COMMIT;

-- éªŒè¯ç­–ç•¥
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual,
  with_check
FROM pg_policies
WHERE tablename = 'article_favorites';
```

### æ‰§è¡Œæ­¥éª¤

1. **ç™»å½• Supabase**: https://supabase.com/dashboard
2. **é€‰æ‹©é¡¹ç›®**: ä½ çš„é¡¹ç›®
3. **æ‰“å¼€ SQL Editor**: å·¦ä¾§èœå• â†’ SQL Editor
4. **æ–°å»ºæŸ¥è¯¢**: ç‚¹å‡» "New query"
5. **ç²˜è´´è„šæœ¬**: å¤åˆ¶ä¸Šé¢çš„å®Œæ•´SQL
6. **æ‰§è¡Œ**: ç‚¹å‡» "Run" æˆ–æŒ‰ Ctrl+Enter
7. **éªŒè¯**: åº•éƒ¨åº”æ˜¾ç¤º3æ¡ç­–ç•¥è®°å½•

---

## ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹

### å‰ç½®æ¡ä»¶
- [x] å·²åœ¨ Supabase æ‰§è¡Œ RLS è„šæœ¬
- [x] å·²åˆ·æ–°æµè§ˆå™¨ (Ctrl+Shift+R)
- [x] å·²ç™»å½•ç³»ç»Ÿ
- [x] å¼€å‘æœåŠ¡å™¨è¿è¡Œä¸­

### æµ‹è¯• 1: é¦–é¡µæ–‡ç« æ˜¾ç¤º âœ…
```
1. è®¿é—® http://localhost:3000
2. æ»šåŠ¨åˆ°"æ–‡åŒ–é€Ÿè¯»"éƒ¨åˆ†
3. âœ… åº”è¯¥æ˜¾ç¤º 3 ç¯‡æ–‡ç« ï¼ˆä¸å†æ˜¯"æš‚æ— æ–‡ç« "ï¼‰
4. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°
5. âœ… æ²¡æœ‰"è·å–æ–‡ç« å¤±è´¥"çš„é”™è¯¯
```

### æµ‹è¯• 2: é¦–é¡µæ–‡ç« æ”¶è— âœ…
```
1. åœ¨é¦–é¡µ"æ–‡åŒ–é€Ÿè¯»"éƒ¨åˆ†
2. æ‚¬åœä»»æ„æ–‡ç« å¡ç‰‡
3. ç‚¹å‡»å³ä¸Šè§’â¤ï¸å›¾æ ‡
4. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°
5. âœ… åº”è¯¥æ˜¾ç¤º: ğŸ“ å‡†å¤‡æ·»åŠ æ–‡ç« æ”¶è—: [UUID]
6. âœ… Toastæç¤º: "æ”¶è—æˆåŠŸ"
7. âœ… å›¾æ ‡å˜ä¸ºå®å¿ƒçº¢è‰²
```

### æµ‹è¯• 3: åˆ—è¡¨é¡µæ”¶è— âœ…
```
1. è®¿é—® http://localhost:3000/culture
2. æ‚¬åœä»»æ„æ–‡ç« 
3. ç‚¹å‡»â¤ï¸å›¾æ ‡
4. âœ… æ”¶è—æˆåŠŸ
5. âœ… æ§åˆ¶å°æ˜¾ç¤ºæ—¥å¿—
```

### æµ‹è¯• 4: è¯¦æƒ…é¡µæ”¶è— âœ…
```
1. è®¿é—®ä»»æ„æ–‡ç« è¯¦æƒ…é¡µ
2. ç‚¹å‡»æ ‡é¢˜ä¸‹æ–¹"æ”¶è—æ–‡ç« "æŒ‰é’®
3. âœ… æŒ‰é’®å˜ä¸º"å·²æ”¶è—"
4. âœ… Toastæç¤ºæˆåŠŸ
```

### æµ‹è¯• 5: æ”¶è—åˆ—è¡¨ âœ…
```
1. è®¿é—® /profile/favorites
2. ç‚¹å‡»"æ–‡ç« "æ ‡ç­¾
3. âœ… çœ‹åˆ°æ‰€æœ‰æ”¶è—çš„æ–‡ç« 
4. ç‚¹å‡»ä»»æ„æ–‡ç« 
5. âœ… è·³è½¬åˆ°è¯¦æƒ…é¡µ
6. âœ… è¯¦æƒ…é¡µæŒ‰é’®æ˜¾ç¤º"å·²æ”¶è—"
```

### æµ‹è¯• 6: å–æ¶ˆæ”¶è— âœ…
```
1. åœ¨è¯¦æƒ…é¡µç‚¹å‡»"å·²æ”¶è—"æŒ‰é’®
2. æŸ¥çœ‹æ§åˆ¶å°
3. âœ… åº”è¯¥æ˜¾ç¤º: ğŸ—‘ï¸ å‡†å¤‡ç§»é™¤æ–‡ç« æ”¶è—: [UUID]
4. âœ… Toastæç¤º: "å·²å–æ¶ˆæ”¶è—"
5. âœ… æŒ‰é’®æ¢å¤ä¸º"æ”¶è—æ–‡ç« "
6. è¿”å›æ”¶è—é¡µåˆ·æ–°
7. âœ… æ–‡ç« å·²ä»åˆ—è¡¨æ¶ˆå¤±
```

---

## ğŸ› é”™è¯¯æ’æŸ¥æŒ‡å—

### é”™è¯¯ 1: é¦–é¡µè¿˜æ˜¯"æš‚æ— æ–‡ç« "

**å¯èƒ½åŸå› **:
1. æ•°æ®åº“ä¸­æ²¡æœ‰`status='published'`çš„æ–‡ç« 
2. æŸ¥è¯¢æ¡ä»¶é”™è¯¯

**è§£å†³æ–¹æ³•**:
```sql
-- åœ¨ Supabase SQL Editor æ£€æŸ¥
SELECT id, slug, title, status, created_at 
FROM culture_articles 
WHERE status = 'published' 
ORDER BY created_at DESC 
LIMIT 5;
```

**å¦‚æœæ²¡æœ‰ç»“æœ**:
- æ‰§è¡Œ `supabase/add-culture-articles-part1.sql` æ’å…¥ç¤ºä¾‹æ•°æ®
- æˆ–è€…æ‰‹åŠ¨æ›´æ–°ç°æœ‰æ–‡ç« çš„statuså­—æ®µ

```sql
-- æ›´æ–°ç°æœ‰æ–‡ç« ä¸ºpublishedçŠ¶æ€
UPDATE culture_articles 
SET status = 'published' 
WHERE status IS NULL OR status = '';
```

---

### é”™è¯¯ 2: æ”¶è—å¤±è´¥ - RLS é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
new row violates row-level security policy
```

**è§£å†³æ–¹æ³•**:
1. ç¡®è®¤å·²æ‰§è¡Œ `fix-article-favorites-rls.sql`
2. éªŒè¯ç­–ç•¥å­˜åœ¨:
```sql
SELECT policyname, cmd 
FROM pg_policies 
WHERE tablename = 'article_favorites';
```

3. åº”è¯¥çœ‹åˆ°3æ¡ç­–ç•¥:
   - Users can view own article favorites (SELECT)
   - Users can insert own article favorites (INSERT)
   - Users can delete own article favorites (DELETE)

---

### é”™è¯¯ 3: æ§åˆ¶å°æ˜¾ç¤º"æ–‡ç« IDæ— æ•ˆ"

**åŸå› **: ä¼ é€’çš„ä¸æ˜¯UUID

**æ£€æŸ¥**:
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°
console.log(document.querySelector('[data-article-id]')?.dataset)
```

**åº”è¯¥çœ‹åˆ°**:
```
{ articleId: "12345678-1234-1234-1234-123456789012" }
```

**å¦‚æœæ˜¯slug**: æ£€æŸ¥ç»„ä»¶propsä¼ é€’æ˜¯å¦æ­£ç¡®

---

### é”™è¯¯ 4: APIè¿”å›500é”™è¯¯

**æ£€æŸ¥ç»ˆç«¯æ—¥å¿—**:
```
âŒ æ·»åŠ æ–‡ç« æ”¶è—å¤±è´¥: { code: '...', message: '...' }
```

**å¸¸è§åŸå› **:
1. RLSç­–ç•¥æœªé…ç½®
2. article_idåœ¨culture_articlesè¡¨ä¸­ä¸å­˜åœ¨
3. ç”¨æˆ·æœªç™»å½•

**éªŒè¯æ–‡ç« å­˜åœ¨**:
```sql
SELECT id, title FROM culture_articles WHERE id = 'YOUR-ARTICLE-UUID';
```

---

## ğŸ“Š ä¿®å¤å¯¹ç…§è¡¨

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|------|------|---------|------|
| é¦–é¡µ"æš‚æ— æ–‡ç« " | æŸ¥è¯¢å­—æ®µé”™è¯¯ | æ”¹ä¸ºstatus='published' | âœ… å®Œæˆ |
| æ”¶è—å¤±è´¥RLSé”™è¯¯ | ç­–ç•¥æœªé…ç½® | æ‰§è¡ŒRLSè„šæœ¬ | â³ å¾…æ‰§è¡Œ |
| æ”¶è—åæ— æç¤º | é”™è¯¯å¤„ç†ä¸å®Œå–„ | å‚è€ƒè¯¾ç¨‹å®ç° | âœ… å®Œæˆ |
| å·²æ”¶è—ä»å¯ç‚¹å‡» | çŠ¶æ€åˆ¤æ–­ç¼ºå¤± | æ·»åŠ åˆ¤æ–­é€»è¾‘ | âœ… å®Œæˆ |

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ±‡æ€»

### ä¿®æ”¹çš„æ–‡ä»¶
1. âœ… `app/page.tsx` - ä¿®å¤æŸ¥è¯¢æ¡ä»¶
2. âœ… `hooks/use-favorites.ts` - å®Œå–„æ–‡ç« æ”¶è—é€»è¾‘
3. âœ… `supabase/fix-article-favorites-rls.sql` - å¯é‡å¤æ‰§è¡Œ

### ä¹‹å‰å·²å®Œæˆ
1. âœ… `app/culture/page.tsx` - çƒ­é—¨æ–‡ç« articleId
2. âœ… `app/culture/[slug]/page.tsx` - è¯¦æƒ…é¡µæ”¶è—æŒ‰é’®
3. âœ… `app/profile/favorites/page.tsx` - æ”¶è—é¡µæ–‡ç« æ ‡ç­¾
4. âœ… `components/ui/article-favorite-button.tsx` - æ”¶è—æŒ‰é’®ç»„ä»¶
5. âœ… `components/ui/culture-article-card.tsx` - æ–‡ç« å¡ç‰‡æ”¶è—
6. âœ… `app/api/user/favorites/route.ts` - APIæ”¯æŒ

---

## ğŸ¯ æœ€ç»ˆæ£€æŸ¥æ¸…å•

æ‰§è¡ŒSQLè„šæœ¬åï¼Œä¾æ¬¡æ£€æŸ¥ï¼š

- [ ] é¦–é¡µ"æ–‡åŒ–é€Ÿè¯»"æ˜¾ç¤ºæ–‡ç« ï¼ˆä¸æ˜¯"æš‚æ— æ–‡ç« "ï¼‰
- [ ] é¦–é¡µæ–‡ç« å¯ä»¥æ”¶è—
- [ ] åˆ—è¡¨é¡µæ–‡ç« å¯ä»¥æ”¶è—
- [ ] è¯¦æƒ…é¡µæ˜¾ç¤ºæ”¶è—æŒ‰é’®
- [ ] è¯¦æƒ…é¡µå¯ä»¥æ”¶è—/å–æ¶ˆæ”¶è—
- [ ] æ”¶è—é¡µ"æ–‡ç« "æ ‡ç­¾æ˜¾ç¤ºæ”¶è—åˆ—è¡¨
- [ ] æ§åˆ¶å°æ²¡æœ‰RLSé”™è¯¯
- [ ] Toastæç¤ºæ­£å¸¸æ˜¾ç¤º

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **æ‰§è¡ŒSQLè„šæœ¬** (3åˆ†é’Ÿ)
2. **åˆ·æ–°æµè§ˆå™¨** (Ctrl+Shift+R)
3. **æµ‹è¯•æ”¶è—åŠŸèƒ½** (5åˆ†é’Ÿ)
4. **éªŒè¯å®Œæ•´æµç¨‹** (5åˆ†é’Ÿ)

---

**æ€»ä¿®å¤æ—¶é—´**: 15åˆ†é’Ÿ  
**å…³é”®æ­¥éª¤**: âš ï¸ å¿…é¡»åœ¨ Supabase æ‰§è¡Œ RLS è„šæœ¬  
**çŠ¶æ€**: âœ… ä»£ç å®Œæˆ | â³ ç­‰å¾…æ‰§è¡Œ SQL  
**æˆåŠŸæ ‡å¿—**: é¦–é¡µæ˜¾ç¤ºæ–‡ç«  + æ”¶è—åŠŸèƒ½æ­£å¸¸ + æ— RLSé”™è¯¯
