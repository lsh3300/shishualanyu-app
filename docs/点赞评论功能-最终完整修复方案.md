# ğŸ¯ ç‚¹èµè¯„è®ºåŠŸèƒ½ - æœ€ç»ˆå®Œæ•´ä¿®å¤æ–¹æ¡ˆ

## ğŸ“Š é—®é¢˜æ¼”è¿›å†å²

### 1ï¸âƒ£ ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šå¤–é”®å¼•ç”¨é”™è¯¯ï¼ˆâœ… å·²ä¿®å¤ï¼‰
```
Error: Searched for a foreign key relationship between 'likes' and 'user_id' 
in the schema 'public', but no matches were found.
```
**åŸå› **ï¼šå¤–é”®å¼•ç”¨ `auth.users` è€Œä¸æ˜¯ `public.profiles`  
**ä¿®å¤**ï¼šæ‰§è¡Œ `fix-likes-comments-foreign-keys.sql`

---

### 2ï¸âƒ£ ç¬¬äºŒä¸ªé—®é¢˜ï¼šitem_id ç±»å‹ä¸åŒ¹é…ï¼ˆâœ… å·²ä¿®å¤ï¼‰
```
Error: invalid input syntax for type uuid: "1"
```
**åŸå› **ï¼šæ•°æ®åº“ `item_id` æ˜¯ UUIDï¼Œä½†è¯¾ç¨‹ ID æ˜¯å­—ç¬¦ä¸²  
**ä¿®å¤**ï¼šæ‰§è¡Œ `fix-likes-comments-item-id-type.sql`

---

### 3ï¸âƒ£ ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼šAPI è®¤è¯é€»è¾‘é”™è¯¯ï¼ˆâœ… å·²ä¿®å¤ï¼‰
```
Error: POST /api/likes 401 (Unauthorized)
Error: POST /api/comments 401 (Unauthorized)
```
**åŸå› **ï¼šAPI ä½¿ç”¨ `createServiceClient()` ä½†ç›´æ¥è°ƒç”¨ `supabase.auth.getUser()` æ²¡æœ‰ token  
**ä¿®å¤**ï¼š
- æ·»åŠ  `authenticateUser` å‡½æ•°åˆ° API Routes
- ä»è¯·æ±‚å¤´æå– `Authorization: Bearer <token>`
- ä½¿ç”¨ token éªŒè¯ç”¨æˆ·èº«ä»½

---

### 4ï¸âƒ£ ç¬¬å››ä¸ªé—®é¢˜ï¼šå‰ç«¯ç¼ºå°‘ Authorization Tokenï¼ˆâœ… å·²ä¿®å¤ï¼‰
```
Error: POST /api/likes 401 (Unauthorized)
Error: æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ
```
**åŸå› **ï¼šå‰ç«¯ Hooks å‘é€è¯·æ±‚æ—¶æ²¡æœ‰åŒ…å« `Authorization` header  
**ä¿®å¤**ï¼š
- åœ¨ `use-likes.ts` ä¸­æ·»åŠ  token
- åœ¨ `use-comments.ts` ä¸­æ·»åŠ  token
- æ‰€æœ‰ POST/PUT/DELETE è¯·æ±‚æ·»åŠ  `Authorization: Bearer ${token}`

---

### 5ï¸âƒ£ ç¬¬äº”ä¸ªé—®é¢˜ï¼šRLS ç­–ç•¥é˜»æ­¢æ“ä½œï¼ˆğŸ”§ å½“å‰é—®é¢˜ï¼‰
```
Error: new row violates row-level security policy for table "likes"
Error: new row violates row-level security policy for table "comments"
```
**åŸå› **ï¼šRLS ç­–ç•¥ä½¿ç”¨ `auth.uid()` ä½† Service Client æ— ç”¨æˆ·ä¸Šä¸‹æ–‡  
**ä¿®å¤**ï¼šä¿®æ”¹ RLS ç­–ç•¥ï¼Œå…è®¸ `service_role` æ‰§è¡Œæ“ä½œ

---

## ğŸš€ æœ€ç»ˆä¿®å¤æ­¥éª¤

### âœ… æ­¥éª¤ 1ï¼šä¿®å¤æ•°æ®åº“å¤–é”®å’Œç±»å‹ï¼ˆå·²å®Œæˆï¼‰

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ SQLï¼ˆå¦‚æœè¿˜æ²¡æ‰§è¡Œï¼‰</summary>

```sql
-- 1. ä¿®å¤å¤–é”®
BEGIN;
ALTER TABLE public.likes DROP CONSTRAINT IF EXISTS likes_user_id_fkey;
ALTER TABLE public.likes ADD CONSTRAINT likes_user_id_fkey 
FOREIGN KEY (user_id) REFERENCES public.profiles(id) ON DELETE CASCADE;

ALTER TABLE public.comments DROP CONSTRAINT IF EXISTS comments_user_id_fkey;
ALTER TABLE public.comments ADD CONSTRAINT comments_user_id_fkey 
FOREIGN KEY (user_id) REFERENCES public.profiles(id) ON DELETE CASCADE;

ALTER TABLE public.comment_likes DROP CONSTRAINT IF EXISTS comment_likes_user_id_fkey;
ALTER TABLE public.comment_likes ADD CONSTRAINT comment_likes_user_id_fkey 
FOREIGN KEY (user_id) REFERENCES public.profiles(id) ON DELETE CASCADE;
COMMIT;

-- 2. ä¿®å¤ item_id ç±»å‹
BEGIN;
ALTER TABLE public.likes ALTER COLUMN item_id TYPE TEXT;
ALTER TABLE public.comments ALTER COLUMN item_id TYPE TEXT;
COMMIT;
```

</details>

---

### âœ… æ­¥éª¤ 2ï¼šä¿®å¤ API Routes è®¤è¯ï¼ˆå·²å®Œæˆï¼‰

å·²ä¿®å¤æ–‡ä»¶ï¼š
- âœ… `app/api/likes/route.ts`
- âœ… `app/api/comments/route.ts`
- âœ… `app/api/comment-likes/route.ts`

æ‰€æœ‰ API ç°åœ¨éƒ½ä½¿ç”¨ `authenticateUser(request)` ä»è¯·æ±‚å¤´è·å– token å¹¶éªŒè¯ç”¨æˆ·ã€‚

---

### âœ… æ­¥éª¤ 3ï¼šä¿®å¤å‰ç«¯ Hooksï¼ˆå·²å®Œæˆï¼‰

å·²ä¿®å¤æ–‡ä»¶ï¼š
- âœ… `hooks/use-likes.ts`
- âœ… `hooks/use-comments.ts`

æ‰€æœ‰è¯·æ±‚ç°åœ¨éƒ½åŒ…å« `Authorization: Bearer ${token}` headerã€‚

---

### ğŸ”§ æ­¥éª¤ 4ï¼šä¿®å¤ RLS ç­–ç•¥ï¼ˆå½“å‰æ­¥éª¤ï¼‰â­

**åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œä»¥ä¸‹ SQL**ï¼š

```sql
BEGIN;

-- ====== 1. åˆ é™¤ç°æœ‰çš„ RLS ç­–ç•¥ ======

DROP POLICY IF EXISTS "Anyone can view likes" ON public.likes;
DROP POLICY IF EXISTS "Users can insert own likes" ON public.likes;
DROP POLICY IF EXISTS "Users can delete own likes" ON public.likes;

DROP POLICY IF EXISTS "Anyone can view published comments" ON public.comments;
DROP POLICY IF EXISTS "Authenticated users can insert comments" ON public.comments;
DROP POLICY IF EXISTS "Users can update own comments" ON public.comments;
DROP POLICY IF EXISTS "Users can delete own comments" ON public.comments;

DROP POLICY IF EXISTS "Anyone can view comment likes" ON public.comment_likes;
DROP POLICY IF EXISTS "Users can insert own comment likes" ON public.comment_likes;
DROP POLICY IF EXISTS "Users can delete own comment likes" ON public.comment_likes;

-- ====== 2. åˆ›å»ºæ–°çš„ RLS ç­–ç•¥ ======

-- likes è¡¨
CREATE POLICY "Anyone can view likes"
  ON public.likes FOR SELECT USING (true);

CREATE POLICY "Authenticated users can insert likes"
  ON public.likes FOR INSERT
  WITH CHECK ((auth.uid() = user_id) OR (auth.jwt() ->> 'role' = 'service_role'));

CREATE POLICY "Users can delete own likes"
  ON public.likes FOR DELETE
  USING ((auth.uid() = user_id) OR (auth.jwt() ->> 'role' = 'service_role'));

-- comments è¡¨
CREATE POLICY "Anyone can view published comments"
  ON public.comments FOR SELECT USING (status = 'published');

CREATE POLICY "Authenticated users can insert comments"
  ON public.comments FOR INSERT
  WITH CHECK ((auth.uid() = user_id AND auth.uid() IS NOT NULL) OR (auth.jwt() ->> 'role' = 'service_role'));

CREATE POLICY "Users can update own comments"
  ON public.comments FOR UPDATE
  USING ((auth.uid() = user_id) OR (auth.jwt() ->> 'role' = 'service_role'))
  WITH CHECK ((auth.uid() = user_id) OR (auth.jwt() ->> 'role' = 'service_role'));

CREATE POLICY "Users can delete own comments"
  ON public.comments FOR DELETE
  USING ((auth.uid() = user_id) OR (auth.jwt() ->> 'role' = 'service_role'));

-- comment_likes è¡¨
CREATE POLICY "Anyone can view comment likes"
  ON public.comment_likes FOR SELECT USING (true);

CREATE POLICY "Authenticated users can insert comment likes"
  ON public.comment_likes FOR INSERT
  WITH CHECK ((auth.uid() = user_id) OR (auth.jwt() ->> 'role' = 'service_role'));

CREATE POLICY "Users can delete own comment likes"
  ON public.comment_likes FOR DELETE
  USING ((auth.uid() = user_id) OR (auth.jwt() ->> 'role' = 'service_role'));

COMMIT;
```

---

## âœ… æ‰§è¡Œåæµ‹è¯•

### æµ‹è¯•æ¸…å•

1. **ç¡®ä¿å·²ç™»å½•**
   - è®¿é—® http://localhost:3000/auth
   - ç™»å½•ä½ çš„è´¦å·

2. **æµ‹è¯•ç‚¹èµåŠŸèƒ½**
   - [ ] è®¿é—®è¯¾ç¨‹è¯¦æƒ…é¡µ
   - [ ] ç‚¹å‡»ç‚¹èµæŒ‰é’®
   - [ ] æŒ‰é’®å˜çº¢ï¼Œç‚¹èµæ•° +1
   - [ ] å†æ¬¡ç‚¹å‡»å–æ¶ˆç‚¹èµ
   - [ ] æµè§ˆå™¨æ§åˆ¶å°æ— é”™è¯¯

3. **æµ‹è¯•è¯„è®ºåŠŸèƒ½**
   - [ ] è¾“å…¥è¯„è®ºå†…å®¹
   - [ ] ç‚¹å‡»å‘å¸ƒ
   - [ ] è¯„è®ºç«‹å³æ˜¾ç¤º
   - [ ] å¯ä»¥ç¼–è¾‘è¯„è®º
   - [ ] å¯ä»¥åˆ é™¤è¯„è®º
   - [ ] å¯ä»¥å›å¤è¯„è®º
   - [ ] å¯ä»¥ç»™è¯„è®ºç‚¹èµ

4. **æ£€æŸ¥æ§åˆ¶å°**
   - [ ] æµè§ˆå™¨æ—  401 é”™è¯¯
   - [ ] æµè§ˆå™¨æ—  500 é”™è¯¯
   - [ ] æœåŠ¡å™¨ç»ˆç«¯æ—  RLS policy violation
   - [ ] æ‰€æœ‰ API è¿”å› 200/201

---

## ğŸ¯ é¢„æœŸç»“æœ

### âœ… æˆåŠŸæ ‡å¿—

**æµè§ˆå™¨æ§åˆ¶å°**ï¼š
```
âœ… POST http://localhost:3000/api/likes 200 (OK)
âœ… POST http://localhost:3000/api/comments 201 (Created)
âœ… Toast: "ç‚¹èµæˆåŠŸ"
âœ… Toast: "è¯„è®ºå‘å¸ƒæˆåŠŸ"
```

**æœåŠ¡å™¨ç»ˆç«¯**ï¼š
```
âœ… POST /api/likes 200 in 150ms
âœ… POST /api/comments 201 in 200ms
âœ… æ—  "new row violates row-level security policy" é”™è¯¯
âœ… æ—  42501 é”™è¯¯ç 
```

**UI è¡¨ç°**ï¼š
```
âœ… ç‚¹èµæŒ‰é’®æ­£å¸¸å·¥ä½œï¼Œé¢œè‰²æ­£ç¡®åˆ‡æ¢
âœ… ç‚¹èµæ•°å®æ—¶æ›´æ–°
âœ… è¯„è®ºç«‹å³æ˜¾ç¤ºåœ¨åˆ—è¡¨
âœ… å¯ä»¥ç¼–è¾‘ã€åˆ é™¤ã€å›å¤è¯„è®º
âœ… è¯„è®ºç‚¹èµåŠŸèƒ½æ­£å¸¸
```

---

## ğŸ“‹ å·²åˆ›å»ºçš„æ–‡æ¡£

### æ•°æ®åº“ä¿®å¤è„šæœ¬
- âœ… `supabase/fix-likes-comments-foreign-keys.sql` - å¤–é”®ä¿®å¤
- âœ… `supabase/fix-likes-comments-item-id-type.sql` - ç±»å‹ä¿®å¤
- âœ… `supabase/fix-likes-comments-rls.sql` - RLS ç­–ç•¥ä¿®å¤

### è¯´æ˜æ–‡æ¡£
- âœ… `ç‚¹èµè¯„è®ºåŠŸèƒ½-å®Œæ•´ä¿®å¤æ­¥éª¤.md` - æ•°æ®åº“ä¿®å¤æŒ‡å—
- âœ… `ç‚¹èµè¯„è®ºåŠŸèƒ½-è®¤è¯é—®é¢˜ä¿®å¤å®Œæˆ.md` - API è®¤è¯ä¿®å¤è¯´æ˜
- âœ… `ç‚¹èµè¯„è®ºåŠŸèƒ½-Tokenè®¤è¯ä¿®å¤å®Œæˆ.md` - å‰ç«¯ Token ä¿®å¤è¯´æ˜
- âœ… `ç‚¹èµè¯„è®ºåŠŸèƒ½-RLSç­–ç•¥ä¿®å¤æŒ‡å—.md` - RLS ç­–ç•¥ä¿®å¤è¯¦è§£
- âœ… `ç‚¹èµè¯„è®ºåŠŸèƒ½-æœ€ç»ˆå®Œæ•´ä¿®å¤æ–¹æ¡ˆ.md` - æœ¬æ–‡æ¡£

---

## ğŸ” æŠ€æœ¯æ€»ç»“

### é—®é¢˜æ ¹æº
æ•´ä¸ªé—®é¢˜é“¾çš„æ ¹æºæ˜¯**æ•°æ®åº“å’Œåº”ç”¨å±‚çš„è®¤è¯æœºåˆ¶ä¸åŒ¹é…**ï¼š

1. **æ•°æ®åº“å±‚**ï¼šRLS ç­–ç•¥ä½¿ç”¨ `auth.uid()` è¿›è¡Œè®¤è¯
2. **åº”ç”¨å±‚**ï¼šAPI ä½¿ç”¨ Service Clientï¼ˆservice_roleï¼‰æ“ä½œæ•°æ®åº“
3. **å†²çª**ï¼šService Client æ²¡æœ‰ç”¨æˆ·ä¼šè¯ï¼Œ`auth.uid()` è¿”å› NULL

### è§£å†³æ–¹æ¡ˆ
**åŒé‡è®¤è¯æœºåˆ¶**ï¼š

1. **åº”ç”¨å±‚**ï¼ˆAPI Routesï¼‰ï¼š
   ```typescript
   // éªŒè¯ç”¨æˆ· token
   const { user, error } = await authenticateUser(request)
   if (error || !user) return 401
   
   // ä½¿ç”¨éªŒè¯è¿‡çš„ user.id æ“ä½œæ•°æ®åº“
   await supabase.from('likes').insert({ user_id: user.id, ... })
   ```

2. **æ•°æ®åº“å±‚**ï¼ˆRLS ç­–ç•¥ï¼‰ï¼š
   ```sql
   -- å…è®¸ä¸¤ç§è®¤è¯æ–¹å¼
   WITH CHECK (
     (auth.uid() = user_id)                        -- å®¢æˆ·ç«¯ç›´è¿
     OR 
     (auth.jwt() ->> 'role' = 'service_role')      -- API Server
   )
   ```

### å®‰å…¨æ€§ä¿éšœ

1. **API å±‚éªŒè¯**ï¼š
   - Token å¿…é¡»æœ‰æ•ˆ
   - ç”¨æˆ·å¿…é¡»å­˜åœ¨
   - user_id å¿…é¡»åŒ¹é…

2. **Service Role Key ä¿æŠ¤**ï¼š
   - åªå­˜åœ¨æœåŠ¡å™¨ç«¯ `.env.local`
   - å®¢æˆ·ç«¯æ— æ³•è®¿é—®
   - åªæœ‰å¯ä¿¡çš„ API å¯ä»¥ä½¿ç”¨

3. **RLS ç­–ç•¥æ£€æŸ¥**ï¼š
   - éªŒè¯ JWT role ä¸º service_role
   - ç¡®ä¿æ“ä½œæ¥è‡ªå¯ä¿¡æº

---

## ğŸŠ æœ€ç»ˆçŠ¶æ€

æ‰§è¡Œå®Œ RLS ä¿®å¤ SQL åï¼Œæ•´ä¸ªç‚¹èµè¯„è®ºåŠŸèƒ½å°†**å®Œå…¨æ­£å¸¸è¿è¡Œ**ï¼š

### âœ… å·²ä¿®å¤çš„é—®é¢˜
1. âœ… æ•°æ®åº“å¤–é”®å¼•ç”¨
2. âœ… item_id ç±»å‹ä¸åŒ¹é…
3. âœ… API è®¤è¯é€»è¾‘
4. âœ… å‰ç«¯ Token ä¼ é€’
5. âœ… RLS ç­–ç•¥é™åˆ¶

### âœ… å®Œæ•´åŠŸèƒ½
- âœ… ç‚¹èµ/å–æ¶ˆç‚¹èµ
- âœ… å‘å¸ƒè¯„è®º
- âœ… ç¼–è¾‘è¯„è®º
- âœ… åˆ é™¤è¯„è®º
- âœ… å›å¤è¯„è®º
- âœ… è¯„è®ºç‚¹èµ
- âœ… å®æ—¶æ•°æ®æ›´æ–°
- âœ… ä¼˜åŒ–çš„ UI äº¤äº’
- âœ… Toast é€šçŸ¥
- âœ… é”™è¯¯å¤„ç†

---

## ğŸš€ ç«‹å³è¡ŒåŠ¨

### åªéœ€æ‰§è¡Œ 1 ä¸ª SQL è„šæœ¬ï¼

1. **è®¿é—® Supabase Dashboard** â†’ SQL Editor
2. **å¤åˆ¶ä¸Šé¢çš„ RLS ä¿®å¤ SQL**
3. **ç‚¹å‡» Run**
4. **å®Œæˆï¼** ğŸ‰

**æ— éœ€é‡å¯æœåŠ¡å™¨ï¼Œæ— éœ€é‡æ–°ç™»å½•ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ï¼**

æ‰§è¡Œ SQL åï¼Œç«‹å³åˆ·æ–°æµè§ˆå™¨é¡µé¢ï¼Œæ‰€æœ‰åŠŸèƒ½å°†å®Œç¾è¿è¡Œï¼

---

**ç°åœ¨ç«‹å³æ‰§è¡Œ SQL è„šæœ¬ï¼** ğŸ¯

é—®é¢˜å°†å½»åº•è§£å†³ï¼Œä½ å°†æ‹¥æœ‰ä¸€ä¸ªå®Œæ•´ã€å®‰å…¨ã€é«˜æ€§èƒ½çš„ç‚¹èµè¯„è®ºç³»ç»Ÿï¼
