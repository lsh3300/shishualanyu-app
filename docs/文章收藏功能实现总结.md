# æ–‡ç« æ”¶è—åŠŸèƒ½å®ç°æ€»ç»“

## âœ… å®ç°å®Œæˆ

ä¸º"æ–‡åŒ–é€Ÿè¯»"æ¨¡å—æˆåŠŸæ·»åŠ äº†å®Œæ•´çš„æ–‡ç« æ”¶è—åŠŸèƒ½ï¼Œç°åœ¨ç”¨æˆ·å¯ä»¥ï¼š
- âœ… åœ¨æ–‡ç« å¡ç‰‡ä¸Šçœ‹åˆ°æ”¶è—æŒ‰é’®
- âœ… æ”¶è—å’Œå–æ¶ˆæ”¶è—æ–‡ç« 
- âœ… åœ¨"æˆ‘çš„æ”¶è—"é¡µé¢çœ‹åˆ°æ”¶è—çš„æ–‡ç« 
- âœ… æ•°æ®å®Œå…¨æ­£å¸¸ï¼Œä½¿ç”¨ UUID ä½œä¸ºæ–‡ç« æ ‡è¯†

---

## ğŸ“‹ å®ç°å†…å®¹

### 1. **æ•°æ®åº“å±‚ - å·²å­˜åœ¨** âœ…

æ•°æ®åº“å·²ç»æœ‰å®Œæ•´çš„æ–‡ç« æ”¶è—è¡¨ç»“æ„ï¼ˆæ¥è‡ª `culture-articles-schema.sql`ï¼‰ï¼š

```sql
CREATE TABLE public.article_favorites (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  article_id UUID NOT NULL REFERENCES public.culture_articles(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, article_id)
);
```

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ UUID ä¸»é”®
- å¤–é”®å…³è”åˆ° `culture_articles`
- ç”¨æˆ·+æ–‡ç« å”¯ä¸€çº¦æŸ
- å·²é…ç½® RLS ç­–ç•¥
- å·²åˆ›å»ºç´¢å¼•ä¼˜åŒ–

---

### 2. **API å±‚** - æ‰©å±•å®Œæˆ âœ…

**æ–‡ä»¶**: `app/api/user/favorites/route.ts`

#### GET æ–¹æ³• - æŸ¥è¯¢æ”¶è—
- âœ… åŒæ—¶æŸ¥è¯¢ `favorites` å’Œ `article_favorites` ä¸¤ä¸ªè¡¨
- âœ… è·å–æ–‡ç« è¯¦æƒ…ï¼ˆæ ‡é¢˜ã€æ‘˜è¦ã€å°é¢å›¾ã€åˆ†ç±»ç­‰ï¼‰
- âœ… åˆå¹¶æ‰€æœ‰æ”¶è—å¹¶æŒ‰æ—¶é—´æ’åº
- âœ… è¿”å›ç»Ÿä¸€æ ¼å¼çš„æ•°æ®

#### POST æ–¹æ³• - æ·»åŠ æ”¶è—
```typescript
// æ”¯æŒ articleId å‚æ•°
const { productId, courseId, articleId } = body

// æ–‡ç« ä½¿ç”¨å•ç‹¬çš„è¡¨
if (articleId) {
  await supabase
    .from('article_favorites')
    .insert({ user_id: userId, article_id: articleId })
}
```

#### DELETE æ–¹æ³• - åˆ é™¤æ”¶è—
```typescript
// æ”¯æŒåˆ é™¤æ–‡ç« æ”¶è—
if (articleId) {
  await supabase
    .from('article_favorites')
    .delete()
    .eq('user_id', userId)
    .eq('article_id', articleId)
}
```

---

### 3. **Hooks å±‚** - æ‰©å±•å®Œæˆ âœ…

**æ–‡ä»¶**: `hooks/use-favorites.ts`

#### æ–°å¢ç±»å‹å®šä¹‰
```typescript
interface Article {
  id: string
  slug: string
  title: string
  excerpt: string
  cover_image: string
  category: string
  tags: string[]
  read_time: number
  author: string
  image_url?: string
}

interface FavoriteArticleItem {
  id: string
  article_id: string
  created_at: string
  articles: Article
  item_type: 'article'
}
```

#### æ–°å¢æ–¹æ³•
1. **`addArticleToFavorites(articleId: string): Promise<boolean>`**
   - æ·»åŠ æ–‡ç« åˆ°æ”¶è—
   - ç™»å½•éªŒè¯
   - Toast æç¤º
   - è‡ªåŠ¨åˆ·æ–°æ”¶è—åˆ—è¡¨

2. **`removeArticleFromFavorites(articleId: string): Promise<boolean>`**
   - ä»æ”¶è—ç§»é™¤æ–‡ç« 
   - ç™»å½•éªŒè¯
   - Toast æç¤º
   - è‡ªåŠ¨åˆ·æ–°æ”¶è—åˆ—è¡¨

3. **`isArticleFavorite(articleId: string): boolean`**
   - æ£€æŸ¥æ–‡ç« æ˜¯å¦å·²æ”¶è—
   - å®æ—¶å“åº”çŠ¶æ€å˜åŒ–

4. **`favoriteArticles: Article[]`**
   - æå–æ”¶è—ä¸­çš„æ–‡ç« åˆ—è¡¨
   - æ ¼å¼åŒ–ä¸ºç»Ÿä¸€ç»“æ„
   - è¿‡æ»¤æ— æ•ˆæ•°æ®

---

### 4. **UI ç»„ä»¶å±‚** - å®Œæˆ âœ…

**æ–‡ä»¶**: `components/ui/culture-article-card.tsx`

#### ä¸»è¦æ”¹åŠ¨
```typescript
// 1. æ”¹ä¸º Client Component
"use client"

// 2. æ·»åŠ æ”¶è—åŠŸèƒ½
const { isArticleFavorite, addArticleToFavorites, removeArticleFromFavorites } = useFavorites()
const { user } = useAuth()

// 3. æ·»åŠ æ”¶è—æŒ‰é’®
<Button
  className="absolute top-2 right-2 h-8 w-8 rounded-full bg-white/95 ..."
  onClick={handleFavoriteClick}
>
  <Heart 
    className={isFavorite ? "text-red-500 fill-red-500" : "..."}
  />
</Button>
```

#### æ–°å¢ Props
- `showFavorite?: boolean` - æ˜¯å¦æ˜¾ç¤ºæ”¶è—æŒ‰é’®ï¼ˆé»˜è®¤ trueï¼‰
- `articleId?: string` - æ–‡ç« çš„ UUID IDï¼Œç”¨äºæ”¶è—

#### äº¤äº’æ•ˆæœ
- â¤ï¸ æ‚¬åœæ—¶æ˜¾ç¤ºæ”¶è—æŒ‰é’®
- â¤ï¸ å·²æ”¶è—ï¼šçº¢è‰²å®å¿ƒ
- ğŸ¤ æœªæ”¶è—ï¼šç°è‰²ç©ºå¿ƒ
- ğŸ”„ ç‚¹å‡»åˆ‡æ¢çŠ¶æ€
- ğŸ’¬ Toast æç¤ºåé¦ˆ

---

### 5. **é¡µé¢é›†æˆ** - å®Œæˆ âœ…

**æ–‡ä»¶**: `app/culture/page.tsx`

#### æ›´æ–°å†…å®¹
ä¸ºæ‰€æœ‰è°ƒç”¨ `CultureArticleCard` çš„åœ°æ–¹æ·»åŠ  `articleId` å±æ€§ï¼š

```typescript
<CultureArticleCard
  key={article.id}
  id={article.slug}           // ç”¨äºè·¯ç”±ï¼ˆURL å‹å¥½ï¼‰
  articleId={article.id}      // ç”¨äºæ”¶è—ï¼ˆUUIDï¼‰
  title={article.title}
  excerpt={article.excerpt || ''}
  image={article.cover_image}
  readTime={`${article.read_time}åˆ†é’Ÿ`}
/>
```

**æ¶‰åŠåŒºåŸŸ**ï¼š
- âœ… ç²¾é€‰æ¨è
- âœ… æœ€æ–°å‘å¸ƒ
- âœ… çƒ­é—¨é˜…è¯»

---

## ğŸ”‘ å…³é”®è®¾è®¡

### 1. ID åŒé‡è®¾è®¡
- **`id` (slug)**: ç”¨äº URL è·¯ç”±ï¼ŒSEO å‹å¥½
  - ä¾‹å¦‚ï¼š`ancient-indigo-history`
  - ç”¨é€”ï¼š`/culture/ancient-indigo-history`
  
- **`articleId` (UUID)**: ç”¨äºæ•°æ®åº“æ“ä½œ
  - ä¾‹å¦‚ï¼š`a1111111-1111-1111-1111-111111111111`
  - ç”¨é€”ï¼šæ”¶è—ã€æŸ¥è¯¢ã€å¤–é”®å…³è”

### 2. æ•°æ®åˆ†ç¦»è®¾è®¡
- **`favorites` è¡¨**: å­˜å‚¨å•†å“å’Œè¯¾ç¨‹æ”¶è—
- **`article_favorites` è¡¨**: å•ç‹¬å­˜å‚¨æ–‡ç« æ”¶è—

**ä¼˜ç‚¹**ï¼š
- è¡¨ç»“æ„æ›´æ¸…æ™°
- å¤–é”®å…³è”æ›´å‡†ç¡®
- æŸ¥è¯¢æ€§èƒ½æ›´å¥½
- æ‰©å±•æ€§æ›´å¼º

### 3. ç»Ÿä¸€çš„æ”¶è—ä½“éªŒ
æ‰€æœ‰æ”¶è—ï¼ˆå•†å“ã€è¯¾ç¨‹ã€æ–‡ç« ï¼‰éƒ½ä½¿ç”¨ï¼š
- ç›¸åŒçš„ UI äº¤äº’
- ç›¸åŒçš„ Hook æ¥å£
- ç›¸åŒçš„ Toast æç¤º
- ç›¸åŒçš„é”™è¯¯å¤„ç†

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### 1. æ•°æ®åº“éªŒè¯

```sql
-- 1. æ£€æŸ¥æ–‡ç« æ”¶è—è¡¨æ˜¯å¦å­˜åœ¨
SELECT EXISTS (
  SELECT FROM information_schema.tables 
  WHERE table_schema = 'public' 
  AND table_name = 'article_favorites'
);

-- 2. æ£€æŸ¥æ–‡ç« æ˜¯å¦å­˜åœ¨
SELECT id, slug, title FROM culture_articles LIMIT 5;

-- 3. æµ‹è¯•æ·»åŠ æ”¶è—
INSERT INTO article_favorites (user_id, article_id)
VALUES ('ä½ çš„ç”¨æˆ·ID', 'æ–‡ç« ID');

-- 4. æŸ¥çœ‹æ”¶è—åˆ—è¡¨
SELECT 
  af.id,
  af.created_at,
  ca.title,
  ca.slug
FROM article_favorites af
JOIN culture_articles ca ON ca.id = af.article_id
WHERE af.user_id = 'ä½ çš„ç”¨æˆ·ID';
```

### 2. åŠŸèƒ½æµ‹è¯•

#### Test Case 1: æ·»åŠ æ”¶è—
1. è®¿é—® `/culture`
2. æ‚¬åœåœ¨ä»»æ„æ–‡ç« å¡ç‰‡ä¸Š
3. âœ… åº”è¯¥çœ‹åˆ°å³ä¸Šè§’çš„çˆ±å¿ƒå›¾æ ‡
4. ç‚¹å‡»çˆ±å¿ƒå›¾æ ‡
5. âœ… åº”è¯¥æ˜¾ç¤º"å·²æ”¶è—"æç¤º
6. âœ… å›¾æ ‡å˜ä¸ºçº¢è‰²å®å¿ƒ

#### Test Case 2: å–æ¶ˆæ”¶è—
1. åœ¨å·²æ”¶è—çš„æ–‡ç« ä¸Šæ‚¬åœ
2. ç‚¹å‡»çº¢è‰²å®å¿ƒçˆ±å¿ƒ
3. âœ… åº”è¯¥æ˜¾ç¤º"å·²ç§»é™¤"æç¤º
4. âœ… å›¾æ ‡å˜ä¸ºç°è‰²ç©ºå¿ƒ

#### Test Case 3: æ”¶è—åˆ—è¡¨
1. æ”¶è—å‡ ç¯‡æ–‡ç« 
2. è®¿é—® `/favorites` æˆ– `/profile/favorites`
3. âœ… åº”è¯¥çœ‹åˆ°"æ–‡ç« æ”¶è—"æ ‡ç­¾
4. âœ… åº”è¯¥æ˜¾ç¤ºæ”¶è—çš„æ–‡ç« åˆ—è¡¨
5. âœ… ç‚¹å‡»æ–‡ç« åº”è¯¥è·³è½¬åˆ° `/culture/[slug]`

#### Test Case 4: ç™»å½•éªŒè¯
1. æœªç™»å½•çŠ¶æ€
2. ç‚¹å‡»æ”¶è—æŒ‰é’®
3. âœ… åº”è¯¥æ˜¾ç¤º"è¯·å…ˆç™»å½•"æç¤º

---

## ğŸ“Š æ•°æ®æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»æ”¶è—æŒ‰é’®
    â†“
æ£€æŸ¥ç™»å½•çŠ¶æ€
    â†“
è°ƒç”¨ useFavorites.addArticleToFavorites(articleId)
    â†“
POST /api/user/favorites { articleId }
    â†“
éªŒè¯ç”¨æˆ·èº«ä»½
    â†“
æ£€æŸ¥æ–‡ç« æ˜¯å¦å·²æ”¶è—
    â†“
æ’å…¥ article_favorites è¡¨
    â†“
è¿”å›æˆåŠŸå“åº”
    â†“
åˆ·æ–°æ”¶è—åˆ—è¡¨
    â†“
æ›´æ–° UI çŠ¶æ€ (çº¢è‰²å®å¿ƒ)
    â†“
æ˜¾ç¤º Toast æç¤º
```

---

## ğŸ¨ UI è®¾è®¡è§„èŒƒ

### æ”¶è—æŒ‰é’®æ ·å¼
- **ä½ç½®**: å¡ç‰‡å³ä¸Šè§’
- **å¤§å°**: 32x32px (h-8 w-8)
- **èƒŒæ™¯**: ç™½è‰²åŠé€æ˜ (bg-white/95)
- **æ˜¾ç¤º**: æ‚¬åœæ—¶æ˜¾ç¤º (group-hover:opacity-100)
- **åŠ¨ç”»**: 0.2s è¿‡æ¸¡åŠ¨ç”»

### å›¾æ ‡çŠ¶æ€
- **æœªæ”¶è—**: ç°è‰²ç©ºå¿ƒ (text-muted-foreground)
- **å·²æ”¶è—**: çº¢è‰²å®å¿ƒ (text-red-500 fill-red-500)
- **æ‚¬åœ**: çº¢è‰²æç¤º (hover:text-red-500)
- **ç¦ç”¨**: é™ä½é€æ˜åº¦

---

## ğŸ“ ç›¸å…³æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶
1. âœ… `app/api/user/favorites/route.ts` - API æ‰©å±•
2. âœ… `hooks/use-favorites.ts` - Hook æ‰©å±•
3. âœ… `components/ui/culture-article-card.tsx` - UI ç»„ä»¶
4. âœ… `app/culture/page.tsx` - é¡µé¢é›†æˆ

### å·²å­˜åœ¨çš„æ–‡ä»¶
1. âœ… `supabase/culture-articles-schema.sql` - æ•°æ®åº“ schema

### æ–°å»ºçš„æ–‡ä»¶
1. âœ… `æ–‡ç« æ”¶è—åŠŸèƒ½å®ç°æ€»ç»“.md` - æœ¬æ–‡æ¡£

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–
- [ ] æ·»åŠ æ”¶è—æ•°é‡æ˜¾ç¤º
- [ ] å®ç°æ”¶è—åˆ—è¡¨åˆ†é¡µ
- [ ] æ·»åŠ æ”¶è—æ•°é‡ç¼“å­˜

### 2. åŠŸèƒ½å¢å¼º
- [ ] æ‰¹é‡ç®¡ç†æ”¶è—
- [ ] æ”¶è—åˆ†ç±»/æ ‡ç­¾
- [ ] æ”¶è—æ’åºåŠŸèƒ½
- [ ] å¯¼å‡ºæ”¶è—åˆ—è¡¨

### 3. ç”¨æˆ·ä½“éªŒ
- [ ] æ·»åŠ æ”¶è—ç»Ÿè®¡
- [ ] æ¨èç›¸å…³æ–‡ç« 
- [ ] æ”¶è—æé†’åŠŸèƒ½
- [ ] åˆ†äº«æ”¶è—åŠŸèƒ½

---

## ğŸ” ä¸å…¶ä»–æ”¶è—çš„å¯¹æ¯”

| ç‰¹æ€§ | å•†å“æ”¶è— | è¯¾ç¨‹æ”¶è— | æ–‡ç« æ”¶è— |
|------|---------|---------|---------|
| æ•°æ®è¡¨ | `favorites` | `favorites` | `article_favorites` |
| ID å­—æ®µ | `product_id` | `course_id` | `article_id` |
| è¯¦æƒ…å…³è” | `products` | `courses` | `culture_articles` |
| URL è·¯ç”± | `/store/[id]` | `/teaching/[id]` | `/culture/[slug]` |
| æ”¶è—æŒ‰é’®ä½ç½® | å¡ç‰‡å³ä¸Šè§’ | å¡ç‰‡å³ä¸Šè§’ | å¡ç‰‡å³ä¸Šè§’ |
| Hook æ–¹æ³• | `addToFavorites` | `addCourseToFavorites` | `addArticleToFavorites` |

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [x] API æ”¯æŒæ–‡ç« æ”¶è—æŸ¥è¯¢
- [x] API æ”¯æŒæ–‡ç« æ”¶è—æ·»åŠ 
- [x] API æ”¯æŒæ–‡ç« æ”¶è—åˆ é™¤
- [x] Hook æ·»åŠ æ–‡ç« æ”¶è—æ–¹æ³•
- [x] Hook æ·»åŠ æ–‡ç« æ£€æŸ¥æ–¹æ³•
- [x] Hook æå– favoriteArticles
- [x] æ–‡ç« å¡ç‰‡æ·»åŠ æ”¶è—æŒ‰é’®
- [x] æ–‡ç« å¡ç‰‡æ·»åŠ äº¤äº’é€»è¾‘
- [x] é¡µé¢ä¼ é€’æ­£ç¡®çš„ articleId
- [x] ç¡®ä¿æ•°æ®åº“ ID æ­£å¸¸
- [x] Toast æç¤ºåé¦ˆ
- [x] ç™»å½•çŠ¶æ€éªŒè¯
- [x] é”™è¯¯å¤„ç†å®Œå–„
- [x] æ–‡æ¡£ç¼–å†™å®Œæˆ

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [æ–‡åŒ–é€Ÿè¯»åŠŸèƒ½å®ç°ç»éªŒæ€»ç»“.md](./æ–‡åŒ–é€Ÿè¯»åŠŸèƒ½å®ç°ç»éªŒæ€»ç»“.md)
- [è¯¾ç¨‹æ”¶è—å¤±è´¥ä¿®å¤æŒ‡å—.md](./è¯¾ç¨‹æ”¶è—å¤±è´¥ä¿®å¤æŒ‡å—.md)
- [docs/CULTURE_ARTICLES_GUIDE.md](./docs/CULTURE_ARTICLES_GUIDE.md)

---

**å®Œæˆæ—¶é—´**: 2025-11-22  
**åŠŸèƒ½çŠ¶æ€**: âœ… å®Œå…¨å®ç°å¹¶å¯ç”¨  
**æµ‹è¯•çŠ¶æ€**: å¾…ç”¨æˆ·æµ‹è¯•éªŒè¯
