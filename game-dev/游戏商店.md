# 🏪 蓝染商店经营游戏设计

**创建日期**: 2025-11-30  
**设计理念**: 创作 + 经营 + 社交的蓝染商店模拟经营游戏

**当前进度**: 数据层 + 业务逻辑层完成 ✅（50%）

---

## 📊 开发进展

```
✅ 美术素材      100%
✅ 数据层        100%  
✅ 业务逻辑层    100%
⏳ API层         0%
⏳ UI组件层      0%
⏳ 集成测试      0%
```

**详细进展**: 查看 `SHOP_DEVELOPMENT_PROGRESS.md`

---

## 🎯 核心玩法

```
创作蓝染作品 → 放入背包 → 上架商店 → 等待购买/系统收购 → 获得金币 → 升级商店
      ↓                                    ↓
   获得经验                           逛别人商店
```

---

## 📋 系统设计

### 1. 创作工坊系统

#### 作品创作
```
创作流程:
1. 进入创作工坊
2. 自由创作蓝染作品
3. 完成 → 评分（4维度）
4. 获得经验值（不获得金币）
5. 选择：
   ├─ 保存到背包 ✅
   └─ 不保存（自动保留最近5次）
```

#### 背包仓库
```
背包容量:
├─ 初始容量: 20个作品
├─ 可扩容: 通过金币购买（+10个/次）
└─ 最大容量: 100个

自动保留:
├─ 即使不保存，也保留最近5次创作
├─ 可以从"最近创作"移到背包
└─ 超过5个自动删除最旧的
```

#### 作品属性
```typescript
作品包含:
├─ 图案数据（完整的patterns）
├─ 评分信息（总分、等级、各维度分数）
├─ 创作时间
├─ 状态: 背包中 | 上架中 | 已售出
├─ 定价（如果上架）
└─ 缩略图预览
```

---

### 2. 商店系统（核心玩法）

#### 商店场景设计

##### 场景元素
```
我的商店场景:
┌─────────────────────────────────────┐
│   🏪 [商店名称]的蓝染坊              │
│                                     │
│   [用户角色形象]                    │
│         👤                          │
│                                     │
│   展示区（画框）:                   │
│   ┌────┐ ┌────┐ ┌────┐            │
│   │作品│ │作品│ │作品│  ← 3-5个画框│
│   └────┘ └────┘ └────┘            │
│                                     │
│   [查看更多]  [上架管理]  [背包]    │
│                                     │
│   💰 今日收入: 120币                │
│   📦 在售作品: 8件                  │
└─────────────────────────────────────┘

背景:
├─ 卡通风格的店铺内景
├─ 温暖的灯光
├─ 木质货架和画框
└─ 蓝染主题装饰

NPC动画:
├─ 路过的顾客（随机出现）
├─ 停留观看作品
├─ 偶尔购买（触发动画）
└─ 购买成功时的特效
```

##### 角色系统
```
用户角色:
├─ 固定身体（染匠形象）
├─ 可换装部分:
│  ├─ 发型（5种）
│  ├─ 服装（初始：普通染匠服）
│  ├─ 配饰（帽子、围裙等）
│  └─ 表情动作
└─ 解锁方式: 等级、成就、金币购买

角色动作:
├─ 站立（基础）
├─ 整理作品
├─ 招呼顾客
└─ 欢庆（售出时）
```

#### 上架系统

##### 上架流程
```
上架作品:
1. 从背包选择作品
2. 设置价格（系统建议价格）
   ├─ 根据评分自动计算基础价
   ├─ 玩家可调整（50%-200%）
   └─ 价格影响购买概率
3. 确认上架
4. 作品出现在商店展示区

价格计算公式:
基础价 = 评分 × 系数
├─ SSS: 评分 × 15 (例: 95分 → 1425币)
├─ SS:  评分 × 10 (例: 90分 → 900币)
├─ S:   评分 × 7  (例: 85分 → 595币)
├─ A:   评分 × 5  (例: 80分 → 400币)
├─ B:   评分 × 3  (例: 70分 → 210币)
└─ C:   评分 × 1  (例: 60分 → 60币)

上架限制:
├─ 同时在售: 初始5个，可扩展至20个
├─ 上架费用: 免费
└─ 下架: 随时可下架回背包
```

##### 展示策略
```
商店展示优先级:
1. 画框展示（3-5个最重要位置）
   ├─ 显示最新上架
   ├─ 或评分最高
   └─ 玩家可手动调整

2. 更多作品（点击进入）
   ├─ 网格展示所有在售作品
   ├─ 可按价格/评分/时间排序
   └─ 点击查看详情
```

---

### 3. 交易系统

#### 玩家购买
```
购买流程:
1. 访客进入商店（浏览模式）
2. 看到展示的作品
3. 点击查看详情（评分、价格、预览）
4. 点击"购买"
5. 确认支付金币
6. 作品进入买家背包
7. 卖家获得金币（通知）

购买限制:
├─ 不能购买自己的作品
├─ 金币不足时无法购买
└─ 每个作品只能被购买一次
```

#### 系统收购
```
自动收购机制:
时间: 每天0:00（UTC+8）

规则:
├─ 检查所有上架超过24小时的作品
├─ 无人购买的作品 → 系统收购
├─ 收购价 = 定价 × 60%
└─ 金币自动到账

通知:
├─ 次日登录时提示昨日收购记录
└─ "系统收购了3件作品，获得180币"
```

#### 交易记录
```
记录内容:
┌──────────────────────────────────┐
│ 交易时间: 2025-11-30 14:30       │
│ 作品: [缩略图] 冬日雪境          │
│ 评分: S (87分)                   │
│ 售价: 609币                      │
│ 买家: @用户名 (玩家) / 系统      │
│ 实得: 609币 (玩家) / 365币(系统) │
└──────────────────────────────────┘

记录查询:
├─ 今日收入
├─ 本周收入
├─ 历史交易（最近50条）
└─ 最佳销售作品
```

---

### 4. 商店访问系统

#### 访问他人商店
```
访问方式:
├─ 从排行榜点击进入
├─ 从漂流河作品进入作者商店
├─ 随机逛商店（推荐）
└─ 搜索用户名

商店浏览:
┌─────────────────────────────────┐
│ 🏪 [TA的商店名]                 │
│                                 │
│ [主人角色]  Lv.15 高级染匠      │
│                                 │
│ 在售作品展示...                 │
│ [作品1] [作品2] [作品3]         │
│                                 │
│ [购买作品] [收藏商店] [返回]    │
└─────────────────────────────────┘

互动功能:
├─ 购买作品
├─ 收藏商店（快速访问）
├─ 点赞（免费，增加店铺热度）
└─ 查看店主资料
```

#### 推荐系统
```
商店推荐算法:
├─ 新开业商店（新玩家扶持）
├─ 热门商店（销量高）
├─ 评分高的商店（作品质量好）
├─ 价格实惠的商店
└─ 随机发现

每日推荐:
├─ 每天推荐5个商店
├─ 访问推荐商店 +5经验
└─ 首次购买 +10经验
```

---

### 5. 商店升级系统

#### 等级系统
```
商店等级:
├─ Lv 1-5:   学徒染匠
├─ Lv 6-10:  初级染匠
├─ Lv 11-20: 中级染匠
├─ Lv 21-30: 高级染匠
├─ Lv 31-50: 大师染匠
└─ Lv 51+:   传奇染匠

升级奖励:
├─ 背包容量 +5
├─ 上架位 +1
├─ 解锁新装扮
├─ 解锁商店装饰
└─ 特殊称号
```

#### 商店装饰
```
可升级部分:
├─ 店铺背景（5种主题）
│  ├─ 传统木屋
│  ├─ 现代工坊
│  ├─ 日式和风
│  ├─ 欧式复古
│  └─ 奇幻仙境
│
├─ 画框样式（10种）
│  ├─ 木质相框
│  ├─ 金色画框
│  ├─ 现代极简
│  └─ ...
│
├─ 灯光效果
│  ├─ 温暖黄光
│  ├─ 冷色白光
│  └─ 彩虹灯光
│
└─ 装饰物品
   ├─ 盆栽植物
   ├─ 蓝染工具展示
   └─ 特殊摆件

购买方式:
├─ 金币购买
├─ 成就解锁
└─ 限定活动获得
```

---

## 🎨 UI/UX 设计

### 主界面布局
```
游戏大厅 → [进入我的商店] [逛逛别人的店] [创作工坊]

我的商店:
┌─────────────────────────────────────────┐
│ 🏪 春日蓝染坊        Lv.12  💰 1,234币  │
├─────────────────────────────────────────┤
│                                         │
│         [商店场景 - 2D横版视角]         │
│                                         │
│    👤角色                               │
│   (动画)                                │
│                                         │
│  ┌─────┐  ┌─────┐  ┌─────┐            │
│  │ 作品 │  │ 作品 │  │ 作品 │            │
│  │ S级  │  │ A级  │  │ SS级 │            │
│  │ 580币│  │ 400币│  │ 890币│            │
│  └─────┘  └─────┘  └─────┘            │
│                                         │
│  💬 "欢迎光临！" (NPC路过)              │
│                                         │
├─────────────────────────────────────────┤
│ [背包] [上架管理] [商店装饰] [交易记录]  │
└─────────────────────────────────────────┘
```

### 关键页面

#### 1. 背包页面
```
┌──────────────────────────────┐
│ 📦 我的背包  (15/20)          │
├──────────────────────────────┤
│ [网格展示作品]                │
│                              │
│ ┌───┐ ┌───┐ ┌───┐ ┌───┐    │
│ │作品│ │作品│ │作品│ │空位│    │
│ │ S │ │ A │ │SSS│ │   │    │
│ └───┘ └───┘ └───┘ └───┘    │
│                              │
│ 点击作品:                    │
│ ├─ 查看详情                  │
│ ├─ 上架出售                  │
│ └─ 删除                      │
│                              │
│ [最近创作(5)] [扩容背包]      │
└──────────────────────────────┘
```

#### 2. 上架管理
```
┌──────────────────────────────┐
│ 📋 上架管理  (5/8)            │
├──────────────────────────────┤
│ 在售作品:                    │
│                              │
│ ┌─────────────────────┐      │
│ │ [预览] 星河璀璨      │ NEW  │
│ │ 评分: S (88)        │      │
│ │ 售价: 616币         │      │
│ │ 上架: 2小时前       │      │
│ │ [调价] [下架]       │      │
│ └─────────────────────┘      │
│                              │
│ [从背包上架新作品]            │
└──────────────────────────────┘
```

#### 3. 访问他人商店
```
┌──────────────────────────────┐
│ 🏪 [店名]  店主: @用户名      │
│ Lv.15 高级染匠  ⭐⭐⭐⭐⭐   │
├──────────────────────────────┤
│ [店铺场景 - 只读模式]        │
│                              │
│ 展示作品可点击查看详情:      │
│ ┌───────────────┐            │
│ │ [作品预览]     │            │
│ │ 冬日雪境       │            │
│ │ S级 (87分)     │            │
│ │ 售价: 609币    │            │
│ │ [购买] [详情]  │            │
│ └───────────────┘            │
│                              │
│ [❤️收藏商店] [👍点赞] [返回] │
└──────────────────────────────┘
```

---

## 🎮 游戏循环

### 日常玩法
```
每日流程:
1. 登录 → 查看昨日收入（系统收购）
2. 整理商店 → 上架新作品/调整价格
3. 创作2-3个新作品（获得经验）
4. 逛别人商店 → 购买喜欢的作品
5. 查看交易记录 → 统计收入
6. 升级商店装饰

周循环:
├─ 周一: 新作品周（创作奖励翻倍）
├─ 周三: 促销日（系统收购价+20%）
├─ 周五: 社交日（访问商店经验+50%）
└─ 周末: 限时主题挑战
```

### 长期目标
```
成长路线:
1. 新手期 (Lv 1-10)
   ├─ 熟悉创作
   ├─ 积累作品
   └─ 学习定价

2. 成长期 (Lv 11-30)
   ├─ 提升作品质量
   ├─ 扩展商店
   └─ 建立客户群

3. 成熟期 (Lv 31-50)
   ├─ 打造爆款作品
   ├─ 商店装饰豪华
   └─ 成为知名店铺

4. 传奇期 (Lv 51+)
   ├─ 限定装扮
   ├─ 排行榜前列
   └─ 社区影响力
```

---

## 🎨 美术素材需求

### 1. 商店场景背景
```
需求:
├─ 尺寸: 1920×1080 (横版)
├─ 风格: 卡通动漫、温馨
├─ 视角: 2D横版（类似游戏《胡闹厨房》视角）
├─ 内容:
│  ├─ 木质店铺内景
│  ├─ 3-5个画框位置（留空白）
│  ├─ 货架、柜台
│  ├─ 蓝染主题装饰（靛蓝色调）
│  ├─ 温暖灯光效果
│  └─ 窗户（可见外景）
└─ 变体: 5种不同主题（后期）

参考风格:
"卡通风格的日式蓝染工坊内景，温馨的木质装修，墙上有画框展示区域，
柔和的灯光，靛蓝色主色调，2D横版游戏视角"
```

### 2. 角色形象
```
需求:
├─ 尺寸: 约200×300像素
├─ 风格: Q版卡通
├─ 基础形象（固定）:
│  ├─ 染匠服装
│  ├─ 站立姿态
│  └─ 正面视角
│
├─ 可换装部分（图层分离）:
│  ├─ 发型（5种）
│  ├─ 服装颜色（5种）
│  ├─ 围裙/配饰（可选）
│  └─ 帽子（可选）
│
└─ 动作帧（可选，后期）:
   ├─ 待机动画（呼吸）
   ├─ 挥手（招呼）
   └─ 庆祝（售出时）

参考风格:
"Q版卡通染匠角色，身穿传统染匠服装，可爱风格，
正面站立姿态，适合2D横版游戏"
```

### 3. NPC顾客
```
需求:
├─ 3-5个不同顾客形象
├─ 简单造型即可
├─ 横向行走动画（2-3帧）
└─ 停留观看姿态

参考风格:
"卡通风格的顾客角色，简单设计，有行走动画"
```

### 4. UI元素
```
需求:
├─ 画框（5种款式）
│  ├─ 基础木框
│  ├─ 金色豪华框
│  └─ 现代极简框
│
├─ 装饰物品
│  ├─ 盆栽植物
│  ├─ 蓝染工具（染缸、布料）
│  └─ 小摆件
│
└─ 特效
   ├─ 购买成功动画（金币飞出）
   ├─ 上架提示（闪光）
   └─ 等级提升（光效）
```

---

## 💻 技术实现

### 数据库设计

#### 新增表
```sql
-- 背包仓库表
CREATE TABLE user_inventory (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users,
  cloth_id UUID REFERENCES cloths,
  slot_type TEXT, -- 'inventory' | 'recent'
  added_at TIMESTAMPTZ,
  sort_order INT
);

-- 商店表
CREATE TABLE user_shops (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users,
  shop_name TEXT,
  shop_level INT DEFAULT 1,
  theme TEXT DEFAULT 'traditional',
  character_customization JSONB,
  total_sales INT DEFAULT 0,
  created_at TIMESTAMPTZ
);

-- 上架作品表
CREATE TABLE shop_listings (
  id UUID PRIMARY KEY,
  shop_id UUID REFERENCES user_shops,
  cloth_id UUID REFERENCES cloths,
  price INT,
  base_price INT,
  listed_at TIMESTAMPTZ,
  status TEXT -- 'listed' | 'sold' | 'withdrawn'
);

-- 交易记录表
CREATE TABLE transactions (
  id UUID PRIMARY KEY,
  seller_id UUID REFERENCES auth.users,
  buyer_id UUID REFERENCES auth.users, -- NULL表示系统收购
  cloth_id UUID REFERENCES cloths,
  price INT,
  actual_price INT, -- 实际获得（系统收购时打折）
  transaction_type TEXT, -- 'player' | 'system'
  created_at TIMESTAMPTZ
);

-- 商店访问记录
CREATE TABLE shop_visits (
  id UUID PRIMARY KEY,
  visitor_id UUID REFERENCES auth.users,
  shop_id UUID REFERENCES user_shops,
  visited_at TIMESTAMPTZ
);

-- 商店收藏
CREATE TABLE shop_favorites (
  user_id UUID REFERENCES auth.users,
  shop_id UUID REFERENCES user_shops,
  created_at TIMESTAMPTZ,
  PRIMARY KEY (user_id, shop_id)
);
```

### API端点
```
背包系统:
├─ GET  /api/inventory - 获取背包
├─ POST /api/inventory/save - 保存作品
├─ DELETE /api/inventory/:id - 删除作品
└─ POST /api/inventory/expand - 扩容背包

商店系统:
├─ GET  /api/shop/my - 获取我的商店
├─ GET  /api/shop/:userId - 访问他人商店
├─ PUT  /api/shop/customize - 自定义商店
└─ GET  /api/shop/recommended - 推荐商店

上架系统:
├─ POST /api/listings/create - 上架作品
├─ PUT  /api/listings/:id/price - 调整价格
├─ DELETE /api/listings/:id - 下架作品
└─ GET  /api/listings/my - 我的上架作品

交易系统:
├─ POST /api/transactions/buy - 购买作品
├─ GET  /api/transactions/history - 交易记录
└─ CRON /api/transactions/auto-purchase - 系统收购（定时任务）
```

### 核心逻辑

#### 1. 自动收购定时任务
```typescript
// 每天0:00执行
async function autoPurchaseListings() {
  const listings = await getListingsOlderThan24Hours()
  
  for (const listing of listings) {
    const autoPurchasePrice = listing.price * 0.6
    
    await createTransaction({
      seller_id: listing.seller_id,
      buyer_id: null, // 系统收购
      cloth_id: listing.cloth_id,
      price: listing.price,
      actual_price: autoPurchasePrice,
      transaction_type: 'system'
    })
    
    await addCurrency(listing.seller_id, autoPurchasePrice)
    await updateListingStatus(listing.id, 'sold')
  }
}
```

#### 2. 价格建议算法
```typescript
function suggestPrice(score: ClothScore): number {
  const gradeMultipliers = {
    SSS: 15, SS: 10, S: 7,
    A: 5, B: 3, C: 1
  }
  
  const multiplier = gradeMultipliers[score.grade]
  const basePrice = score.total_score * multiplier
  
  return Math.round(basePrice)
}
```

---

## 🎯 实施计划

### Phase 1: 背包系统（1周）
- ✅ 数据库表设计
- ✅ 背包API
- ✅ 背包UI组件
- ✅ 保存/删除功能
- ✅ 最近创作记录

### Phase 2: 商店场景（2周）
- ✅ 商店数据模型
- ✅ 场景背景集成
- ✅ 角色系统
- ✅ 基础UI布局
- ✅ 上架功能

### Phase 3: 交易系统（1.5周）
- ✅ 上架/下架API
- ✅ 购买流程
- ✅ 系统收购定时任务
- ✅ 交易记录

### Phase 4: 社交功能（1周）
- ✅ 访问他人商店
- ✅ 推荐系统
- ✅ 收藏功能

### Phase 5: 装饰系统（1周）
- ✅ 角色换装
- ✅ 商店主题
- ✅ 装饰物品

---

## 📝 核心要点

1. **创作与经营分离** - 创作获经验，售卖获金币
2. **保底机制** - 系统收购确保作品有价值
3. **社交互动** - 真实玩家交易增加趣味
4. **视觉呈现** - 卡通风格，亲和力强
5. **成长系统** - 商店升级，持续目标

**让玩家在创作中成长，在经营中获利！** 🎨💰
