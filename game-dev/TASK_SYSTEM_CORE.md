# 🎯 任务系统核心文档

**状态**: 开发中 - 数据层完成  
**更新**: 2025-11-30

---

## ✅ 已完成

### 1. 返回键修复
- 游戏大厅添加返回首页按钮

### 2. 系统设计
- 完整游戏系统架构设计
- 任务/商店/材料库/社交系统规划
- 分6个Phase实施

### 3. 数据层
- ✅ 数据库表结构
  - `task_templates` - 任务模板
  - `user_task_progress` - 用户进度
  - `achievements` - 成就定义
  - `user_achievements` - 用户成就
- ✅ TypeScript类型定义
- ✅ RLS安全策略
- ✅ 初始任务数据

### 4. 业务逻辑层
- ✅ 任务检测服务（`taskDetection.ts`）
  - 创作类任务检测
  - 评分类任务检测
  - 对称性检测（垂直/水平/中心）
  - 色彩深度检测
  - 批量检测功能
- ✅ 奖励发放服务（`rewardService.ts`）
  - 经验和货币发放
  - 任务奖励领取
  - 成就进度更新
  - 批量更新支持

### 5. API层
- ✅ GET `/api/tasks` - 获取任务列表
- ✅ POST `/api/tasks/claim` - 领取奖励
- ✅ POST `/api/tasks/update-progress` - 更新进度

---

## 🎯 任务系统核心设计

### 三大类任务

#### 1. 创作挑战（主线）
```
新手系列:
├─ 第一次染色（创作1个作品）→ 50 EXP + 20币
├─ 掌握对称（使用对称构图）→ 80 EXP + 30币
├─ 色彩层次（使用3种深度）→ 100 EXP + 40币
├─ 复杂图案（使用5个图案）→ 120 EXP + 50币
└─ 大师之作（获得A级评分）→ 150 EXP + 60币

进阶系列:
├─ 冬日主题（使用雪花）→ 200 EXP + 80币
├─ 星空主题（星形+螺旋）→ 250 EXP + 100币
└─ 几何美学（纯几何图案）→ 300 EXP + 120币
```

#### 2. 每周限时
```
本周主题: "冬日雪境"
条件: 使用指定图案创作
目标: S级以上评分
奖励: 2倍经验 + 限定称号
```

#### 3. 成就系统
```
收藏成就:
├─ I: 解锁5种图案
├─ II: 解锁10种图案
└─ III: 解锁全部图案

创作成就:
├─ I: 创作10个作品
├─ II: 创作50个作品
└─ III: 创作100个作品

评分成就:
├─ 完美开局: 首次SSS评分
├─ 稳定发挥: 10次A级以上
└─ 大师级别: 50次S级以上
```

---

## 📊 数据结构

### 任务条件格式
```json
{
  "type": "create_cloth",
  "requirements": {
    "min_patterns": 5,
    "required_patterns": ["snowflake", "star"],
    "min_score": 80,
    "has_symmetry": true,
    "min_color_depths": 3
  }
}
```

### 进度跟踪
```
用户任务进度:
├─ progress: 当前进度（3/5）
├─ target: 目标进度（5）
├─ is_completed: 是否完成
└─ reward_claimed: 是否领取奖励
```

---

## 🔄 下一步

### Phase 2A - 任务系统（续）

#### 1. UI层（当前任务）
- [ ] 任务板页面组件（`TaskBoard.tsx`）
  - 任务列表展示
  - 分类筛选（新手/进阶/大师）
  - 进度显示
  
- [ ] 任务卡片组件（`TaskCard.tsx`）
  - 任务信息展示
  - 进度条
  - 奖励预览
  - 领取按钮
  
- [ ] 奖励弹窗组件（`RewardModal.tsx`）
  - 奖励动画
  - 经验/货币/物品展示
  - 升级提示

#### 2. 集成
- [ ] 在作品评分后调用更新进度API
- [ ] 在工坊显示任务提示
- [ ] 在大厅添加任务板入口
- [ ] 任务完成通知

#### 3. 测试验证
- [ ] 创建作品触发任务检测
- [ ] 对称性检测准确性
- [ ] 奖励正确发放
- [ ] 经验升级正常

---

## 💡 关键技术点

### 1. 任务检测逻辑
```typescript
function checkTaskCondition(cloth: Cloth, condition: TaskConditions): boolean {
  switch(condition.type) {
    case 'create_cloth':
      return checkPatternRequirements(cloth, condition.requirements)
    case 'achieve_score':
      return checkScoreRequirements(cloth.score, condition.requirements)
    // ...
  }
}
```

### 2. 进度自动更新
```typescript
// 作品创作后
await updateTaskProgress(userId, {
  'challenge_first_creation': { progress: 1 },
  'creation_count_10': { progress: user.total_cloths_created }
})
```

### 3. 奖励领取流程
```
1. 用户点击"领取奖励"
2. 检查任务是否完成且未领取
3. 发放奖励（经验、货币）
4. 标记为已领取
5. 触发升级检测
6. 显示奖励动画
```

---

## 🎨 UI设计要点

### 任务板布局
```
┌──────────────────────────────┐
│ 🎯 任务板                    │
├──────────────────────────────┤
│ [新手挑战] [进阶挑战] [成就] │
├──────────────────────────────┤
│                              │
│ ┌────────────────────┐       │
│ │ ❄️ 冬日主题        │ NEW   │
│ │ 使用雪花图案创作   │       │
│ │ ──────────────     │       │
│ │ 进度: 0/1          │       │
│ │ 奖励: 200 EXP + 80币│       │
│ │ [去创作]           │       │
│ └────────────────────┘       │
│                              │
│ ┌────────────────────┐       │
│ │ ✅ 第一次染色      │ 完成  │
│ │ 创作你的第一个作品 │       │
│ │ ──────────────     │       │
│ │ 进度: 1/1 ✓        │       │
│ │ 奖励: 50 EXP + 20币│       │
│ │ [领取奖励]         │       │
│ └────────────────────┘       │
│                              │
└──────────────────────────────┘
```

---

## 📝 核心要点

1. **渐进引导** - 从简单到复杂，层层递进
2. **即时反馈** - 任务完成立即显示，激励持续创作
3. **多样奖励** - 经验、货币、解锁物品
4. **成长可见** - 进度条、成就徽章、等级提升
5. **持续动力** - 总有下一个目标

**让用户在目标中成长，在成就中满足！** 🎯
