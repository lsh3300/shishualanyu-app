# ğŸ¯ è¾¹æ¡†å¯¼è‡´çš„ä½ç½®åç§»ä¿®å¤
## Border Offset Fix - 2025-11-30 15:45

---

## ğŸ› é—®é¢˜æè¿°

### ç—‡çŠ¶ï¼ˆå¦‚ç”¨æˆ·æˆªå›¾æ‰€ç¤ºï¼‰
- **é¼ æ ‡ä½ç½®**ï¼šç”»å¸ƒå·¦ä¸Šæ–¹ï¼ˆçº¦ 25%, 30%ï¼‰
- **å›¾æ¡ˆä½ç½®**ï¼šç”»å¸ƒä¸­ä¸‹æ–¹ï¼ˆçº¦ 50%, 65%ï¼‰
- **åç§»é‡**ï¼šå›ºå®šçš„ä½ç½®åç§»

### ç”¨æˆ·åé¦ˆ
> "é¼ æ ‡ä¸­å¿ƒä½ç½®ï¼ˆ0ï¼Œ0ï¼‰é‚£ä¹ˆå›¾æ¡ˆç”Ÿæˆçš„ä¸­å¿ƒä½ç½®å°±åœ¨ï¼ˆ1ï¼Œ-1ï¼‰"

**é—®é¢˜**ï¼šç‚¹å‡»ä½ç½®å’Œå›¾æ¡ˆç”Ÿæˆä½ç½®ä¸ä¸€è‡´ï¼

---

## ğŸ” æ ¹æœ¬åŸå› 

### è¾¹æ¡†å ç”¨ç©ºé—´

ç”»å¸ƒå®šä¹‰ï¼š
```typescript
<div
  ref={canvasRef}
  className="... border-4 border-gray-200"  // 4px è¾¹æ¡†ï¼
  style={{
    width: `${width}px`,   // 600px
    height: `${height}px`  // 600px
  }}
>
```

**å…³é”®é—®é¢˜**ï¼š
- `border-4` = 4px è¾¹æ¡†
- è¾¹æ¡†åœ¨å…ƒç´ çš„**å¤–å›´**ï¼Œä¸åœ¨å†…å®¹åŒºåŸŸ
- `getBoundingClientRect()` è¿”å›çš„å®½é«˜**åŒ…å«è¾¹æ¡†**
- ä½†å†…å®¹åŒºåŸŸå®é™…åªæœ‰ `600 - 8 = 592px`ï¼ˆå·¦å³å„ 4pxï¼‰

### åæ ‡è®¡ç®—é”™è¯¯

**ä¹‹å‰çš„ä»£ç **ï¼š
```typescript
const rect = canvas.getBoundingClientRect()
const x = ((e.clientX - rect.left) / rect.width) * 100  // âŒ é”™è¯¯ï¼
```

**é—®é¢˜åˆ†æ**ï¼š
```
rect.left = ç”»å¸ƒå¤–è¾¹ç¼˜ï¼ˆåŒ…å«å·¦è¾¹æ¡†ï¼‰
rect.width = æ€»å®½åº¦ï¼ˆåŒ…å«å·¦å³è¾¹æ¡†ï¼‰

å®é™…å†…å®¹åŒºåŸŸä» rect.left + 4px å¼€å§‹
å®é™…å†…å®¹å®½åº¦ = rect.width - 8px
```

**ç»“æœ**ï¼š
- ç‚¹å‡»ç”»å¸ƒå·¦ä¸Šè§’ï¼ˆè¾¹æ¡†å†…ä¾§ï¼‰
- `e.clientX - rect.left` = 4px
- `4 / 600 = 0.67%`ï¼ˆåº”è¯¥æ˜¯ 0%ï¼‰
- å¯¼è‡´å›¾æ¡ˆåå³

---

## âœ… è§£å†³æ–¹æ¡ˆ

### å…³é”®å±æ€§

**clientLeft / clientTop**ï¼š
- è¿”å›å·¦/ä¸Šè¾¹æ¡†çš„å®½åº¦
- `canvas.clientLeft` = 4pxï¼ˆå·¦è¾¹æ¡†ï¼‰
- `canvas.clientTop` = 4pxï¼ˆä¸Šè¾¹æ¡†ï¼‰

**clientWidth / clientHeight**ï¼š
- è¿”å›å†…å®¹åŒºåŸŸçš„å®½é«˜ï¼ˆä¸å«è¾¹æ¡†ï¼‰
- `canvas.clientWidth` = 592pxï¼ˆ600 - 8ï¼‰
- `canvas.clientHeight` = 592pxï¼ˆ600 - 8ï¼‰

### ä¿®å¤åçš„ä»£ç 

```typescript
// å¤„ç†ç”»å¸ƒç‚¹å‡»
const handleCanvasClick = (e: React.MouseEvent<HTMLDivElement>) => {
  const canvas = canvasRef.current
  if (!canvas) return
  
  const rect = canvas.getBoundingClientRect()
  
  // ğŸ”‘ å…³é”®ï¼šæ’é™¤è¾¹æ¡†
  const borderLeft = canvas.clientLeft  // 4px
  const borderTop = canvas.clientTop    // 4px
  
  // è®¡ç®—é¼ æ ‡ç›¸å¯¹äºå†…å®¹åŒºåŸŸçš„ä½ç½®
  const mouseX = e.clientX - rect.left - borderLeft  // âœ… æ­£ç¡®
  const mouseY = e.clientY - rect.top - borderTop
  
  // ä½¿ç”¨å†…å®¹åŒºåŸŸçš„å®½é«˜
  const contentWidth = canvas.clientWidth   // 592px
  const contentHeight = canvas.clientHeight // 592px
  
  // è®¡ç®—ç™¾åˆ†æ¯”
  const x = (mouseX / contentWidth) * 100   // âœ… å‡†ç¡®ï¼
  const y = (mouseY / contentHeight) * 100
  
  addPattern(externalSelectedPatternId, x, y)
}
```

### åŒæ ·ä¿®å¤æ‹–åŠ¨

```typescript
// å¤„ç†é¼ æ ‡ç§»åŠ¨ï¼ˆæ‹–åŠ¨ï¼‰
const handleMouseMove = (e: React.MouseEvent) => {
  if (!isDragging || !draggingPatternId) return
  
  const canvas = canvasRef.current
  if (!canvas) return
  
  const rect = canvas.getBoundingClientRect()
  
  // ğŸ”‘ åŒæ ·æ’é™¤è¾¹æ¡†
  const borderLeft = canvas.clientLeft
  const borderTop = canvas.clientTop
  
  const mouseX = e.clientX - rect.left - borderLeft
  const mouseY = e.clientY - rect.top - borderTop
  
  const contentWidth = canvas.clientWidth
  const contentHeight = canvas.clientHeight
  
  const newX = (mouseX / contentWidth) * 100   // âœ… å‡†ç¡®ï¼
  const newY = (mouseY / contentHeight) * 100
  
  // æ›´æ–°ä½ç½®...
}
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### Beforeï¼ˆä¿®å¤å‰ï¼‰

**ç‚¹å‡»ç”»å¸ƒè¾¹ç¼˜**ï¼š
```
é¼ æ ‡ä½ç½®: (4px, 4px) - è¾¹æ¡†å†…ä¾§
è®¡ç®—ç»“æœ: 4/600 = 0.67%, 4/600 = 0.67%
å›¾æ¡ˆä½ç½®: (0.67%, 0.67%) - åç§»äº† âŒ
```

**ç‚¹å‡»ç”»å¸ƒä¸­å¿ƒ**ï¼š
```
é¼ æ ‡ä½ç½®: (300px, 300px) - è¾¹æ¡†å¤–æµ‹é‡
å®é™…å†…å®¹ä¸­å¿ƒ: (296px, 296px)
è®¡ç®—ç»“æœ: 300/600 = 50%, 300/600 = 50%
å›¾æ¡ˆä½ç½®: (50%, 50%) - çœ‹èµ·æ¥å¯¹ä½†å®é™…åç§» âŒ
```

### Afterï¼ˆä¿®å¤åï¼‰

**ç‚¹å‡»ç”»å¸ƒè¾¹ç¼˜**ï¼š
```
é¼ æ ‡ä½ç½®: (4px, 4px) - è¾¹æ¡†å†…ä¾§
è®¡ç®—: (4-4)/592 = 0%, (4-4)/592 = 0%
å›¾æ¡ˆä½ç½®: (0%, 0%) - å®Œå…¨å‡†ç¡® âœ…
```

**ç‚¹å‡»ç”»å¸ƒä¸­å¿ƒ**ï¼š
```
é¼ æ ‡ä½ç½®: (300px, 300px)
è®¡ç®—: (300-4)/592 = 50%, (300-4)/592 = 50%
å›¾æ¡ˆä½ç½®: (50%, 50%) - å®Œå…¨å‡†ç¡® âœ…
```

---

## ğŸ¯ éªŒè¯æ–¹æ³•

### æµ‹è¯•æ­¥éª¤

1. **åˆ·æ–°é¡µé¢**
   ```
   Ctrl + Shift + R
   ```

2. **ç‚¹å‡»è¾¹ç¼˜æµ‹è¯•**
   ```
   ç‚¹å‡»ç”»å¸ƒå››ä¸ªè§’è½ï¼ˆè¾¹æ¡†å†…ä¾§ï¼‰
   éªŒè¯ï¼šå›¾æ¡ˆä¸­å¿ƒåœ¨ç‚¹å‡»ä½ç½® âœ…
   ```

3. **ç‚¹å‡»ä¸­å¿ƒæµ‹è¯•**
   ```
   ç‚¹å‡»ç”»å¸ƒæ­£ä¸­å¿ƒ
   éªŒè¯ï¼šå›¾æ¡ˆä¸­å¿ƒåœ¨ç”»å¸ƒä¸­å¿ƒ âœ…
   ```

4. **æ‹–åŠ¨æµ‹è¯•**
   ```
   æ‹–åŠ¨å›¾æ¡ˆåˆ°è¾¹ç¼˜å’Œä¸­å¿ƒ
   éªŒè¯ï¼šè·Ÿéšå‡†ç¡® âœ…
   ```

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### DOM å…ƒç´ çš„å°ºå¯¸å±æ€§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† offsetWidth (åŒ…å«è¾¹æ¡†+æ»šåŠ¨æ¡) â†’   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â† clientWidth (å†…å®¹+padding) â†’  â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚                             â”‚ â”‚ â”‚
â”‚ â”‚ â”‚        å†…å®¹åŒºåŸŸ              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚                             â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®å±æ€§**ï¼š
- `offsetWidth/Height` - æ€»å®½é«˜ï¼ˆå«è¾¹æ¡†ï¼‰
- `clientWidth/Height` - å†…å®¹å®½é«˜ï¼ˆä¸å«è¾¹æ¡†ï¼‰
- `clientLeft/Top` - å·¦/ä¸Šè¾¹æ¡†å®½åº¦
- `getBoundingClientRect()` - å±å¹•åæ ‡å’Œæ€»å°ºå¯¸

### ä¸ºä»€ä¹ˆä¹‹å‰çš„æ–¹æ³•æœ‰é—®é¢˜ï¼Ÿ

```typescript
// âŒ é”™è¯¯æ–¹æ³•
const x = ((e.clientX - rect.left) / rect.width) * 100

// rect.left æ˜¯è¾¹æ¡†å¤–è¾¹ç¼˜
// rect.width åŒ…å«è¾¹æ¡†å®½åº¦
// å¯¼è‡´ï¼šç‚¹å‡»è¾¹æ¡†å†…ä¾§æ—¶ï¼Œåæ ‡ â‰  0
```

```typescript
// âœ… æ­£ç¡®æ–¹æ³•
const x = ((e.clientX - rect.left - borderLeft) / clientWidth) * 100

// å…ˆå‡å»è¾¹æ¡†åç§»
// å†é™¤ä»¥å†…å®¹åŒºåŸŸå®½åº¦
// ç»“æœï¼šç‚¹å‡»è¾¹æ¡†å†…ä¾§æ—¶ï¼Œåæ ‡ = 0 âœ…
```

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### æ•™è®­

1. **è¾¹æ¡†ä¼šå½±å“åæ ‡è®¡ç®—**
   - ä¸èƒ½ç›´æ¥ä½¿ç”¨ `getBoundingClientRect()`
   - å¿…é¡»è€ƒè™‘ `clientLeft/clientTop`

2. **ä½¿ç”¨æ­£ç¡®çš„å°ºå¯¸å±æ€§**
   - å†…å®¹å®šä½ç”¨ `clientWidth/Height`
   - è¾¹æ¡†å®½åº¦ç”¨ `clientLeft/Top`

3. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ**
   - æ€»æ˜¯æµ‹è¯•ç”»å¸ƒè¾¹ç¼˜
   - è¾¹ç¼˜æš´éœ²æœ€æ˜æ˜¾çš„é—®é¢˜

### æœ€ä½³å®è·µ

**å¤„ç†ç‚¹å‡»åæ ‡æ—¶**ï¼š
```typescript
const canvas = element
const rect = canvas.getBoundingClientRect()

// 1. è·å–è¾¹æ¡†å®½åº¦
const borderX = canvas.clientLeft
const borderY = canvas.clientTop

// 2. è®¡ç®—ç›¸å¯¹å†…å®¹åŒºåŸŸçš„åæ ‡
const relativeX = e.clientX - rect.left - borderX
const relativeY = e.clientY - rect.top - borderY

// 3. ä½¿ç”¨å†…å®¹åŒºåŸŸå°ºå¯¸è®¡ç®—ç™¾åˆ†æ¯”
const percentX = (relativeX / canvas.clientWidth) * 100
const percentY = (relativeY / canvas.clientHeight) * 100
```

---

## ğŸ‰ æ€»ç»“

**é—®é¢˜**ï¼š
- 4px è¾¹æ¡†å¯¼è‡´åæ ‡è®¡ç®—åç§»

**è§£å†³**ï¼š
- ä½¿ç”¨ `clientLeft/Top` æ’é™¤è¾¹æ¡†
- ä½¿ç”¨ `clientWidth/Height` è·å–å†…å®¹åŒºåŸŸå¤§å°

**ç»“æœ**ï¼š
- âœ… ç‚¹å‡»ä½ç½® = å›¾æ¡ˆä¸­å¿ƒä½ç½®
- âœ… å®Œå…¨å‡†ç¡®ï¼Œæ— åç§»
- âœ… è¾¹ç¼˜å’Œä¸­å¿ƒéƒ½æ­£ç¡®

---

**ç°åœ¨é¼ æ ‡åœ¨å“ªé‡Œï¼Œå›¾æ¡ˆå°±åœ¨å“ªé‡Œï¼** ğŸ¯âœ¨
