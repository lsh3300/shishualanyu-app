# Day 2 实施计划 - 系统集成与测试
## 2025-12-01 (预计)

---

## 🎯 今日目标

**让游戏系统真正运转起来！**
- 测试数据库
- 集成评分系统到Canvas
- 打通完整的游戏循环
- 让用户体验到"这是一个游戏"

---

## 📋 任务清单

### 阶段1: 数据库测试 (2小时)

#### 任务1-1: 运行数据库迁移
```bash
优先级: P0 (最高)
预计时间: 30分钟

步骤:
1. 检查Supabase连接
2. 执行迁移文件: 20251130_game_system_phase1.sql
3. 验证表创建成功
   - player_profile
   - cloth_scores
4. 验证视图创建成功
   - leaderboard_by_level
   - leaderboard_by_score

验收标准:
✅ 所有表都创建成功
✅ 所有函数都创建成功
✅ RLS策略生效
✅ 无SQL错误
```

#### 任务1-2: 测试核心函数
```sql
优先级: P0
预计时间: 45分钟

测试用例:

1. 初始化玩家档案
   SELECT init_player_profile('test-user-id');
   预期: 创建档案成功

2. 计算等级经验
   SELECT calculate_exp_for_level(1);  -- 应返回 0
   SELECT calculate_exp_for_level(2);  -- 应返回 100
   SELECT calculate_exp_for_level(3);  -- 应返回 ~283

3. 添加经验值
   SELECT * FROM add_experience('test-user-id', 150);
   预期: 升到Lv2，获得50货币

4. 提交评分
   SELECT * FROM submit_cloth_score(
     'test-cloth-id',
     'test-user-id',
     85, 75, 80, 70
   );
   预期: 
   - 总分80 (A级)
   - 获得70经验，30货币
   - 可能升级

验收标准:
✅ 所有函数正常运行
✅ 升级逻辑正确
✅ 奖励计算准确
✅ 数据更新及时
```

#### 任务1-3: 测试API路由
```bash
优先级: P0
预计时间: 45分钟

测试步骤:
1. 启动开发服务器: npm run dev
2. 登录系统（创建/使用测试账号）
3. 测试评分API:
   POST http://localhost:3000/api/game/score
   Body: {
     "cloth_id": "test-id",
     "layers": [...]
   }
4. 检查响应数据
5. 检查数据库中的记录

验收标准:
✅ API返回正确的评分结果
✅ 数据库记录创建成功
✅ 玩家档案正确更新
✅ 实时订阅能收到更新
```

---

### 阶段2: Canvas集成 (3小时)

#### 任务2-1: 创建"完成创作"功能
```typescript
优先级: P0
预计时间: 1小时

文件: components/game/canvas/CanvasToolbar.tsx (新建)

功能:
- 添加"完成创作"按钮到Canvas底部
- 点击后:
  1. 保存Canvas数据
  2. 调用评分API
  3. 显示评分结果弹窗
  4. 更新玩家档案

设计:
┌─────────────────────────────────┐
│        Canvas 画布区域           │
│                                  │
│        ... 创作中 ...            │
│                                  │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│  [保存草稿]  [完成创作] ← 新增   │
└─────────────────────────────────┘

验收标准:
✅ 按钮样式美观，位置合理
✅ 点击后能正确获取layers数据
✅ 能成功调用评分API
✅ 错误处理完善
```

#### 任务2-2: 集成评分结果弹窗
```typescript
优先级: P0
预计时间: 1小时

文件: 修改 workshop/page.tsx 或创建新组件

功能:
- 使用已创建的 ScoreResultDialog 组件
- 在评分完成后自动显示
- 显示:
  - 4个维度分数（动画）
  - 总分和等级
  - 奖励信息
  - 升级提示（如果升级）

交互流程:
用户点击"完成创作"
  ↓
显示loading（提交中...）
  ↓
调用评分API
  ↓
显示评分结果弹窗
  ↓
用户点击"继续"
  ↓
返回游戏主页或继续创作

验收标准:
✅ 弹窗能正确显示评分数据
✅ 动画流畅
✅ 升级提示正确显示
✅ 关闭后状态正确更新
```

#### 任务2-3: 添加顶部状态栏
```typescript
优先级: P1
预计时间: 1小时

文件: components/game/core/GameStatusBar.tsx (新建)

功能:
- 全局顶部显示玩家信息
- 包含:
  - 等级 (Lv.X)
  - 经验进度条（小型）
  - 货币 (🪙 XXX)
- 样式:
  - 固定在顶部
  - 半透明背景
  - 不遮挡内容

设计:
┌───────────────────────────────────┐
│ Lv.5 ████░░ 70%    🪙 1,250      │ ← 状态栏
├───────────────────────────────────┤
│                                    │
│        页面内容区域                │
│                                    │

验收标准:
✅ 在所有游戏页面显示
✅ 数据实时更新
✅ 响应式设计
✅ 不影响页面布局
```

---

### 阶段3: 完整流程测试 (2小时)

#### 任务3-1: 新用户流程测试
```
优先级: P0
预计时间: 45分钟

测试流程:
1. 创建新的测试账号
2. 首次访问 /game/hub
   预期: 自动创建档案，显示Lv.1
3. 点击进入工坊
4. 创作一幅作品（随便画几笔）
5. 点击"完成创作"
6. 查看评分结果
   预期: 显示分数、等级、奖励
7. 返回Hub
   预期: 等级和货币已更新

检查点:
✅ 档案自动创建
✅ 初始数据正确 (Lv.1, 0 exp, 0 currency)
✅ 评分流程顺畅
✅ 奖励正确发放
✅ UI数据实时更新
```

#### 任务3-2: 升级流程测试
```
优先级: P0
预计时间: 45分钟

测试流程:
1. 使用测试账号
2. 多次完成创作，积累经验
3. 直到升级
4. 观察升级动画和提示
5. 检查升级奖励

检查点:
✅ 经验累加正确
✅ 升级阈值准确
✅ 升级动画触发
✅ 升级奖励发放（货币）
✅ 等级正确显示
```

#### 任务3-3: 边界情况测试
```
优先级: P1
预计时间: 30分钟

测试场景:
1. 无图层的空白Canvas
   - 能否完成？
   - 评分如何？
2. 网络错误
   - 评分API失败时的处理
3. 重复点击
   - 防止重复提交
4. 离线数据
   - 草稿保存
5. 多标签页
   - 数据同步

检查点:
✅ 错误提示友好
✅ 无崩溃
✅ 数据一致性
✅ 性能稳定
```

---

### 阶段4: 优化与打磨 (2小时)

#### 任务4-1: UI细节优化
```
优先级: P1
预计时间: 1小时

优化项:
1. 评分弹窗动画调优
   - 时序优化
   - 缓动函数调整
2. 状态栏视觉优化
   - 颜色搭配
   - 间距调整
3. 按钮反馈
   - hover效果
   - 点击反馈
4. Loading状态
   - 提交评分时的loading
5. 成功提示
   - Toast通知

验收标准:
✅ 所有交互都有反馈
✅ 动画流畅自然
✅ 视觉协调统一
✅ 无视觉bug
```

#### 任务4-2: 错误处理完善
```typescript
优先级: P1
预计时间: 45分钟

需要处理的错误:
1. 数据库连接失败
2. API请求超时
3. 评分计算错误
4. 权限不足
5. 数据验证失败

处理方式:
- 用户友好的错误提示
- 自动重试机制
- 降级方案
- 错误日志记录

验收标准:
✅ 所有错误都有提示
✅ 不会出现白屏
✅ 能gracefully降级
✅ 关键操作有重试
```

#### 任务4-3: 性能优化
```
优先级: P2
预计时间: 15分钟

优化点:
1. 组件懒加载
2. 图片优化
3. 数据缓存
4. 减少重复渲染

检查:
- Lighthouse性能评分
- 首屏加载时间
- 交互响应时间

验收标准:
✅ 首屏 < 2s
✅ 交互响应 < 100ms
✅ 无明显卡顿
✅ 移动端流畅
```

---

## 🎯 成功标准

### 必须完成 (P0)
- [x] 数据库迁移成功
- [ ] 核心函数测试通过
- [ ] Canvas集成完成
- [ ] 评分流程打通
- [ ] 完整循环可运行

### 应该完成 (P1)
- [ ] 顶部状态栏
- [ ] 错误处理完善
- [ ] UI细节优化
- [ ] 边界测试通过

### 可选完成 (P2)
- [ ] 性能优化
- [ ] 额外动画
- [ ] 更多测试用例

---

## 🔧 技术要点

### 数据库测试
```sql
-- 快速测试脚本
BEGIN;
  -- 1. 创建测试用户档案
  INSERT INTO player_profile (user_id, dye_house_name)
  VALUES ('test-user-001', '测试染坊')
  ON CONFLICT (user_id) DO NOTHING;

  -- 2. 测试添加经验
  SELECT * FROM add_experience('test-user-001', 150);

  -- 3. 测试提交评分
  INSERT INTO cloths (id, creator_id, status) 
  VALUES ('test-cloth-001', 'test-user-001', 'drifting');
  
  SELECT * FROM submit_cloth_score(
    'test-cloth-001',
    'test-user-001',
    85, 75, 80, 70
  );
  
  -- 4. 查看结果
  SELECT * FROM player_profile WHERE user_id = 'test-user-001';
  SELECT * FROM cloth_scores WHERE user_id = 'test-user-001';
ROLLBACK;  -- 或 COMMIT; 如果要保存
```

### Canvas集成关键代码
```typescript
// 在 workshop/page.tsx 中
const handleCompleteWork = async () => {
  try {
    setIsSubmitting(true)
    
    // 1. 获取Canvas数据
    const layers = getCanvasLayers() // 需要实现
    
    // 2. 调用评分API
    const response = await fetch('/api/game/score', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        cloth_id: clothId,
        layers: layers
      })
    })
    
    const result = await response.json()
    
    if (result.success) {
      // 3. 显示评分结果
      setScoreResult(result.data)
      setShowScoreDialog(true)
    }
  } catch (error) {
    console.error('提交失败:', error)
    toast.error('评分失败，请重试')
  } finally {
    setIsSubmitting(false)
  }
}
```

---

## 📊 进度追踪

### 实时更新
```
阶段1 (数据库测试):    ░░░░░░░░░░ 0%
阶段2 (Canvas集成):     ░░░░░░░░░░ 0%
阶段3 (完整测试):       ░░░░░░░░░░ 0%
阶段4 (优化打磨):       ░░░░░░░░░░ 0%

今日进度: ░░░░░░░░░░ 0%
```

### 预计时间分配
```
数据库测试:  2小时  ████░░░░░░ 
Canvas集成:  3小时  ██████░░░░
完整测试:    2小时  ████░░░░░░
优化打磨:    2小时  ████░░░░░░
──────────────────────────────
总计:        9小时  (1个工作日)
```

---

## 💡 风险预警

### 可能遇到的问题

#### 问题1: 数据库权限
```
症状: RLS策略导致无法插入数据
原因: 用户认证状态不正确
解决: 
  1. 检查 auth.uid() 是否正确
  2. 临时禁用RLS进行测试
  3. 调整策略条件
```

#### 问题2: Canvas数据格式
```
症状: 评分算法无法处理Canvas数据
原因: layers数据结构不匹配
解决:
  1. 添加数据转换层
  2. 验证数据格式
  3. 提供默认值
```

#### 问题3: 性能问题
```
症状: 评分计算耗时过长
原因: 算法复杂度高
解决:
  1. 异步计算
  2. 简化算法
  3. 添加缓存
```

---

## 🎉 完成标志

当你能够完成以下流程时，Day 2 即告成功：

```
1. 新用户访问 /game/hub
   → 看到 Lv.1, 0 exp, 0 币

2. 进入工坊创作
   → 随便画几笔

3. 点击"完成创作"
   → 看到评分弹窗
   → 显示4维度分数
   → 显示总分和等级
   → 显示奖励 (+经验 +货币)

4. 返回Hub
   → 看到经验增加
   → 看到货币增加
   → 进度条移动

5. 多次创作
   → 积累经验
   → 看到升级动画 🎉
   → 获得升级奖励

✨ 恭喜！游戏循环打通！
```

---

## 📝 注意事项

1. **先测试后集成**: 确保数据库功能正常再集成UI
2. **小步快跑**: 每完成一个功能就测试一次
3. **及时记录**: 遇到问题记录在WORK_PLAN.md
4. **保持备份**: 重要修改前先备份代码
5. **用户体验优先**: 确保交互流畅，反馈及时

---

**Day 2 开始时间**: 待定  
**预计完成时间**: 1个工作日  
**当前状态**: 📋 计划完成，等待执行
