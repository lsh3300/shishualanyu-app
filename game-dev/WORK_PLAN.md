# 游戏化改造工作计划
## Work Plan: Game Transformation

**创建时间**: 2025-11-30  
**项目阶段**: 从工具到游戏的转型  
**开发方式**: 迭代式开发，边做边调整

---

## 🎯 核心目标

**让用户在10分钟内感受到"这是一个游戏"**

### 关键体验点
1. ✅ 看到明确的等级和进度条
2. ✅ 有具体的任务要完成
3. ✅ 创作后立即获得评分反馈
4. ✅ 看到奖励（经验、货币、材料）
5. ✅ 感受到"收集"和"成长"的乐趣

---

## 📊 迭代计划

### Sprint 1: 建立游戏感（3-4天）
**目标**: 让现有的画布功能"游戏化"

**核心交付**:
- [ ] 玩家档案系统（等级、经验、货币显示）
- [ ] 简单的评分系统（创作完成后打分）
- [ ] 基础奖励系统（评分→经验+货币）
- [ ] 视觉反馈（升级动画、获得奖励动画）

**不做**:
- ❌ 复杂的材料收集
- ❌ 多模式工坊
- ❌ 市集和社交
- ❌ 漂流河重构

### Sprint 2: 增加目标系统（3-4天）
**目标**: 给玩家明确的短期目标

**核心交付**:
- [ ] NPC任务系统（3-5个简单任务）
- [ ] 任务追踪UI
- [ ] 任务奖励发放
- [ ] 每日任务机制

### Sprint 3: 收集与解锁（3-4天）
**目标**: 让玩家体验"收集"的乐趣

**核心交付**:
- [ ] 材料系统基础（10-15个材料）
- [ ] 材料解锁机制（等级+任务）
- [ ] 材料图鉴页面
- [ ] 使用材料的限制

### Sprint 4: 深化游戏循环（持续）
**目标**: 让玩家有理由每天回来

**核心交付**:
- [ ] 成就系统
- [ ] 每日签到
- [ ] 排行榜
- [ ] 更多内容...

---

## 🚀 Sprint 1 详细计划

### 第1天：数据库与API基础

#### 上午：数据库设计
```sql
任务清单：
✅ 创建 player_profile 表
✅ 创建 cloth_scores 表  
✅ 创建 RLS 策略
✅ 编写数据库迁移文件
✅ 测试迁移
```

#### 下午：核心API
```typescript
任务清单：
✅ GET /api/game/profile - 获取玩家档案
✅ POST /api/game/profile/init - 初始化档案
✅ POST /api/game/score - 提交作品评分
✅ RPC函数：add_exp, add_currency
```

**验收标准**:
- 新用户进入游戏自动创建档案
- 可以正确读取等级、经验、货币
- 评分后能正确增加经验和货币

---

### 第2天：评分系统实现

#### 上午：评分算法
```typescript
任务清单：
✅ 实现颜色匹配算法
✅ 实现纹样复杂度分析
✅ 实现创意指数计算（简化版）
✅ 总分计算与等级评定
✅ 单元测试
```

#### 下午：集成到Canvas
```typescript
任务清单：
✅ 修改 Canvas 保存逻辑
✅ 保存时触发评分
✅ 评分结果保存到数据库
✅ 触发奖励发放
```

**验收标准**:
- 创作完成后能看到4个维度的分数
- 根据分数自动获得奖励
- 分数合理（不会太高或太低）

---

### 第3天：玩家档案UI

#### 上午：染坊大厅原型
```typescript
任务清单：
✅ 创建 /game/hub 页面
✅ 玩家信息卡片（头像、昵称、等级）
✅ 经验进度条组件
✅ 货币显示组件
✅ 统计数据展示
```

#### 下午：导航整合
```typescript
任务清单：
✅ 修改 /drift 页面，添加Hub入口
✅ 添加"返回大厅"按钮
✅ 添加顶部状态栏（显示等级和货币）
✅ 路由优化
```

**验收标准**:
- 用户能清晰看到自己的等级和进度
- 进度条动画流畅
- 数据实时更新

---

### 第4天：奖励动画与反馈

#### 上午：评分结果页面
```typescript
任务清单：
✅ 创建评分结果弹窗
✅ 分数逐个显示动画
✅ 等级评定展示（SSS/SS/S/A/B）
✅ 奖励预览
```

#### 下午：升级动画
```typescript
任务清单：
✅ 升级特效（粒子、光效）
✅ 升级提示弹窗
✅ 解锁内容展示
✅ 音效准备（可选）
```

**验收标准**:
- 评分动画炫酷、有仪式感
- 升级时有明显的成就感
- 所有反馈即时、清晰

---

## 📝 每日工作日志

### 2025-11-30

#### 计划
- [x] 创建工作计划文档
- [x] 设计数据库结构
- [x] 实施数据库迁移
- [x] 创建类型定义
- [x] 实现核心 Hook
- [x] 实现评分算法
- [x] 创建UI组件

#### 完成工作
**Phase 1 核心系统已完成60%！**

✅ **数据库层 (100%)**
- 创建 `player_profile` 表（玩家档案）
- 创建 `cloth_scores` 表（评分记录）
- 实现 RLS 策略
- 编写核心函数：
  - `add_experience()` - 添加经验并处理升级
  - `add_currency()` - 货币管理
  - `submit_cloth_score()` - 提交评分并发放奖励
  - `init_player_profile()` - 初始化档案
- 创建排行榜视图

✅ **类型系统 (100%)**
- `types/game.types.ts` - 完整的类型定义
- 包含所有游戏系统的接口和类型

✅ **核心逻辑 (100%)**
- `hooks/game/use-player-profile.ts` - 玩家档案管理 Hook
- `lib/game/scoring/score-calculator.ts` - 评分算法
  - 颜色匹配算法
  - 纹样复杂度分析
  - 创意指数评估
  - 技法评分
  - 总分计算和等级判定

✅ **UI组件 (80%)**
- `PlayerStatsCard` - 玩家统计卡片（等级、经验、货币）
- `ScoreResultDialog` - 评分结果弹窗（带动画）
- `GameHubPage` - 游戏主界面（染坊大厅）

✅ **API路由 (100%)**
- `POST /api/game/score` - 提交评分
- `GET /api/game/score?cloth_id=xxx` - 查询评分

#### 技术亮点
1. **实时更新**: 使用 Supabase Realtime 订阅档案变化
2. **动画效果**: Framer Motion 实现流畅的UI动画
3. **评分算法**: 多维度评分系统（4个维度）
4. **等级系统**: 指数增长的经验需求公式
5. **数据库函数**: 使用 PostgreSQL 函数处理复杂逻辑

#### 遇到的问题及解决
**问题1**: 导入路径错误
- Supabase 客户端导入路径不正确
- 解决：使用 `getSupabaseClient` 代替 `createBrowserClient`

**问题2**: TypeScript 类型错误
- `payload` 参数隐式 any 类型
- 解决：显式添加 `any` 类型注解

**问题3**: cloths表不存在
- 游戏系统迁移引用了不存在的表
- 解决：创建独立迁移文件先创建 cloths 表

**问题4**: UUID格式错误
- 测试脚本使用字符串而非真实UUID
- 解决：使用 gen_random_uuid() 生成

**问题5**: 外键约束冲突
- player_profile 需要真实用户ID
- 解决：提供两种方案
  - 方案A: 使用现有用户（推荐）
  - 方案B: 临时禁用约束测试

#### 当前状态
- ✅ 数据库：已部署（待测试）
- ✅ 核心逻辑：已实现
- ✅ UI组件：已创建
- ⏳ 集成测试：待进行
- ⏳ Canvas集成：待实现

#### 明天计划
1. **上午**：测试数据库迁移
   - 运行 SQL 迁移
   - 测试所有函数
   - 验证 RLS 策略

2. **下午**：Canvas集成
   - 将评分系统集成到现有 Canvas
   - 添加"完成创作"按钮
   - 触发评分弹窗
   - 测试完整流程

3. **晚上**：优化和调试
   - UI细节打磨
   - 动画优化
   - 错误处理完善

---

## 🎨 设计决策记录

### 决策1: 从哪里开始？
**问题**: 是先做数据库，还是先做UI？

**分析**:
- 先做数据库：技术流程正确，但看不到效果
- 先做UI：能快速看到效果，但没有后端支持

**决定**: **数据库优先，但快速完成**
- 第1天完成所有数据库和API
- 第2天开始就能看到UI效果
- 这样既保证了技术基础，又能快速迭代

### 决策2: 评分系统的复杂度？
**问题**: 评分算法要做多复杂？

**分析**:
- 太简单：没有挑战性，玩家感觉不到差异
- 太复杂：开发慢，维护难，玩家看不懂

**决定**: **先简单，后优化**
- V1: 基于简单规则（图层数、颜色范围）
- V2: 加入AI评估创意度
- V3: 加入社区投票

### 决策3: 材料系统的实现方式？
**问题**: 材料是无限使用，还是消耗型？

**分析**:
- 无限使用：简单，不会卡关，但缺少策略性
- 消耗型：有策略性，但可能让玩家受挫

**决定**: **混合模式**
- 基础材料：无限使用（解锁后永久拥有）
- 稀有材料：消耗型（增加珍贵感）
- 特殊材料：限时/限量（促进活跃）

---

## 🔍 技术调研

### 需要研究的技术点

#### 1. Canvas评分算法
**问题**: 如何从Canvas数据中提取评分指标？

**调研方向**:
- [ ] 图像颜色分析算法
- [ ] 图层复杂度计算
- [ ] 相似度对比算法

**结论**: 待研究...

#### 2. 升级动画效果
**问题**: 如何实现炫酷的升级特效？

**调研方向**:
- [ ] Framer Motion高级动画
- [ ] Canvas粒子系统
- [ ] Lottie动画集成

**结论**: 待研究...

#### 3. 性能优化
**问题**: 大量动画和数据会不会卡顿？

**调研方向**:
- [ ] React性能优化最佳实践
- [ ] 数据缓存策略
- [ ] 动画性能优化

**结论**: 待研究...

---

## 📊 进度追踪

### 总体进度
```
Sprint 1: ████████░░ 80%  (目标: 2025-12-03) ✨ 接近完成
Sprint 2: ░░░░░░░░░░ 0%   (目标: 2025-12-07)
Sprint 3: ░░░░░░░░░░ 0%   (目标: 2025-12-11)
Sprint 4: ░░░░░░░░░░ 0%   (目标: 持续)

总进度:   ████████░░ 80%
```

### Sprint 1 任务板 (Day 1 完成，Day 2 规划)
```
已完成 (Done) - Day 1:
- [x] 工作计划制定
- [x] 游戏化分析文档
- [x] 技术实现方案
- [x] 数据库设计和迁移文件
- [x] 类型定义系统
- [x] 玩家档案 Hook
- [x] 评分算法实现
- [x] 玩家档案UI组件
- [x] 评分结果弹窗
- [x] 游戏主页（Hub）
- [x] 评分 API 路由
- [x] Day 2 详细计划
- [x] 数据库测试指南

已完成 (Done) - Day 2:
- [x] 数据库迁移测试 ✅
- [x] 顶部状态栏 ✅
- [x] 评分提交Hook ✅
- [x] 完成创作按钮 ✅
- [x] 评分弹窗集成 ✅
- [x] 游戏工坊页面 ✅
- [x] 类型系统完善 ✅
- [x] API路由完善 ✅
- [x] SVG图案库 ✅ (3个图案)
- [x] Canvas画布组件 ✅
- [x] 图案选择器 ✅
- [x] 拖放交互系统 ✅
- [x] 属性调整面板 ✅
- [x] 完整工坊组件集成 ✅

进行中 (In Progress) - Day 2:
- [x] Canvas原型测试 ✅
- [x] 修复图案位置偏移（第一次） ✅
- [x] 添加测试模式支持 ✅
- [x] 彻底修复拖放位置问题（原生事件） ✅
- [x] 修复边框导致的坐标偏移（精确对齐） ✅
- [x] 添加工具切换系统（选择/添加模式） ✅
- [x] 添加坐标调试输出 ✅
- [ ] 等待用户测试反馈和坐标调试信息

待办 (To Do) - 后续:
- [ ] 根据反馈优化Canvas
- [ ] 扩展图案库（5-10个）
- [ ] 升级动画优化
- [ ] 移动端优化
- [ ] 材料系统实现
```

---

## 💡 随时记录的想法

### 待实现的创新点
1. **动态难度调整**: 根据玩家水平自动调整任务难度
2. **AI导师系统**: NPC根据玩家作品给出建议
3. **作品演化**: 同一块布的不同版本形成"进化树"
4. **情感分析**: AI分析作品传达的情感
5. **季节活动**: 根据现实节气更新材料和任务

### 用户体验优化
1. **新手引导**: 用互动教程代替文字说明
2. **快捷操作**: 快捷键支持
3. **回放功能**: 记录创作过程，可回放
4. **分享优化**: 生成精美的分享卡片

### 技术债务记录
暂无（项目刚开始）

---

## 🎯 里程碑

### Milestone 1: 游戏感建立 ✅
**目标**: 用户能感受到"这是个游戏"
**预期**: 2025-12-03
**标准**:
- 有等级系统
- 有评分反馈
- 有奖励获得
- 有成长感

### Milestone 2: 目标系统完善
**目标**: 用户有明确的短期目标
**预期**: 2025-12-07
**标准**:
- 有NPC任务
- 有每日目标
- 有任务追踪
- 有完成成就感

### Milestone 3: 收集乐趣
**目标**: 用户享受收集的过程
**预期**: 2025-12-11
**标准**:
- 材料系统完整
- 图鉴有收集进度
- 解锁有仪式感
- 有策略性选择

### Milestone 4: 社交互动
**目标**: 用户与其他玩家互动
**预期**: 2025-12-18
**标准**:
- 排行榜
- 作品展示
- 市集交易
- 协作机制

---

## 🔄 迭代回顾

### Sprint 1 回顾（待完成）
**做得好的**:
- 待总结...

**需要改进的**:
- 待总结...

**下一步优化**:
- 待总结...

---

## 📞 沟通记录

### 2025-11-30 与用户讨论
**内容**: 
- 用户认可游戏化方向
- 要求一边做一边调整
- 强调深入思考，不要急于求成
- 允许创新和试错

**行动项**:
- [x] 创建工作计划文档
- [ ] 开始第一个Sprint

---

**文档状态**: 活跃维护  
**最后更新**: 2025-11-30  
**下次更新**: 每日更新进度
