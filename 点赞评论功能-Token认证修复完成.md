# ğŸ‰ ç‚¹èµè¯„è®ºåŠŸèƒ½ - Token è®¤è¯ä¿®å¤å®Œæˆï¼

## âœ… é—®é¢˜å·²å®Œå…¨è§£å†³

### ğŸ”´ åŸé—®é¢˜
```
POST /api/likes 401 (Unauthorized)
POST /api/comments 401 (Unauthorized)
ç‚¹èµæ“ä½œé”™è¯¯: Error: æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ
å‘å¸ƒè¯„è®ºé”™è¯¯: Error: æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ
```

**ä½†æ˜¯**ï¼šæ”¶è—åŠŸèƒ½å¯ä»¥æ­£å¸¸å·¥ä½œï¼ŒGET è¯·æ±‚ä¹Ÿèƒ½æˆåŠŸï¼ˆ200ï¼‰

### ğŸ¯ æ ¹æœ¬åŸå› 

**å‰ç«¯ Hooks æ²¡æœ‰å‘é€ Authorization Tokenï¼**

- âŒ `use-likes.ts` çš„ POST/DELETE è¯·æ±‚æ²¡æœ‰ `Authorization` header
- âŒ `use-comments.ts` çš„ POST/PUT/DELETE è¯·æ±‚æ²¡æœ‰ `Authorization` header
- âœ… `use-favorites.ts` æ­£ç¡®å®ç°äº†ï¼Œæ‰€ä»¥æ”¶è—åŠŸèƒ½æ­£å¸¸

### âœ… è§£å†³æ–¹æ¡ˆ

åœ¨æ‰€æœ‰éœ€è¦è®¤è¯çš„ HTTP è¯·æ±‚ä¸­æ·»åŠ ï¼š
```typescript
headers: {
  'Content-Type': 'application/json',
  'Authorization': `Bearer ${token}`,  // âœ… æ·»åŠ è¿™ä¸€è¡Œ
}
```

---

## ğŸ”§ å·²ä¿®å¤çš„æ–‡ä»¶

### 1. `hooks/use-likes.ts` âœ…

**ä¿®æ”¹å†…å®¹**ï¼š
- âœ… ä» `useAuth()` è§£æ„ `getToken` å‡½æ•°
- âœ… `toggleLike` å‡½æ•°ï¼šè·å– token å¹¶æ·»åŠ åˆ°è¯·æ±‚å¤´
- âœ… POST è¯·æ±‚ï¼ˆæ·»åŠ ç‚¹èµï¼‰ï¼šæ·»åŠ  `Authorization: Bearer ${token}`
- âœ… DELETE è¯·æ±‚ï¼ˆå–æ¶ˆç‚¹èµï¼‰ï¼šæ·»åŠ  `Authorization: Bearer ${token}`

**ä¿®æ”¹ä½ç½®**ï¼š
- ç¬¬ 40 è¡Œï¼š`const { user, getToken } = useAuth()`
- ç¬¬ 104-113 è¡Œï¼šè·å– token é€»è¾‘
- ç¬¬ 121-125 è¡Œï¼šDELETE è¯·æ±‚æ·»åŠ  Authorization header
- ç¬¬ 147-150 è¡Œï¼šPOST è¯·æ±‚æ·»åŠ  Authorization header

### 2. `hooks/use-comments.ts` âœ…

**ä¿®æ”¹å†…å®¹**ï¼š
- âœ… ä» `useAuth()` è§£æ„ `getToken` å‡½æ•°
- âœ… `addComment` å‡½æ•°ï¼šPOST è¯·æ±‚æ·»åŠ  token
- âœ… `updateComment` å‡½æ•°ï¼šPUT è¯·æ±‚æ·»åŠ  token
- âœ… `deleteComment` å‡½æ•°ï¼šDELETE è¯·æ±‚æ·»åŠ  token
- âœ… `toggleCommentLike` å‡½æ•°ï¼šPOST/DELETE è¯·æ±‚æ·»åŠ  token

**ä¿®æ”¹ä½ç½®**ï¼š
- ç¬¬ 75 è¡Œï¼š`const { user, getToken } = useAuth()`
- ç¬¬ 165-174 è¡Œï¼šaddComment - è·å– token
- ç¬¬ 178-181 è¡Œï¼šaddComment - æ·»åŠ  Authorization header
- ç¬¬ 246-255 è¡Œï¼šupdateComment - è·å– token
- ç¬¬ 259-262 è¡Œï¼šupdateComment - æ·»åŠ  Authorization header
- ç¬¬ 301-310 è¡Œï¼šdeleteComment - è·å– token
- ç¬¬ 316-319 è¡Œï¼šdeleteComment - æ·»åŠ  Authorization header
- ç¬¬ 365-374 è¡Œï¼štoggleCommentLike - è·å– token
- ç¬¬ 382-385 è¡Œï¼štoggleCommentLike DELETE - æ·»åŠ  Authorization header
- ç¬¬ 402-405 è¡Œï¼štoggleCommentLike POST - æ·»åŠ  Authorization header

### 3. `app/api/likes/route.ts` âœ… (å·²ä¿®å¤)

- âœ… æ·»åŠ  `authenticateUser` å‡½æ•°
- âœ… ä»è¯·æ±‚å¤´è·å– `Authorization: Bearer <token>`
- âœ… ä½¿ç”¨ token éªŒè¯ç”¨æˆ·èº«ä»½

### 4. `app/api/comments/route.ts` âœ… (å·²ä¿®å¤)

- âœ… æ·»åŠ  `authenticateUser` å‡½æ•°
- âœ… æ‰€æœ‰éœ€è¦è®¤è¯çš„æ“ä½œéƒ½æ­£ç¡®éªŒè¯ token

### 5. `app/api/comment-likes/route.ts` âœ… (å·²ä¿®å¤)

- âœ… æ·»åŠ  `authenticateUser` å‡½æ•°
- âœ… POST/DELETE æ“ä½œæ­£ç¡®éªŒè¯ token

---

## ğŸ§ª ç°åœ¨æµ‹è¯•åŠŸèƒ½

### ä¸éœ€è¦é‡å¯æœåŠ¡å™¨ï¼

ç”±äºåªä¿®æ”¹äº†å®¢æˆ·ç«¯ä»£ç ï¼ˆhooksï¼‰ï¼ŒNext.js ä¼šè‡ªåŠ¨ Hot Reloadï¼š

1. **ä¿å­˜æ–‡ä»¶åï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨åˆ·æ–°**
2. **ç¡®ä¿å·²ç™»å½•**ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œè®¿é—® /auth ç™»å½•ï¼‰
3. **æµ‹è¯•ç‚¹èµåŠŸèƒ½**ï¼š
   - è®¿é—®ä»»æ„è¯¾ç¨‹è¯¦æƒ…é¡µ
   - ç‚¹å‡»ç‚¹èµæŒ‰é’®
   - âœ… åº”è¯¥çœ‹åˆ°"ç‚¹èµæˆåŠŸ"
   - âœ… æŒ‰é’®å˜çº¢ï¼Œç‚¹èµæ•° +1

4. **æµ‹è¯•è¯„è®ºåŠŸèƒ½**ï¼š
   - åœ¨è¯„è®ºæ¡†è¾“å…¥å†…å®¹
   - ç‚¹å‡»"å‘å¸ƒè¯„è®º"
   - âœ… åº”è¯¥çœ‹åˆ°"è¯„è®ºå‘å¸ƒæˆåŠŸ"
   - âœ… è¯„è®ºç«‹å³æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­

5. **æµ‹è¯•å…¶ä»–åŠŸèƒ½**ï¼š
   - âœ… ç¼–è¾‘è¯„è®º
   - âœ… åˆ é™¤è¯„è®º
   - âœ… ç»™è¯„è®ºç‚¹èµ
   - âœ… å›å¤è¯„è®º

---

## ğŸ“Š å¯¹æ¯”ï¼šä¿®å¤å‰ vs ä¿®å¤å

### âŒ ä¿®å¤å‰ï¼ˆuse-likes.tsï¼‰
```typescript
const response = await fetch('/api/likes', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    // âŒ ç¼ºå°‘ Authorization header
  },
  body: JSON.stringify({ item_type, item_id }),
})
```

### âœ… ä¿®å¤åï¼ˆuse-likes.tsï¼‰
```typescript
// âœ… è·å– token
const token = await getToken()
if (!token) {
  toast({ title: 'ç‚¹èµå¤±è´¥', description: 'æ— æ³•è·å–è®¿é—®ä»¤ç‰Œ' })
  return
}

const response = await fetch('/api/likes', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,  // âœ… æ·»åŠ  Authorization
  },
  body: JSON.stringify({ item_type, item_id }),
})
```

---

## ğŸ“ æŠ€æœ¯è¯´æ˜

### ä¸ºä»€ä¹ˆéœ€è¦åœ¨è¯·æ±‚å¤´ä¸­å‘é€ Tokenï¼Ÿ

åœ¨ Next.js API Routes ä¸­ï¼š

1. **æµè§ˆå™¨å­˜å‚¨ Session**
   - ç”¨æˆ·ç™»å½•åï¼ŒSupabase å°† session å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­
   - Session åŒ…å« `access_token`ï¼ˆJWT tokenï¼‰

2. **å‰ç«¯å‘é€è¯·æ±‚**
   - å‰ç«¯é€šè¿‡ `getToken()` è·å– `access_token`
   - å°† token æ”¾å…¥ `Authorization: Bearer <token>` header

3. **åç«¯éªŒè¯ Token**
   - API Route ä»è¯·æ±‚å¤´æå– token
   - ä½¿ç”¨ `supabase.auth.getUser(token)` éªŒè¯ç”¨æˆ·èº«ä»½
   - éªŒè¯æˆåŠŸåæ‰§è¡Œæ“ä½œ

### è®¤è¯æµç¨‹å›¾

```
æµè§ˆå™¨                    å‰ç«¯ Hook                 API Route
  â”‚                          â”‚                          â”‚
  â”‚  ç”¨æˆ·ç‚¹å‡»"ç‚¹èµ"              â”‚                          â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                          â”‚  è°ƒç”¨ getToken()           â”‚
  â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>Auth Context  â”‚
  â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
  â”‚                          â”‚  è¿”å› access_token         â”‚
  â”‚                          â”‚                          â”‚
  â”‚                          â”‚  å‘é€ POST è¯·æ±‚            â”‚
  â”‚                          â”‚  + Authorization header   â”‚
  â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚                          â”‚  éªŒè¯ token
  â”‚                          â”‚                          â”‚  æ‰§è¡Œæ“ä½œ
  â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                          â”‚  è¿”å›ç»“æœ (200 OK)         â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
  â”‚  æ›´æ–° UI                  â”‚                          â”‚
```

### ä¸ºä»€ä¹ˆæ”¶è—åŠŸèƒ½èƒ½æ­£å¸¸å·¥ä½œï¼Ÿ

å› ä¸º `use-favorites.ts` ä»ä¸€å¼€å§‹å°±æ­£ç¡®å®ç°äº†ï¼š

```typescript
// âœ… use-favorites.ts çš„å®ç°
const token = await getToken()
if (!token) {
  // é”™è¯¯å¤„ç†
  return false
}

const response = await fetch('/api/user/favorites', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,  // âœ… æ­£ç¡®å‘é€ token
  },
  body: JSON.stringify({ productId }),
})
```

æˆ‘ä»¬ç°åœ¨å°†ç‚¹èµå’Œè¯„è®ºåŠŸèƒ½çš„å®ç°æ”¹ä¸ºä¸æ”¶è—åŠŸèƒ½ä¸€è‡´ã€‚

---

## âœ… éªŒè¯æ¸…å•

æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ç¡®è®¤ä¿®å¤æˆåŠŸï¼š

### ç‚¹èµåŠŸèƒ½
- [ ] ç™»å½•åå¯ä»¥ç‚¹èµè¯¾ç¨‹
- [ ] ç‚¹èµæŒ‰é’®å˜çº¢è‰²
- [ ] ç‚¹èµæ•°æ­£ç¡®å¢åŠ 
- [ ] å¯ä»¥å–æ¶ˆç‚¹èµ
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ—  401 é”™è¯¯
- [ ] æœåŠ¡å™¨ç»ˆç«¯æ—  401 é”™è¯¯

### è¯„è®ºåŠŸèƒ½
- [ ] ç™»å½•åå¯ä»¥å‘å¸ƒè¯„è®º
- [ ] è¯„è®ºç«‹å³æ˜¾ç¤º
- [ ] å¯ä»¥å›å¤è¯„è®º
- [ ] å¯ä»¥ç¼–è¾‘è‡ªå·±çš„è¯„è®º
- [ ] å¯ä»¥åˆ é™¤è‡ªå·±çš„è¯„è®º
- [ ] å¯ä»¥ç»™è¯„è®ºç‚¹èµ
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ—  401 é”™è¯¯
- [ ] æœåŠ¡å™¨ç»ˆç«¯æ—  401 é”™è¯¯

### æœªç™»å½•æƒ…å†µ
- [ ] ç‚¹èµæ—¶æç¤º"è¯·å…ˆç™»å½•"
- [ ] è¯„è®ºæ—¶æç¤º"è¯·å…ˆç™»å½•"
- [ ] Toast é€šçŸ¥æ­£ç¡®æ˜¾ç¤º

---

## ğŸ‰ ä¿®å¤å®Œæˆæ€»ç»“

**ä¿®å¤å†…å®¹**ï¼š
- âœ… ä¿®å¤äº† `use-likes.ts` çš„æ‰€æœ‰è®¤è¯è¯·æ±‚
- âœ… ä¿®å¤äº† `use-comments.ts` çš„æ‰€æœ‰è®¤è¯è¯·æ±‚
- âœ… API Routes å·²ç»åœ¨ä¹‹å‰ä¿®å¤å®Œæˆ
- âœ… ç°åœ¨å‰åç«¯éƒ½æ­£ç¡®å¤„ç†è®¤è¯

**é¢„æœŸç»“æœ**ï¼š
- âœ… ç‚¹èµåŠŸèƒ½å®Œå…¨æ­£å¸¸
- âœ… è¯„è®ºåŠŸèƒ½å®Œå…¨æ­£å¸¸
- âœ… æ—  401 é”™è¯¯
- âœ… æ‰€æœ‰åŠŸèƒ½ä¸æ”¶è—åŠŸèƒ½ä¸€è‡´

**ä¸‹ä¸€æ­¥**ï¼š
1. æµè§ˆå™¨ä¼šè‡ªåŠ¨åˆ·æ–°ï¼ˆHot Reloadï¼‰
2. ç¡®ä¿å·²ç™»å½•
3. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
4. äº«å—å®Œæ•´çš„ç‚¹èµè¯„è®ºåŠŸèƒ½ï¼

---

**æ‰€æœ‰é—®é¢˜å·²å®Œå…¨è§£å†³ï¼ç°åœ¨å»æµ‹è¯•å§ï¼** ğŸš€ğŸŠ

å¦‚æœè¿˜æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘å…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚
