# ğŸ”§ ç‚¹èµè¯„è®ºåŠŸèƒ½ - å¤–é”®ä¿®å¤æŒ‡å—

## ğŸš¨ é—®é¢˜æè¿°

åœ¨æµ‹è¯•æ—¶å‡ºç° 500 é”™è¯¯ï¼š

```
Could not find a relationship between 'likes' and 'user_id' in the schema cache
Could not find a relationship between 'comments' and 'user_id' in the schema cache
```

**åŸå› **ï¼šæ•°æ®åº“å¤–é”®å¼•ç”¨äº† `auth.users` è¡¨ï¼Œä½† Supabase PostgREST åœ¨åš JOIN æŸ¥è¯¢æ—¶æ— æ³•æ‰¾åˆ°ä¸ `profiles` è¡¨çš„å…³è”ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå°†å¤–é”®æ”¹ä¸ºå¼•ç”¨ `public.profiles` è¡¨ã€‚

---

## âœ… ç«‹å³æ‰§è¡Œä¿®å¤

### æ­¥éª¤ 1ï¼šæ‰“å¼€ Supabase SQL Editor

1. ç™»å½•ä½ çš„ Supabase é¡¹ç›®
2. è¿›å…¥ **SQL Editor**
3. ç‚¹å‡» **New query**

### æ­¥éª¤ 2ï¼šæ‰§è¡Œä¿®å¤è„šæœ¬

å¤åˆ¶å¹¶ç²˜è´´ `supabase/fix-likes-comments-foreign-keys.sql` çš„å…¨éƒ¨å†…å®¹åˆ° SQL Editorï¼Œç„¶åç‚¹å‡» **Run**ã€‚

æˆ–è€…ç›´æ¥å¤åˆ¶ä»¥ä¸‹å†…å®¹æ‰§è¡Œï¼š

```sql
-- ä¿®å¤ç‚¹èµå’Œè¯„è®ºè¡¨çš„å¤–é”®å…³ç³»
BEGIN;

-- 1. ä¿®å¤ likes è¡¨çš„å¤–é”®
ALTER TABLE public.likes 
DROP CONSTRAINT IF EXISTS likes_user_id_fkey;

ALTER TABLE public.likes 
ADD CONSTRAINT likes_user_id_fkey 
FOREIGN KEY (user_id) 
REFERENCES public.profiles(id) 
ON DELETE CASCADE;

-- 2. ä¿®å¤ comments è¡¨çš„å¤–é”®
ALTER TABLE public.comments 
DROP CONSTRAINT IF EXISTS comments_user_id_fkey;

ALTER TABLE public.comments 
ADD CONSTRAINT comments_user_id_fkey 
FOREIGN KEY (user_id) 
REFERENCES public.profiles(id) 
ON DELETE CASCADE;

-- 3. ä¿®å¤ comment_likes è¡¨çš„å¤–é”®
ALTER TABLE public.comment_likes 
DROP CONSTRAINT IF EXISTS comment_likes_user_id_fkey;

ALTER TABLE public.comment_likes 
ADD CONSTRAINT comment_likes_user_id_fkey 
FOREIGN KEY (user_id) 
REFERENCES public.profiles(id) 
ON DELETE CASCADE;

COMMIT;
```

### æ­¥éª¤ 3ï¼šéªŒè¯ä¿®å¤

æ‰§è¡Œå®Œæˆåï¼Œè¿è¡Œä»¥ä¸‹æŸ¥è¯¢éªŒè¯å¤–é”®å…³ç³»ï¼š

```sql
SELECT 
  tc.table_name, 
  kcu.column_name, 
  ccu.table_name AS foreign_table_name,
  ccu.column_name AS foreign_column_name 
FROM information_schema.table_constraints AS tc 
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
  AND tc.table_schema = kcu.table_schema
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
  AND ccu.table_schema = tc.table_schema
WHERE tc.constraint_type = 'FOREIGN KEY' 
  AND tc.table_name IN ('likes', 'comments', 'comment_likes')
  AND kcu.column_name = 'user_id'
ORDER BY tc.table_name;
```

**æœŸæœ›ç»“æœ**ï¼šåº”è¯¥çœ‹åˆ° 3 è¡Œè®°å½•ï¼Œæ‰€æœ‰çš„ `foreign_table_name` éƒ½æ˜¯ `profiles`ã€‚

---

## ğŸ§ª æµ‹è¯•ä¿®å¤ç»“æœ

ä¿®å¤å®Œæˆåï¼Œåˆ·æ–°ä½ çš„å¼€å‘æœåŠ¡å™¨é¡µé¢ï¼š

1. **æµ‹è¯•æ–‡ç« ç‚¹èµ**
   - è®¿é—® http://localhost:3000/culture/[ä»»æ„æ–‡ç« ]
   - ç‚¹å‡»ç‚¹èµæŒ‰é’®
   - åº”è¯¥çœ‹åˆ°ç‚¹èµæˆåŠŸ

2. **æµ‹è¯•æ–‡ç« è¯„è®º**
   - åœ¨è¯„è®ºæ¡†è¾“å…¥å†…å®¹
   - ç‚¹å‡»å‘å¸ƒ
   - åº”è¯¥çœ‹åˆ°è¯„è®ºå‘å¸ƒæˆåŠŸ

3. **æµ‹è¯•äº§å“è¯¦æƒ…é¡µ**
   - è®¿é—® http://localhost:3000/store/[äº§å“ID]
   - æµ‹è¯•ç‚¹èµå’Œè¯„è®ºåŠŸèƒ½

4. **æµ‹è¯•è¯¾ç¨‹è¯¦æƒ…é¡µ**
   - è®¿é—® http://localhost:3000/teaching/[è¯¾ç¨‹ID]
   - æµ‹è¯•ç‚¹èµå’Œè¯„è®ºåŠŸèƒ½

---

## ğŸ“‹ æŠ€æœ¯è¯´æ˜

### ä¸ºä»€ä¹ˆè¦å¼•ç”¨ profiles è¡¨ï¼Ÿ

åœ¨ Supabase ä¸­ï¼š

1. **`auth.users`** - å­˜å‚¨åœ¨ `auth` schemaï¼ŒåŒ…å«è®¤è¯ä¿¡æ¯
2. **`public.profiles`** - å­˜å‚¨åœ¨ `public` schemaï¼ŒåŒ…å«ç”¨æˆ·èµ„æ–™

PostgREST åªèƒ½æŸ¥è¯¢ `public` schema çš„å…³ç³»ï¼Œå› æ­¤ï¼š

- âŒ `REFERENCES auth.users(id)` - PostgREST æ— æ³•æŸ¥è¯¢
- âœ… `REFERENCES public.profiles(id)` - PostgREST å¯ä»¥æŸ¥è¯¢

### profiles è¡¨çš„å¤–é”®å…³ç³»

```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users NOT NULL PRIMARY KEY,
  ...
);
```

`profiles.id` å·²ç»é€šè¿‡å¤–é”®å…³è”åˆ° `auth.users.id`ï¼Œæ‰€ä»¥ï¼š
- `likes.user_id â†’ profiles.id â†’ auth.users.id`
- æ•°æ®å®Œæ•´æ€§å¾—åˆ°ä¿è¯
- PostgREST å¯ä»¥æ­£ç¡®æŸ¥è¯¢

---

## âœ… å·²ä¿®å¤çš„æ–‡ä»¶

1. **`supabase/fix-likes-comments-foreign-keys.sql`** âœ¨ æ–°å»º
   - ä¿®å¤è„šæœ¬ï¼Œç«‹å³æ‰§è¡Œ

2. **`supabase/likes-comments-schema.sql`** âœ… å·²æ›´æ–°
   - æ›´æ–°å¤–é”®å®šä¹‰
   - æœªæ¥é‡æ–°å»ºè¡¨æ—¶å°±æ˜¯æ­£ç¡®çš„

---

## ğŸ‰ ä¿®å¤å®Œæˆ

æ‰§è¡Œä¿®å¤è„šæœ¬åï¼Œæ‰€æœ‰ API é”™è¯¯åº”è¯¥æ¶ˆå¤±ï¼Œç‚¹èµå’Œè¯„è®ºåŠŸèƒ½å°†æ­£å¸¸å·¥ä½œï¼

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œæ£€æŸ¥ï¼š
1. âœ… profiles è¡¨æ˜¯å¦å­˜åœ¨
2. âœ… ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
3. âœ… RLS ç­–ç•¥æ˜¯å¦å·²å¯ç”¨
4. âœ… ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®é…ç½®

---

**ç«‹å³æ‰§è¡Œä¿®å¤è„šæœ¬ï¼Œç„¶ååˆ·æ–°é¡µé¢æµ‹è¯•ï¼** ğŸš€
